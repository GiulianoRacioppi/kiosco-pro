<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KioscoPro - Sistema de Gesti√≥n</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .gradient-bg { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); }
        .card-hover { transition: all 0.3s ease; }
        .card-hover:hover { transform: translateY(-5px); box-shadow: 0 20px 40px rgba(0,0,0,0.1); }
        .pulse-alert { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .notification { position: fixed; top: 20px; right: 20px; z-index: 100; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 50; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .calendar-day { min-height: 80px; transition: all 0.2s; cursor: pointer; }
        .calendar-day:hover { transform: scale(1.05); z-index: 10; }
        .calendar-today { border: 2px solid #667eea; }
        .calendar-selected { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; }
        .calendar-selected p, .calendar-selected span { color: white !important; }
        .barcode-input { font-family: 'Courier New', monospace; letter-spacing: 2px; }
        .buy-day-btn { transition: all 0.2s; }
        .buy-day-btn:hover { transform: scale(1.1); }
        .buy-day-btn.active { background-color: #9333ea; color: white; border-color: #9333ea; }
        .sale-item { transition: all 0.2s; }
        .sale-item:hover { background-color: #f3f4f6; }
        
        /* Success animation */
        .success-check {
            animation: scaleIn 0.3s ease, fadeOut 0.3s ease 1.5s forwards;
        }
        @keyframes scaleIn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        @keyframes fadeOut {
            to { opacity: 0; visibility: hidden; }
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            inset: 0;
            background: rgba(255,255,255,0.9);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .loading-overlay.active {
            display: flex;
        }
        
        /* KPI Card Styles */
        .kpi-card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
        }
        .kpi-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
        }
        .kpi-purple::before { background: #8b5cf6; }
        .kpi-red::before { background: #ef4444; }
        .kpi-yellow::before { background: #f59e0b; }
        .kpi-green::before { background: #10b981; }
        
        .kpi-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        /* Sidebar compact styles */
        .sidebar-section {
            padding: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        /* Button click feedback */
        .btn-clicked {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* Expense indicator */
        .expense-badge {
            background: #fee2e2;
            color: #dc2626;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
        }
        
        /* Soft Refresh System */
        .update-flash { 
            animation: flashUpdate 0.5s ease; 
        }
        @keyframes flashUpdate { 
            0% { background-color: rgba(99, 102, 241, 0.2); } 
            100% { background-color: transparent; } 
        }

        /* Config panel in sidebar */
        .config-panel {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 12px;
            padding: 12px;
            margin: 8px;
            border: 1px solid #d1d5db;
        }
        
        .config-input {
            width: 100%;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 12px;
            margin-bottom: 8px;
        }
        
        .config-label {
            font-size: 10px;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            margin-bottom: 4px;
            display: block;
        }

        @keyframes loadBar {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        /* LAYOUT FIX - SIDEBAR FIJO + CONTENIDO CON PADDING */
        
        /* El body tiene padding para dejar espacio al sidebar */
        body {
            padding-left: 16rem !important;
            overflow-x: hidden !important;
            max-width: 100vw !important;
            margin: 0 !important;
        }
        
        /* Sidebar fijo a la izquierda */
        .sidebar-fixed {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            height: 100vh !important;
            width: 16rem !important;
            z-index: 9999 !important;
            background-color: #ffffff !important;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1) !important;
            overflow-y: auto !important;
        }
        
        /* Main content ocupa todo el ancho disponible */
        .main-content {
            width: 100% !important;
            min-height: 100vh;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        
        /* Tablas y grids no se desbordan */
        .main-content table {
            width: 100% !important;
            table-layout: fixed !important;
        }
        
        .main-content th, 
        .main-content td {
            overflow: hidden !important;
            text-overflow: ellipsis !important;
            white-space: nowrap !important;
        }
        
        .main-content .grid {
            max-width: 100% !important;
        }
        
        /* Modales por encima de todo */
        .modal {
            position: fixed !important;
            left: 0 !important;
            top: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 10000 !important;
        }
        
        /* FIX: Las secciones deben estar una encima de la otra sin superponerse */
        .section {
            position: relative !important;
            width: 100% !important;
            display: block;
        }
        
        .section.hidden {
            display: none !important;
        }
        
        /* Asegurar que el contenido no se desborde */
        .main-content > .section {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* En pantallas peque√±as, el sidebar se oculta */
        @media (max-width: 1023px) {
            .sidebar-fixed {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .sidebar-fixed.open {
                transform: translateX(0);
            }
            .main-content {
                margin-left: 0 !important;
                padding-left: 1rem !important;
                padding-right: 1rem !important;
                width: 100%;
            }
            body {
                padding-left: 0 !important;
            }
        }
        
        /* En pantallas grandes, sidebar siempre visible */
        @media (min-width: 1024px) {
            .sidebar-fixed {
                transform: translateX(0) !important;
            }
            #mobile-overlay {
                display: none !important;
            }
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* Firefox Scrollbar */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #c1c1c1 #f1f1f1;
        }
    </style>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyBqYqLew5sf41zrQGr_GLm8d22hanNtWvg",
            authDomain: "kioscopro.firebaseapp.com",
            projectId: "kioscopro",
            storageBucket: "kioscopro.firebasestorage.app",
            messagingSenderId: "334703637356",
            appId: "1:334703637356:web:cfd74b2143e56f09903949",
            measurementId: "G-6QX394HCSR"
        };
        
        window.firebaseApp = initializeApp(firebaseConfig);
        
        // Configurar Firestore con persistencia offline (nueva API)
        const dbSettings = {
            cacheSizeBytes: 10485760, // 10MB
            experimentalForceLongPolling: false
        };
        
        window.db = getFirestore(window.firebaseApp);
        
        // Configurar persistencia mediante localStorage (fallback simple)
        // La nueva API de Firestore maneja cach√© autom√°ticamente
        console.log('Firebase inicializado correctamente');
    </script>
</head>
<body class="text-gray-800">

    <div id="notifications"></div>

    <!-- Loading/Success Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="text-center">
            <div class="success-check mb-4">
                <i class="fas fa-check-circle text-6xl text-green-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-gray-800 mb-2">¬°Venta Finalizada!</h2>
            <p class="text-gray-600" id="success-amount">Total: $0</p>
            <div class="mt-4 w-16 h-1 bg-gray-200 rounded-full overflow-hidden mx-auto">
                <div class="h-full bg-green-500 rounded-full" style="animation: loadBar 1.5s ease-out forwards;"></div>
            </div>
        </div>
    </div>

    <!-- Add Stock Modal -->
    <div id="add-stock-modal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto custom-scrollbar">
            <h3 class="text-xl font-bold mb-4 text-purple-600"><i class="fas fa-box-open"></i> Agregar Stock</h3>
            <div id="add-stock-product-info" class="mb-4 p-3 bg-gray-50 rounded-lg"></div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Cantidad a agregar</label>
                    <input type="number" id="add-stock-qty" class="w-full border-2 border-purple-200 rounded-xl px-4 py-3 text-xl font-bold text-center" value="1" min="1" required oninput="updateAddStockCost()" onkeypress="handleAddStockKeypress(event)">
                </div>
                <div class="p-3 bg-blue-50 rounded-lg">
                    <p class="text-sm text-gray-600">Costo total:</p>
                    <p class="text-2xl font-bold text-blue-800" id="add-stock-total-cost">$0</p>
                </div>
                <div class="p-4 bg-orange-50 border-2 border-orange-200 rounded-xl">
                    <label class="block text-sm font-bold text-orange-800 mb-2">
                        <i class="fas fa-tag mr-1"></i> Nuevo Precio de Venta (Opcional)
                    </label>
                    <div class="flex items-center gap-2">
                        <span class="text-orange-600 font-bold">$</span>
                        <input type="number" id="add-stock-new-price" class="flex-1 border-2 border-orange-300 rounded-lg px-3 py-2 font-bold text-lg" 
                            placeholder="Precio actual" step="0.01" onkeypress="handleAddStockKeypress(event)">
                    </div>
                    <p class="text-xs text-orange-600 mt-1">
                        <i class="fas fa-info-circle"></i> 
                        Dej√° vac√≠o para mantener el precio actual. Us√° esto para ajustar por inflaci√≥n.
                    </p>
                    <div class="mt-2 flex justify-between text-sm">
                        <span class="text-gray-600">Precio actual:</span>
                        <span class="font-bold text-orange-700" id="add-stock-current-price">$0</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Pagar con:</label>
                    <div class="flex gap-2">
                        <button onclick="setAddStockPayment('cash')" id="btn-addstock-cash" class="flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold text-sm">
                            üíµ Caja ($<span id="addstock-cash-available">0</span>)
                        </button>
                        <button onclick="setAddStockPayment('account')" id="btn-addstock-account" class="flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm">
                            üè¶ Cuenta ($<span id="addstock-account-available">0</span>)
                        </button>
                    </div>
                </div>
                <div class="p-4 bg-yellow-50 border-2 border-yellow-300 rounded-xl">
                    <label class="block text-sm font-bold text-yellow-800 mb-2">
                        <i class="fas fa-calendar-alt mr-1"></i> Fecha de Vencimiento del Nuevo Stock
                    </label>
                    <input type="date" id="add-stock-expiry" class="w-full border-2 border-yellow-300 rounded-lg px-3 py-2 font-bold text-lg" onkeypress="handleAddStockKeypress(event)">
                    <p class="text-xs text-yellow-600 mt-1">
                        <i class="fas fa-info-circle"></i> 
                        Importante: Si es producto nuevo o el vencimiento cambi√≥, actualiz√° la fecha.
                    </p>
                </div>
                <div class="flex gap-2">
                    <button onclick="closeAddStockModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold">Cancelar</button>
                    <button onclick="executeAddStock()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-purple-700">Agregar Stock</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="edit-product-modal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 text-purple-600"><i class="fas fa-edit"></i> Editar Producto</h3>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Nombre</label>
                    <input type="text" id="edit-prod-name" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">C√≥digo de barras</label>
                    <input type="text" id="edit-prod-barcode" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Costo</label>
                        <input type="number" id="edit-prod-cost" class="w-full border rounded-lg px-3 py-2" step="0.01" oninput="calculateEditPrice()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Precio de venta</label>
                        <input type="number" id="edit-prod-price" class="w-full border rounded-lg px-3 py-2" step="0.01" oninput="calculateEditMargin()">
                    </div>
                </div>
                <div class="p-3 bg-purple-50 rounded-lg">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Margen de ganancia</label>
                    <div class="flex items-center gap-2">
                        <input type="number" id="edit-prod-margin" class="flex-1 border rounded-lg px-3 py-2 text-center font-bold text-purple-700" step="0.1" oninput="calculateEditPriceFromMargin()">
                        <span class="text-purple-600 font-bold">%</span>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Cambi√° el margen para recalcular el precio</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Stock</label>
                    <input type="number" id="edit-prod-stock" class="w-full border rounded-lg px-3 py-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Categor√≠a</label>
                    <select id="edit-prod-category" class="w-full border rounded-lg px-3 py-2">
                        <option value="snacks">Snacks</option>
                        <option value="bebidas">Bebidas</option>
                        <option value="basicos">B√°sicos</option>
                        <option value="limpieza">Limpieza</option>
                        <option value="combos">Combos</option>
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Vencimiento</label>
                        <input type="date" id="edit-prod-expiry" class="w-full border rounded-lg px-3 py-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Stock M√≠nimo</label>
                        <input type="number" id="edit-prod-min" class="w-full border rounded-lg px-3 py-2" min="0">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Proveedor</label>
                    <input type="text" id="edit-prod-supplier" class="w-full border rounded-lg px-3 py-2" placeholder="Nombre del proveedor">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">üìÖ D√≠as de Compra del Proveedor</label>
                    <div class="flex gap-1 flex-wrap" id="edit-prod-buy-days">
                        <button type="button" onclick="toggleBuyDay('edit', 1)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="1">Lun</button>
                        <button type="button" onclick="toggleBuyDay('edit', 2)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="2">Mar</button>
                        <button type="button" onclick="toggleBuyDay('edit', 3)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="3">Mi√©</button>
                        <button type="button" onclick="toggleBuyDay('edit', 4)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="4">Jue</button>
                        <button type="button" onclick="toggleBuyDay('edit', 5)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="5">Vie</button>
                        <button type="button" onclick="toggleBuyDay('edit', 6)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="6">S√°b</button>
                        <button type="button" onclick="toggleBuyDay('edit', 0)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="0">Dom</button>
                    </div>
                    <p class="text-xs text-gray-500 mt-1">Seleccion√° los d√≠as que el proveedor pasa</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">WhatsApp Proveedor</label>
                    <input type="text" id="edit-prod-supplier-phone" class="w-full border rounded-lg px-3 py-2" placeholder="5491123456789">
                </div>
                <div class="flex gap-2">
                    <button onclick="closeEditProductModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold">Cancelar</button>
                    <button onclick="saveProductEdit()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-purple-700">Guardar Cambios</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Move Money Modal -->
    <div id="move-money-modal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-purple-600"><i class="fas fa-exchange-alt"></i> Mover Dinero</h3>
            <div class="flex gap-2 mb-4">
                <button onclick="setMoveDirection('to_bank')" id="btn-to-bank" class="flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm">
                    <i class="fas fa-arrow-right"></i> Caja ‚Üí Cuenta
                </button>
                <button onclick="setMoveDirection('to_cash')" id="btn-to-cash" class="flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm">
                    <i class="fas fa-arrow-left"></i> Cuenta ‚Üí Caja
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Monto</label>
                    <input type="number" id="move-amount" class="w-full border-2 border-purple-200 rounded-xl px-4 py-3 text-xl font-bold text-center" placeholder="0" min="0" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Concepto</label>
                    <input type="text" id="move-concept" class="w-full border rounded-lg px-3 py-2" placeholder="Ej: Dep√≥sito diario">
                </div>
                <div class="flex gap-2">
                    <button onclick="closeMoveModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold">Cancelar</button>
                    <button onclick="executeMoveMoney()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-purple-700">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjust Money Modal -->
    <div id="adjust-money-modal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-purple-600" id="adjust-title">Agregar/Retirar Dinero</h3>
            <div class="mb-4 p-4 bg-gray-50 rounded-lg">
                <p class="text-sm text-gray-600">Caja actual: <span class="font-bold" id="adjust-cash-current">$0</span></p>
                <p class="text-sm text-gray-600">Cuenta actual: <span class="font-bold" id="adjust-bank-current">$0</span></p>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="setAdjustTarget('cash')" id="btn-adjust-cash" class="flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold text-sm">
                    üíµ Caja
                </button>
                <button onclick="setAdjustTarget('bank')" id="btn-adjust-bank" class="flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm">
                    üè¶ Cuenta
                </button>
            </div>
            <div class="flex gap-2 mb-4">
                <button onclick="setAdjustType('add')" id="btn-adjust-add" class="flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold text-sm">
                    <i class="fas fa-plus"></i> Agregar
                </button>
                <button onclick="setAdjustType('remove')" id="btn-adjust-remove" class="flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm">
                    <i class="fas fa-minus"></i> Retirar
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Monto</label>
                    <input type="number" id="adjust-amount" class="w-full border-2 border-purple-200 rounded-xl px-4 py-3 text-xl font-bold text-center" placeholder="0" min="0" step="0.01">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Concepto (opcional)</label>
                    <input type="text" id="adjust-concept" class="w-full border rounded-lg px-3 py-2" placeholder="Ej: Ingreso extra, Pago proveedor, etc.">
                </div>
                <div class="flex gap-2">
                    <button onclick="closeAdjustModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold">Cancelar</button>
                    <button onclick="executeAdjustMoney()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-purple-700">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Purchase Payment Modal -->
    <div id="purchase-payment-modal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold mb-4 text-purple-600"><i class="fas fa-shopping-cart"></i> Pago de Compra</h3>
            <div class="mb-4 p-4 bg-purple-50 rounded-lg">
                <p class="text-sm text-gray-600">Total a pagar:</p>
                <p class="text-3xl font-bold text-purple-800" id="purchase-total-amount">$0</p>
            </div>
            <div class="space-y-3 mb-6">
                <button onclick="setPurchasePayment('cash')" id="btn-purchase-cash" class="w-full p-4 rounded-xl border-2 border-green-500 bg-green-50 text-left flex items-center gap-3 transition">
                    <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div>
                        <p class="font-bold text-gray-800">Pagar con Caja (Efectivo)</p>
                        <p class="text-sm text-gray-500">Disponible: <span id="purchase-cash-available">$0</span></p>
                    </div>
                </button>
                <button onclick="setPurchasePayment('account')" id="btn-purchase-account" class="w-full p-4 rounded-xl border-2 border-gray-200 hover:border-blue-400 text-left flex items-center gap-3 transition">
                    <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white">
                        <i class="fas fa-university"></i>
                    </div>
                    <div>
                        <p class="font-bold text-gray-800">Pagar con Cuenta</p>
                        <p class="text-sm text-gray-500">Disponible: <span id="purchase-account-available">$0</span></p>
                    </div>
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="closePurchaseModal()" class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-xl font-bold">Cancelar</button>
                <button onclick="confirmPurchase()" class="flex-1 bg-purple-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-purple-700">Confirmar Compra</button>
            </div>
        </div>
    </div>

    <!-- Sale Detail Modal -->
    <div id="sale-detail-modal" class="modal">
        <div class="bg-white rounded-2xl p-6 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-purple-600"><i class="fas fa-receipt"></i> Detalle de Venta</h3>
                <button onclick="closeSaleDetail()" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="sale-detail-content"></div>
        </div>
    </div>

    <!-- Sidebar -->
    <div id="mobile-sidebar" class="sidebar-fixed fixed left-0 top-0 h-full w-64 bg-white shadow-2xl z-50 flex flex-col">
        <!-- Bot√≥n cerrar (solo m√≥vil) -->
        <button onclick="toggleMobileSidebar()" class="lg:hidden absolute top-4 right-4 p-2 text-gray-500 hover:text-gray-700">
            <i class="fas fa-times text-xl"></i>
        </button>
        <div class="p-4 gradient-bg text-white flex-shrink-0">
            <div class="flex items-center justify-between">
                <h1 class="text-xl font-bold flex items-center gap-2"><i class="fas fa-store"></i> KioscoPro</h1>
                <button id="sync-status-indicator" onclick="forceSync()" class="text-sm p-1 rounded hover:bg-white/20 transition" title="Sincronizaci√≥n">
                    <i class="fas fa-cloud-slash text-white/70"></i>
                </button>
            </div>
            <p class="text-xs opacity-80 mt-1">Gesti√≥n Inteligente</p>
        </div>
        
        <div class="px-3 py-2 bg-indigo-50 border-b border-indigo-100 flex-shrink-0">
            <div class="flex items-center justify-between mb-1">
                <button onclick="changeDate(-1)" class="bg-white text-indigo-600 w-6 h-6 rounded-lg shadow-sm hover:shadow flex items-center justify-center text-xs">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="text-center">
                    <p class="text-[10px] text-indigo-600 font-semibold uppercase">Fecha de trabajo</p>
                    <span id="active-date-display" class="font-bold text-indigo-800 text-xs">Hoy</span>
                </div>
                <button onclick="changeDate(1)" class="bg-white text-indigo-600 w-6 h-6 rounded-lg shadow-sm hover:shadow flex items-center justify-center text-xs">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
            <button onclick="resetToToday()" class="w-full text-[10px] text-indigo-600 hover:text-indigo-800 underline hidden" id="btn-back-today">
                ‚Üê Volver a hoy
            </button>
        </div>

        <nav class="flex-1 p-2 space-y-1 overflow-y-auto">
            <button onclick="showSection('dashboard')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-purple-700 font-medium bg-purple-50 text-sm" data-section="dashboard">
                <i class="fas fa-chart-line w-4 text-xs"></i> Dashboard
            </button>
            <button onclick="showSection('sell')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 text-sm" data-section="sell">
                <i class="fas fa-cash-register w-4 text-xs"></i> Vender
                <span class="ml-auto bg-green-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center hidden text-[10px]" id="cart-badge">0</span>
            </button>
            <button onclick="showSection('sales-calendar')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 text-sm" data-section="sales-calendar">
                <i class="fas fa-calendar-alt w-4 text-xs"></i> Historial
            </button>
            <button onclick="showSection('inventory')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 text-sm" data-section="inventory">
                <i class="fas fa-boxes w-4 text-xs"></i> Inventario
            </button>
            <button onclick="showSection('cashflow')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 text-sm" data-section="cashflow">
                <i class="fas fa-wallet w-4 text-xs"></i> Finanzas
            </button>
            <button onclick="showSection('predictions')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 text-sm" data-section="predictions">
                <i class="fas fa-boxes w-4 text-xs"></i> Control de Stock
            </button>
            <button onclick="showSection('alerts')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 relative text-sm" data-section="alerts">
                <i class="fas fa-bell w-4 text-xs"></i> Alertas
                <span id="alert-badge" class="absolute right-2 bg-red-500 text-white text-xs rounded-full w-4 h-4 flex items-center justify-center pulse-alert hidden text-[10px]">0</span>
            </button>
            <button onclick="showSection('reports')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 text-sm" data-section="reports">
                <i class="fas fa-file-export w-4 text-xs"></i> Reportes
            </button>
            <button onclick="showSection('settings')" class="nav-btn w-full text-left px-3 py-2 rounded-xl hover:bg-purple-50 transition flex items-center gap-2 text-gray-600 text-sm" data-section="settings">
                <i class="fas fa-cog w-4 text-xs"></i> Configuraci√≥n
            </button>
            

        </nav>

        <!-- Compact Financial Panel -->
        <div class="p-3 border-t bg-white flex-shrink-0 space-y-2">
            <div class="bg-gray-50 rounded-lg p-2 cursor-pointer hover:bg-purple-50" onclick="showSection('cashflow')">
                <div class="flex justify-between items-center mb-0.5">
                    <span class="text-xs text-gray-500 font-medium">üíµ Caja</span>
                    <button onclick="event.stopPropagation(); openAdjustModal('cash')" class="text-xs text-blue-600 hover:text-blue-800" title="Agregar/Retirar">
                        <i class="fas fa-plus-minus"></i>
                    </button>
                </div>
                <p class="text-base font-bold text-gray-800" id="liquidity-amount">$0</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-2 cursor-pointer hover:bg-blue-50" onclick="showSection('cashflow')">
                <div class="flex justify-between items-center mb-0.5">
                    <span class="text-xs text-gray-500 font-medium">üè¶ Cuenta</span>
                    <button onclick="event.stopPropagation(); openAdjustModal('bank')" class="text-xs text-blue-600 hover:text-blue-800" title="Agregar/Retirar">
                        <i class="fas fa-plus-minus"></i>
                    </button>
                </div>
                <p class="text-base font-bold text-blue-700" id="bank-amount">$0</p>
            </div>
            
            <div class="bg-gray-50 rounded-lg p-2 cursor-pointer hover:bg-green-50" onclick="showSection('inventory')">
                <div class="flex justify-between items-center mb-0.5">
                    <span class="text-xs text-gray-500 font-medium">üì¶ Mercader√≠a</span>
                </div>
                <p class="text-xs font-bold text-green-700" id="inventory-cost-amount">$0 costo</p>
                <p class="text-xs font-bold text-green-600" id="inventory-sale-amount">$0 venta</p>
            </div>

            <div class="bg-gradient-to-r from-purple-500 to-pink-500 rounded-lg p-2 text-white text-center cursor-pointer" onclick="showSection('cashflow')">
                <p class="text-xs opacity-90">Ventas hoy</p>
                <p class="text-lg font-bold" id="sidebar-balance">$0</p>
            </div>
            
            <div class="flex gap-1">
                <button onclick="backupData()" class="flex-1 bg-blue-500 text-white text-xs py-1.5 rounded hover:bg-blue-600">
                    <i class="fas fa-download"></i>
                </button>
                <button onclick="document.getElementById('restore-file').click()" class="flex-1 bg-green-500 text-white text-xs py-1.5 rounded hover:bg-green-600">
                    <i class="fas fa-upload"></i>
                </button>
            </div>
            <input type="file" id="restore-file" class="hidden" accept=".json" onchange="restoreData(this)">
        </div>
    </div>

    <!-- Overlay para cerrar men√∫ en m√≥vil -->
    <div id="mobile-overlay" onclick="toggleMobileSidebar()" class="fixed inset-0 bg-black/50 z-40 hidden lg:hidden"></div>

    <!-- Main Content -->
    <div class="main-content p-8">
        
        <!-- Header -->
        <div class="flex justify-between items-center mb-8 fade-in">
            <div class="flex items-center gap-3">
                <!-- Bot√≥n men√∫ hamburguesa (solo m√≥vil) -->
                <button onclick="toggleMobileSidebar()" class="lg:hidden p-2 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700">
                    <i class="fas fa-bars text-xl"></i>
                </button>
                <div>
                    <h2 class="text-2xl lg:text-3xl font-bold text-gray-800" id="page-title">Dashboard</h2>
                    <p class="text-gray-500 mt-1 text-sm lg:text-base" id="current-date-display"></p>
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="quickSell()" id="btn-quick-sell" class="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition flex items-center gap-2">
                    <i class="fas fa-plus"></i> Nueva Venta
                </button>
                <button onclick="showSection('inventory')" class="bg-blue-500 hover:bg-blue-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition flex items-center gap-2">
                    <i class="fas fa-shopping-cart"></i> Compra Stock
                </button>
                <button onclick="openExpenseModal()" class="bg-red-500 hover:bg-red-600 text-white px-6 py-3 rounded-xl font-semibold shadow-lg transition flex items-center gap-2">
                    <i class="fas fa-minus"></i> Gasto
                </button>
            </div>
        </div>

        <!-- Dashboard -->
        <div id="dashboard" class="section space-y-6 fade-in">
            
            <!-- Smart Alerts Section -->
            <div id="dashboard-alerts" class="space-y-3">
                <!-- Se llena con alertas inteligentes via JS -->
            </div>
            
            <!-- KPI Cards Row -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-kpis">
                <!-- Se llena con JS -->
            </div>
            
            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-chart-bar text-purple-600"></i> Ventas por Categor√≠a (√öltimos 7 d√≠as)
                    </h3>
                    <canvas id="salesChart" height="250"></canvas>
                </div>
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i class="fas fa-brain text-blue-600"></i> Predicci√≥n de Demanda (Pr√≥ximos 7 d√≠as)
                    </h3>
                    <canvas id="predictionChart" height="250"></canvas>
                </div>
            </div>

            <!-- Today's Sales -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-shopping-cart text-purple-600"></i> 
                        Ventas del D√≠a
                        <span class="text-sm font-normal text-gray-500" id="today-sales-count">(0 ventas)</span>
                    </h3>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Total vendido</p>
                        <p class="text-2xl font-bold text-green-600" id="today-total-sales">$0</p>
                    </div>
                </div>
                <div id="today-sales-list" class="space-y-2 max-h-96 overflow-y-auto">
                    <p class="text-center text-gray-400 py-8">No hay ventas hoy</p>
                </div>
            </div>
        </div>

        <!-- Sell Section -->
        <div id="sell" class="section hidden space-y-6 fade-in">
            <!-- Alertas en secci√≥n Ventas -->
            <div id="sell-alerts" class="space-y-3"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-4">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                            <i class="fas fa-barcode text-purple-600"></i> 
                            Buscar Producto
                        </h3>
                        <div class="relative mb-4">
                            <i class="fas fa-search absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-400 text-xl"></i>
                            <input type="text" id="sell-search-input" placeholder="Escribe nombre o escanea c√≥digo..." 
                                class="w-full pl-12 pr-4 py-4 text-lg border-2 border-purple-200 rounded-xl focus:border-purple-500 focus:outline-none"
                                oninput="handleSellSearch()"
                                onkeypress="handleSellSearchKeypress(event)">
                        </div>
                        <div id="sell-search-results" class="space-y-2 max-h-48 overflow-y-auto hidden mb-4"></div>
                        <div id="last-added" class="hidden p-3 bg-green-50 border border-green-200 rounded-lg flex items-center gap-3">
                            <i class="fas fa-check-circle text-green-500 text-xl"></i>
                            <div>
                                <p class="text-sm text-green-600 font-semibold">Agregado autom√°ticamente</p>
                                <p class="font-bold text-gray-800" id="last-added-text"></p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-2xl shadow-lg p-6" id="cart-container">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold flex items-center gap-2">
                                <i class="fas fa-shopping-cart text-purple-600"></i> 
                                Carrito <span class="text-sm font-normal text-gray-500" id="cart-count">(0 items)</span>
                            </h3>
                            <button onclick="clearCart()" class="text-red-500 hover:text-red-700 text-sm">
                                <i class="fas fa-trash"></i> Vaciar
                            </button>
                        </div>
                        <div id="cart-items" class="space-y-2 max-h-64 overflow-y-auto mb-4">
                            <p class="text-center text-gray-400 py-8">Escanea productos para agregar al carrito</p>
                        </div>
                        <div class="border-t pt-4">
                            <div class="flex justify-between text-lg mb-2">
                                <span>Subtotal:</span>
                                <span class="font-bold" id="cart-subtotal">$0</span>
                            </div>
                            <div class="flex justify-between text-xl font-bold text-purple-600 mb-4">
                                <span>TOTAL:</span>
                                <span id="cart-total">$0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="space-y-4">
                    <div class="bg-white rounded-2xl shadow-lg p-6">
                        <h3 class="text-lg font-bold mb-4"><i class="fas fa-credit-card text-purple-600"></i> Pago</h3>
                        <div class="space-y-3 mb-6">
                            <button onclick="setPaymentMethod('cash')" id="btn-cash" class="w-full p-4 rounded-xl border-2 border-green-500 bg-green-50 text-left flex items-center gap-3 transition">
                                <div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white">
                                    <i class="fas fa-money-bill-wave"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800">Efectivo</p>
                                    <p class="text-sm text-gray-500">Calcular vuelto</p>
                                </div>
                            </button>
                            <button onclick="setPaymentMethod('debit')" id="btn-debit" class="w-full p-4 rounded-xl border-2 border-gray-200 hover:border-blue-400 text-left flex items-center gap-3 transition">
                                <div class="w-10 h-10 bg-blue-500 rounded-full flex items-center justify-center text-white">
                                    <i class="fas fa-credit-card"></i>
                                </div>
                                <div>
                                    <p class="font-bold text-gray-800">D√©bito</p>
                                    <p class="text-sm text-gray-500">Transferencia/Tarjeta</p>
                                </div>
                            </button>
                        </div>

                        <div id="cash-details" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Monto recibido</label>
                                <input type="number" id="cash-received" class="w-full border-2 border-green-300 rounded-xl px-4 py-3 text-lg font-bold" 
                                    placeholder="0" oninput="calculateChange()">
                            </div>
                            <div class="p-4 bg-green-100 rounded-xl">
                                <p class="text-sm text-green-700 mb-1">Vuelto:</p>
                                <p class="text-3xl font-bold text-green-800" id="change-amount">$0</p>
                            </div>
                        </div>

                        <button onclick="completeSale()" id="btn-complete" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-bold text-lg shadow-lg mt-4 transition disabled:opacity-50" disabled>
                            <i class="fas fa-check-circle"></i> Finalizar Venta
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sales Calendar -->
        <div id="sales-calendar" class="section hidden space-y-6 fade-in">
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Historial de Ventas y Gastos</h3>
                    <div class="flex gap-2 items-center">
                        <button onclick="changeCalendarMonth(-1)" class="p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        <span id="calendar-month-year" class="font-bold text-lg min-w-[150px] text-center capitalize"></span>
                        <button onclick="changeCalendarMonth(1)" class="p-2 rounded-lg hover:bg-gray-100">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-7 gap-2 mb-2">
                    <div class="text-center text-xs font-bold text-gray-500 py-2">Dom</div>
                    <div class="text-center text-xs font-bold text-gray-500 py-2">Lun</div>
                    <div class="text-center text-xs font-bold text-gray-500 py-2">Mar</div>
                    <div class="text-center text-xs font-bold text-gray-500 py-2">Mi√©</div>
                    <div class="text-center text-xs font-bold text-gray-500 py-2">Jue</div>
                    <div class="text-center text-xs font-bold text-gray-500 py-2">Vie</div>
                    <div class="text-center text-xs font-bold text-gray-500 py-2">S√°b</div>
                </div>
                <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
            </div>
            
            <div id="day-detail" class="bg-white rounded-2xl shadow-lg p-6 hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-purple-600" id="day-detail-title"></h3>
                    <div class="text-right">
                        <p class="text-sm text-gray-500">Balance del d√≠a</p>
                        <p class="text-2xl font-bold" id="day-detail-total">$0</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-6">
                    <div class="bg-purple-50 rounded-xl p-4">
                        <p class="text-xs text-purple-600 font-bold uppercase">Ventas</p>
                        <p class="text-2xl font-bold text-purple-800" id="day-metric-sales">0</p>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4">
                        <p class="text-xs text-green-600 font-bold uppercase">Ingresos</p>
                        <p class="text-2xl font-bold text-green-800" id="day-metric-income">$0</p>
                    </div>
                    <div class="bg-red-50 rounded-xl p-4">
                        <p class="text-xs text-red-600 font-bold uppercase">Gastos</p>
                        <p class="text-2xl font-bold text-red-800" id="day-metric-expenses">$0</p>
                    </div>
                    <div class="bg-blue-50 rounded-xl p-4">
                        <p class="text-xs text-blue-600 font-bold uppercase">Inversi√≥n</p>
                        <p class="text-2xl font-bold text-blue-800" id="day-metric-investments">$0</p>
                    </div>
                    <div class="bg-indigo-50 rounded-xl p-4">
                        <p class="text-xs text-indigo-600 font-bold uppercase">Items</p>
                        <p class="text-2xl font-bold text-indigo-800" id="day-metric-items">0</p>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-4">
                        <p class="text-xs text-orange-600 font-bold uppercase">Balance</p>
                        <p class="text-2xl font-bold text-orange-800" id="day-metric-balance">$0</p>
                    </div>
                </div>
                
                <!-- Tabs for Sales, Expenses and Investments -->
                <div class="flex gap-2 mb-4 border-b">
                    <button onclick="showDayTab('sales')" id="tab-sales" class="px-4 py-2 font-bold text-purple-600 border-b-2 border-purple-600">
                        <i class="fas fa-shopping-cart"></i> Ventas
                    </button>
                    <button onclick="showDayTab('expenses')" id="tab-expenses" class="px-4 py-2 font-bold text-gray-500">
                        <i class="fas fa-receipt"></i> Gastos <span id="day-expense-count" class="bg-red-500 text-white text-xs rounded-full px-2 py-0.5 ml-1">0</span>
                    </button>
                    <button onclick="showDayTab('investments')" id="tab-investments" class="px-4 py-2 font-bold text-gray-500">
                        <i class="fas fa-boxes"></i> Inversiones <span id="day-investment-count" class="bg-blue-500 text-white text-xs rounded-full px-2 py-0.5 ml-1">0</span>
                    </button>
                </div>
                
                <div id="day-sales-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                <div id="day-expenses-list" class="space-y-2 max-h-96 overflow-y-auto hidden"></div>
                <div id="day-investments-list" class="space-y-2 max-h-96 overflow-y-auto hidden"></div>
            </div>
        </div>

        <!-- Inventory -->
        <div id="inventory" class="section hidden space-y-6 fade-in">
            <!-- Quick Add Stock Section -->
            <div class="bg-gradient-to-r from-blue-50 to-purple-50 rounded-2xl shadow-lg p-6 border-2 border-blue-200">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-blue-800">
                    <i class="fas fa-plus-circle text-blue-600"></i> 
                    Agregar Stock R√°pido
                </h3>
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <i class="fas fa-search mr-1"></i> Buscar por nombre o escanear c√≥digo
                    </label>
                    <input type="text" id="quick-stock-search" class="barcode-input w-full border-2 border-blue-300 rounded-lg px-4 py-3 text-lg" 
                           placeholder="Escribe el nombre o escanea el c√≥digo de barras..." 
                           oninput="filterQuickStockProducts()"
                           onkeypress="handleQuickStockKeypress(event)">
                    <p class="text-xs text-gray-500 mt-1">üí° Escribe para buscar por nombre, o escanea para ir directo al producto</p>
                </div>
                <div id="quick-stock-results" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-64 overflow-y-auto">
                    <p class="text-gray-400 text-center py-4 col-span-3">Escribe para buscar productos</p>
                </div>
            </div>

            <!-- Add New Product Form -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-box text-green-600"></i> Agregar Nuevo Producto (Compra)
                </h3>
                <form id="add-inventory-form" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" onsubmit="event.preventDefault(); preparePurchase();">
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">C√≥digo de barras</label>
                        <input type="text" id="inv-barcode" class="barcode-input w-full border rounded-lg px-3 py-2 text-sm" placeholder="Escanea..." required>
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Nombre del producto</label>
                        <input type="text" id="inv-name" class="w-full border rounded-lg px-3 py-2 text-sm" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Categor√≠a</label>
                        <select id="inv-category" class="w-full border rounded-lg px-3 py-2 text-sm">
                            <option value="snacks">Snacks</option>
                            <option value="bebidas">Bebidas</option>
                            <option value="basicos">B√°sicos</option>
                            <option value="limpieza">Limpieza</option>
                            <option value="combos">Combos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Proveedor</label>
                        <input type="text" id="inv-supplier" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Nombre">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">WhatsApp proveedor</label>
                        <input type="text" id="inv-supplier-phone" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="5491123456789">
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">üìÖ D√≠as de compra (proveedor pasa)</label>
                        <div class="flex gap-1 flex-wrap" id="inv-buy-days">
                            <button type="button" onclick="toggleBuyDay('inv', 1)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="1">Lun</button>
                            <button type="button" onclick="toggleBuyDay('inv', 2)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="2">Mar</button>
                            <button type="button" onclick="toggleBuyDay('inv', 3)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="3">Mi√©</button>
                            <button type="button" onclick="toggleBuyDay('inv', 4)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="4">Jue</button>
                            <button type="button" onclick="toggleBuyDay('inv', 5)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="5">Vie</button>
                            <button type="button" onclick="toggleBuyDay('inv', 6)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="6">S√°b</button>
                            <button type="button" onclick="toggleBuyDay('inv', 0)" class="buy-day-btn px-2 py-1 text-xs rounded border border-gray-300 hover:bg-purple-100" data-day="0">Dom</button>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Costo unitario</label>
                        <input type="number" id="inv-cost" class="w-full border rounded-lg px-3 py-2 text-sm" step="0.01" required oninput="calculateInventoryPrice()">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Stock inicial</label>
                        <input type="number" id="inv-stock" class="w-full border rounded-lg px-3 py-2 text-sm" min="1" required>
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-600 mb-1">Vencimiento</label>
                        <input type="date" id="inv-expiry" class="w-full border rounded-lg px-3 py-2 text-sm" required>
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Margen de ganancia (%)</label>
                        <input type="number" id="inv-margin" class="w-full border-2 border-purple-300 rounded-lg px-3 py-2 text-sm font-bold text-purple-700" step="0.1" value="30" oninput="calculateInventoryPriceFromMargin()">
                        <p class="text-xs text-gray-500 mt-1">Cambi√° el margen para recalcular el precio</p>
                    </div>
                    <div class="lg:col-span-2">
                        <label class="block text-xs font-medium text-gray-600 mb-1">Precio de venta</label>
                        <input type="number" id="inv-price" class="w-full border-2 border-purple-300 rounded-lg px-3 py-2 text-sm font-bold text-green-700 bg-green-50" step="0.01" oninput="calculateInventoryMargin()">
                        <p class="text-xs text-gray-500 mt-1">Margen actual: <span id="inv-margin-display" class="font-bold text-purple-600">30%</span></p>
                    </div>
                    <div class="lg:col-span-2 flex items-end">
                        <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-bold shadow">
                            <i class="fas fa-plus"></i> Crear y Comprar Producto
                        </button>
                    </div>
                </form>
            </div>

            <!-- Inventory List -->
            <div class="bg-white rounded-2xl shadow-lg overflow-hidden">
                <div class="p-4 border-b flex justify-between items-center">
                    <h3 class="font-bold">Stock Actual</h3>
                    <input type="text" id="search-inventory" placeholder="Buscar..." class="border rounded-lg px-3 py-1 text-sm" onkeyup="renderInventory()">
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Producto</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">C√≥digo</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Stock Total</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Lotes/Vencimientos</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Costo</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Venta</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventory-table" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Cashflow -->
        <!-- CASHFLOW - Gesti√≥n de Caja Simplificada -->
        <div id="cashflow" class="section hidden space-y-6 fade-in">
            <!-- Tarjetas Principales: Caja y Cuenta -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-2xl p-6 text-white shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-green-100 text-sm font-semibold uppercase">üíµ Dinero en Caja</p>
                            <p class="text-4xl font-bold mt-1" id="cashflow-cash">$0</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="openAdjustModal('cash')" class="bg-white text-green-600 px-3 py-2 rounded-lg font-bold hover:bg-green-50 text-sm">
                                <i class="fas fa-plus-minus"></i>
                            </button>
                            <button onclick="openMoveMoneyModal()" class="bg-white text-green-600 px-3 py-2 rounded-lg font-bold hover:bg-green-50 text-sm">
                                <i class="fas fa-exchange-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openAdjustModal('cash', 'add')" class="flex-1 bg-green-400 hover:bg-green-300 text-white py-2 rounded-lg font-semibold">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                        <button onclick="openAdjustModal('cash', 'remove')" class="flex-1 bg-green-700 hover:bg-green-800 text-white py-2 rounded-lg font-semibold">
                            <i class="fas fa-minus"></i> Retirar
                        </button>
                    </div>
                </div>

                <div class="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-blue-100 text-sm font-semibold uppercase">üè¶ Dinero en Cuenta</p>
                            <p class="text-4xl font-bold mt-1" id="cashflow-bank">$0</p>
                        </div>
                        <button onclick="openAdjustModal('bank')" class="bg-white text-blue-600 px-3 py-2 rounded-lg font-bold hover:bg-blue-50 text-sm">
                            <i class="fas fa-plus-minus"></i>
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openAdjustModal('bank', 'add')" class="flex-1 bg-blue-400 hover:bg-blue-300 text-white py-2 rounded-lg font-semibold">
                            <i class="fas fa-plus"></i> Agregar
                        </button>
                        <button onclick="openAdjustModal('bank', 'remove')" class="flex-1 bg-blue-700 hover:bg-blue-800 text-white py-2 rounded-lg font-semibold">
                            <i class="fas fa-minus"></i> Retirar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Selector de Per√≠odo -->
            <div class="bg-gray-100 rounded-xl p-2 flex flex-wrap gap-2 justify-center">
                <button onclick="setCashflowPeriod('today')" id="btn-cf-today" class="cf-period-btn px-4 py-2 rounded-lg text-sm font-bold bg-white text-gray-800 shadow-sm hover:bg-gray-50 transition">
                    Hoy
                </button>
                <button onclick="setCashflowPeriod('week')" id="btn-cf-week" class="cf-period-btn px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-white hover:shadow-sm transition">
                    7 d√≠as
                </button>
                <button onclick="setCashflowPeriod('month')" id="btn-cf-month" class="cf-period-btn px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-white hover:shadow-sm transition">
                    30 d√≠as
                </button>
                <button onclick="setCashflowPeriod('year')" id="btn-cf-year" class="cf-period-btn px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-white hover:shadow-sm transition">
                    1 a√±o
                </button>
                <button onclick="setCashflowPeriod('all')" id="btn-cf-all" class="cf-period-btn px-4 py-2 rounded-lg text-sm font-bold text-gray-600 hover:bg-white hover:shadow-sm transition">
                    Todo
                </button>
            </div>

            <!-- Selector de Modo: Valor ($) o Porcentaje (%) -->
            <div class="flex justify-center">
                <div class="bg-gray-200 rounded-lg p-1 flex">
                    <button onclick="setChartMode('money')" id="btn-mode-money" class="px-4 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition">
                        üíµ Valor ($)
                    </button>
                    <button onclick="setChartMode('percent')" id="btn-mode-percent" class="px-4 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-white hover:shadow-sm transition">
                        üìä Porcentaje (%)
                    </button>
                </div>
            </div>

            <!-- Resumen Financiero Simple -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                    <p class="text-blue-600 text-xs font-bold uppercase">üí∞ Capital Total</p>
                    <p class="text-2xl font-bold text-blue-800" id="metric-capital-injected">$0</p>
                    <p class="text-xs text-blue-500 mt-1">Caja + Cuenta + Stock</p>
                </div>
                <div class="bg-emerald-50 rounded-xl p-4 border border-emerald-200">
                    <p class="text-emerald-600 text-xs font-bold uppercase">üíµ Ganancia Neta</p>
                    <p class="text-2xl font-bold text-emerald-800" id="metric-net-profit">$0</p>
                </div>
                <div class="bg-purple-50 rounded-xl p-4 border border-purple-200">
                    <p class="text-purple-600 text-xs font-bold uppercase">‚è±Ô∏è Recuperaci√≥n</p>
                    <p class="text-2xl font-bold text-purple-800" id="metric-roi-days">0 d√≠as</p>
                </div>
            </div>

            <!-- Movimientos de Caja y Cuenta -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold"><i class="fas fa-money-bill-wave text-green-600"></i> Movimientos de Caja</h3>
                        <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full" id="cash-movements-count">0</span>
                    </div>
                    <div class="h-64 overflow-y-auto pr-2 space-y-2 custom-scrollbar" id="cash-movements-container">
                        <div class="space-y-3" id="cash-movements-list"></div>
                    </div>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold"><i class="fas fa-university text-blue-600"></i> Movimientos de Cuenta</h3>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-full" id="bank-movements-count">0</span>
                    </div>
                    <div class="h-64 overflow-y-auto pr-2 space-y-2 custom-scrollbar" id="bank-movements-container">
                        <div class="space-y-3" id="bank-movements-list"></div>
                    </div>
                </div>
            </div>

            <!-- Inversiones y Gastos -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4"><i class="fas fa-boxes text-blue-600"></i> Inversi√≥n en Mercader√≠a</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
                            <p class="text-blue-600 text-xs font-bold uppercase">Hoy</p>
                            <p class="text-xl font-bold text-blue-800" id="investment-today">$0</p>
                        </div>
                        <div class="bg-indigo-50 rounded-xl p-4 border border-indigo-200">
                            <p class="text-indigo-600 text-xs font-bold uppercase">Mes</p>
                            <p class="text-xl font-bold text-indigo-800" id="investment-month">$0</p>
                        </div>
                        <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                            <p class="text-slate-600 text-xs font-bold uppercase">Total Hist√≥rico</p>
                            <p class="text-xl font-bold text-slate-800" id="investment-total">$0</p>
                            <p class="text-xs text-slate-400 mt-1">Todas las compras</p>
                        </div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">üí° Total = Suma de todo el dinero invertido en mercader√≠a desde el inicio</p>
                </div>

                <div class="bg-white rounded-2xl shadow-lg p-6">
                    <h3 class="text-lg font-bold mb-4"><i class="fas fa-receipt text-red-600"></i> Gastos Operativos</h3>
                    <div class="grid grid-cols-3 gap-4 mb-4">
                        <div class="bg-red-50 rounded-xl p-4 border border-red-200">
                            <p class="text-red-600 text-xs font-bold uppercase">Hoy</p>
                            <p class="text-xl font-bold text-red-800" id="expenses-today">$0</p>
                        </div>
                        <div class="bg-orange-50 rounded-xl p-4 border border-orange-200">
                            <p class="text-orange-600 text-xs font-bold uppercase">Mes</p>
                            <p class="text-xl font-bold text-orange-800" id="expenses-month">$0</p>
                        </div>
                        <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                            <p class="text-gray-600 text-xs font-bold uppercase">Total</p>
                            <p class="text-xl font-bold text-gray-800" id="expenses-total">$0</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla de Gastos -->
            <div class="bg-white rounded-2xl shadow-lg p-6">
                <h3 class="text-lg font-bold mb-4"><i class="fas fa-list text-gray-600"></i> Detalle de Gastos</h3>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Fecha</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Concepto</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500">Origen</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Monto</th>
                                <th class="px-4 py-2 text-right text-xs font-medium text-gray-500">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-table" class="divide-y divide-gray-200"></tbody>
                    </table>
                </div>
            </div>

            <!-- Gr√°fico Financiero -->
            <div class="bg-white rounded-2xl p-4 shadow-lg">
                <div class="flex justify-between items-center mb-3">
                    <h3 class="text-base font-bold"><i class="fas fa-chart-area text-purple-600"></i> Resumen Financiero</h3>
                    <div class="flex bg-gray-100 rounded-lg p-1">
                        <button onclick="setChartDays(30)" id="btn-chart-30" class="px-3 py-1 text-xs font-bold rounded bg-white text-gray-800 shadow-sm">30 d√≠as</button>
                        <button onclick="setChartDays(365)" id="btn-chart-365" class="px-3 py-1 text-xs font-bold rounded text-gray-600 hover:bg-white">1 a√±o</button>
                    </div>
                </div>
                <canvas id="cashFlowChart" height="150"></canvas>
                <div class="flex justify-center gap-4 mt-2 text-xs">
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500"></span> Facturado</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-blue-500"></span> Ganado</span>
                    <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> Gastado</span>
                </div>
            </div>
        </div>

        <!-- Control de Stock -->
        <div id="predictions" class="section hidden space-y-6 fade-in">
            <!-- Resumen de Stock -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-boxes text-purple-600"></i> Control de Stock
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-red-50 rounded-xl p-4 border border-red-200">
                        <p class="text-red-600 text-xs font-bold uppercase">Stock Cr√≠tico</p>
                        <p class="text-3xl font-bold text-red-800" id="critical-stock-count">0</p>
                        <p class="text-xs text-red-500">Productos a reponer urgente</p>
                    </div>
                    <div class="bg-orange-50 rounded-xl p-4 border border-orange-200">
                        <p class="text-orange-600 text-xs font-bold uppercase">Stock Bajo</p>
                        <p class="text-3xl font-bold text-orange-800" id="low-stock-count">0</p>
                        <p class="text-xs text-orange-500">Productos por debajo del m√≠nimo</p>
                    </div>
                    <div class="bg-green-50 rounded-xl p-4 border border-green-200">
                        <p class="text-green-600 text-xs font-bold uppercase">Inversi√≥n Necesaria</p>
                        <p class="text-3xl font-bold text-green-800" id="total-buy-investment">$0</p>
                        <p class="text-xs text-green-500">Para completar stock √≥ptimo</p>
                    </div>
                </div>
            </div>

            <!-- Tarjetas de Resumen de Stock -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-chart-pie text-blue-600"></i> Resumen de Stock
                </h3>
                <div id="prediction-cards" class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <!-- Generated by JS -->
                </div>
            </div>

            <!-- Tabla de Recomendaciones de Compra -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fas fa-clipboard-list text-green-600"></i> Lista de Compras Sugerida
                    </h3>
                    <span class="text-sm text-gray-500 bg-gray-100 px-3 py-1 rounded-full" id="shopping-list-count">0 productos</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-purple-50">
                            <tr>
                                <th class="px-4 py-3 text-left text-xs font-medium text-purple-600 uppercase">Producto</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-purple-600 uppercase">Stock Actual</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-purple-600 uppercase">Stock M√≠nimo</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-purple-600 uppercase">Comprar</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-purple-600 uppercase">Demanda/D√≠a</th>
                                <th class="px-4 py-3 text-center text-xs font-medium text-purple-600 uppercase">Prioridad</th>
                            </tr>
                        </thead>
                        <tbody id="auto-shopping-list" class="divide-y divide-gray-200">
                            <!-- Generated by JS -->
                        </tbody>
                    </table>
                </div>
                <div class="mt-4 flex justify-end gap-3">
                    <button onclick="exportShoppingList()" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold shadow">
                        <i class="fas fa-download"></i> Exportar Lista
                    </button>
                </div>
            </div>

            <!-- An√°lisis de Productos Top -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-lg font-bold mb-4 flex items-center gap-2">
                    <i class="fas fa-trophy text-yellow-600"></i> Productos M√°s Vendidos
                </h3>
                <div id="top-products-analysis">
                    <!-- Generated by JS -->
                </div>
            </div>

        </div>

        <!-- Alerts -->
        <div id="alerts" class="section hidden space-y-6 fade-in">
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-bell text-red-500"></i> Centro de Alertas
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <button onclick="filterAlerts('all')" class="alert-filter active bg-purple-600 text-white px-4 py-2 rounded-lg font-bold" data-filter="all">
                        Todas
                    </button>
                    <button onclick="filterAlerts('stock')" class="alert-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold" data-filter="stock">
                        Stock Bajo
                    </button>
                    <button onclick="filterAlerts('expiry')" class="alert-filter bg-gray-200 text-gray-700 px-4 py-2 rounded-lg font-bold" data-filter="expiry">
                        Por Vencer
                    </button>
                </div>

                <div id="alerts-list" class="space-y-3">
                    <!-- Generated by JS -->
                </div>
            </div>
        </div>

        <!-- Reports -->
        <div id="reports" class="section hidden space-y-6 fade-in">
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2">
                    <i class="fas fa-file-export text-purple-600"></i> Exportar Datos
                </h3>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="border rounded-xl p-6 hover:shadow-lg transition">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center text-green-600">
                                <i class="fas fa-file-excel text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Reporte de Ventas</h4>
                                <p class="text-sm text-gray-500">Exportar todas las ventas a Excel</p>
                            </div>
                        </div>
                        <div class="flex gap-2 mb-4">
                            <input type="date" id="report-start-date" class="border rounded-lg px-3 py-2 text-sm flex-1">
                            <input type="date" id="report-end-date" class="border rounded-lg px-3 py-2 text-sm flex-1">
                        </div>
                        <button onclick="exportSalesReport()" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg font-bold">
                            <i class="fas fa-download"></i> Descargar Excel
                        </button>
                    </div>

                    <div class="border rounded-xl p-6 hover:shadow-lg transition">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600">
                                <i class="fas fa-boxes text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Inventario Completo</h4>
                                <p class="text-sm text-gray-500">Exportar estado actual del stock</p>
                            </div>
                        </div>
                        <button onclick="exportInventoryReport()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg font-bold">
                            <i class="fas fa-download"></i> Descargar Inventario
                        </button>
                    </div>

                    <div class="border rounded-xl p-6 hover:shadow-lg transition">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center text-purple-600">
                                <i class="fas fa-chart-pie text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Resumen Financiero</h4>
                                <p class="text-sm text-gray-500">Estado financiero completo</p>
                            </div>
                        </div>
                        <button onclick="exportFinancialReport()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg font-bold">
                            <i class="fas fa-download"></i> Descargar Resumen
                        </button>
                    </div>

                    <div class="border rounded-xl p-6 hover:shadow-lg transition">
                        <div class="flex items-center gap-4 mb-4">
                            <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center text-red-600">
                                <i class="fas fa-file-pdf text-xl"></i>
                            </div>
                            <div>
                                <h4 class="font-bold text-gray-800">Reporte de Impuestos</h4>
                                <p class="text-sm text-gray-500">Resumen para declaraci√≥n</p>
                            </div>
                        </div>
                        <button onclick="exportTaxReport()" class="w-full bg-red-600 hover:bg-red-700 text-white py-2 rounded-lg font-bold">
                            <i class="fas fa-download"></i> Descargar PDF
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings -->
        <div id="settings" class="section hidden space-y-6 fade-in">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Margen de Ganancia -->
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-purple-600">
                        <i class="fas fa-percentage"></i> Margen de Ganancia
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Margen por defecto (%)</label>
                            <div class="relative">
                                <input type="number" id="settings-margin" class="w-full border-2 border-purple-200 rounded-xl px-4 py-3 text-2xl font-bold text-center" value="30" min="1" max="99">
                                <span class="absolute right-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-bold">%</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Este margen se usar√° para calcular el precio de venta autom√°ticamente.</p>
                        </div>
                        <button onclick="saveMarginFromSettings()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-3 rounded-xl font-bold shadow-lg">
                            <i class="fas fa-save"></i> Guardar Margen
                        </button>
                    </div>
                </div>

                <!-- Saldos Iniciales -->
                <div class="bg-white rounded-2xl p-6 shadow-lg">
                    <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-green-600">
                        <i class="fas fa-wallet"></i> Saldos
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üíµ Dinero en Caja</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-bold">$</span>
                                <input type="number" id="settings-cash" class="w-full border-2 border-green-200 rounded-xl px-4 py-3 text-2xl font-bold text-center pl-10" value="0" min="0" step="0.01">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">üè¶ Dinero en Cuenta</label>
                            <div class="relative">
                                <span class="absolute left-4 top-1/2 transform -translate-y-1/2 text-gray-500 font-bold">$</span>
                                <input type="number" id="settings-bank" class="w-full border-2 border-blue-200 rounded-xl px-4 py-3 text-2xl font-bold text-center pl-10" value="0" min="0" step="0.01">
                            </div>
                        </div>
                        <button onclick="saveBalancesFromSettings()" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-bold shadow-lg">
                            <i class="fas fa-save"></i> Guardar Saldos
                        </button>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Sistema -->
            <div class="bg-white rounded-2xl p-6 shadow-lg">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-gray-600">
                    <i class="fas fa-info-circle"></i> Informaci√≥n del Sistema
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-gray-50 rounded-xl p-4 text-center">
                        <p class="text-sm text-gray-500 mb-1">Total Productos</p>
                        <p class="text-3xl font-bold text-purple-600" id="settings-product-count">0</p>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4 text-center">
                        <p class="text-sm text-gray-500 mb-1">Total Ventas</p>
                        <p class="text-3xl font-bold text-green-600" id="settings-sales-count">0</p>
                    </div>
                    <div class="bg-gray-50 rounded-xl p-4 text-center">
                        <p class="text-sm text-gray-500 mb-1">Total Gastos</p>
                        <p class="text-3xl font-bold text-red-600" id="settings-expenses-count">0</p>
                    </div>
                </div>
            </div>

            <!-- Zona de Peligro - Reiniciar Todo -->
            <div class="bg-red-50 rounded-2xl p-6 shadow-lg border-2 border-red-200">
                <h3 class="text-xl font-bold mb-6 flex items-center gap-2 text-red-600">
                    <i class="fas fa-exclamation-triangle"></i> Zona de Peligro
                </h3>
                <div class="space-y-4">
                    <div class="p-4 bg-white rounded-xl border border-red-200">
                        <h4 class="font-bold text-red-800 mb-2">Reiniciar Sistema</h4>
                        <p class="text-sm text-gray-600 mb-4">Esto eliminar√° TODOS los datos: productos, ventas, gastos, y configuraciones. Esta acci√≥n no se puede deshacer.</p>
                        <div class="flex gap-3">
                            <button onclick="resetAllData()" class="flex-1 bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-bold shadow-lg">
                                <i class="fas fa-trash-alt"></i> Reiniciar Todo
                            </button>
                            <button onclick="exportBackupBeforeReset()" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold shadow-lg">
                                <i class="fas fa-download"></i> Exportar Backup Primero
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // ==================== STATE MANAGEMENT ====================
        let appState = {
            currentDate: new Date(),
            activeDate: new Date(),
            defaultMargin: 30,
            cash: 0,
            bank: 0,
            inventory: [],
            sales: [],
            expenses: [],
            investments: [],
            cashMovements: [],
            cart: [],
            paymentMethod: 'cash',
            calendarMonth: new Date(),
            alerts: [],
            pendingPurchase: null,
            pendingPurchasePayment: 'cash',
            initialCapital: 0, // Capital inicial inyectado por el usuario
            capitalAdjustments: [] // Historial de ajustes de capital
        };

        // Variables para charts
        let salesChartInstance = null;
        let predictionChartInstance = null;
        let cashFlowChartInstance = null;
        let performanceChartInstance = null;
        let currentPerformancePeriod = 'day'; // day, week, month, year
        let currentCashflowPeriod = 'month'; // today, week, month, year, all
        let chartMode = 'money'; // 'money' or 'percent'
        let chartDays = 30; // 30 or 365
        
        // trendChartInstance se guarda en window para persistencia entre renders

        // ==================== INITIALIZATION ====================
        document.addEventListener('DOMContentLoaded', function() {
            // FIX: Asegurar que el body tenga el padding correcto
            document.body.style.paddingLeft = '16rem';
            
            loadFromLocalStorage();
            updateDateDisplay();
            renderAll();
            
            // Debug: mostrar valores cargados
            console.log('Inicializaci√≥n completa - Caja:', appState.cash, 'Cuenta:', appState.bank);
            
            // Asegurar que el sidebar se actualice correctamente despu√©s de un momento
            setTimeout(() => {
                updateSidebar();
                updateInventoryValues();
                // Inicializar per√≠odo de cashflow
                setCashflowPeriod('month');
                // Inicializar modo de gr√°fico
                setChartMode('money');
            }, 100);
            
            // Inicializar display de margen en formulario
            const marginDisplay = document.getElementById('inv-margin-display');
            const marginInput = document.getElementById('inv-margin');
            if (marginDisplay) {
                marginDisplay.textContent = `${appState.defaultMargin || 30}%`;
            }
            if (marginInput) {
                marginInput.value = appState.defaultMargin || 30;
            }
            
            // Verificar si hay datos guardados
            const hasData = localStorage.getItem('kioscopro-data');
            if (hasData) {
                console.log('‚úÖ Datos cargados desde localStorage');
                console.log('üíµ Caja:', appState.cash);
                console.log('üè¶ Banco:', appState.bank);
                console.log('üì¶ Productos:', appState.inventory.length);
                console.log('üõí Ventas:', appState.sales.length);
            } else {
                console.log('‚ö†Ô∏è Primera vez - No hay datos guardados');
                // Guardar estado inicial
                saveToLocalStorage();
            }
            
            // Mostrar estado de sincronizaci√≥n
            setTimeout(() => {
                if (!navigator.onLine) {
                    showNotification('üì¥ Sin internet - Trabajando en modo offline', 'info');
                } else if (window.db) {
                    showNotification('‚òÅÔ∏è Conectado - Tus datos se sincronizan en la nube', 'success');
                } else {
                    showNotification('üì¥ Firebase no disponible - Modo offline', 'info');
                }
            }, 2000);
            
            // Inventory form handler
            document.getElementById('add-inventory-form').addEventListener('submit', function(e) {
                e.preventDefault();
                preparePurchase();
            });
            
            // Confirmar al salir con carrito activo
            window.addEventListener('beforeunload', (e) => {
                if (appState.cart.length > 0) {
                    e.preventDefault();
                    e.returnValue = 'Tienes productos en el carrito. ¬øSeguro que quieres salir?';
                }
            });
            
            // Tecla ENTER para completar venta (solo en secci√≥n vender)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.repeat) {
                    const sellSection = document.getElementById('sell');
                    if (!sellSection.classList.contains('hidden') && appState.cart.length > 0) {
                        // Verificar que no estemos en un input de texto (como el barcode)
                        const activeElement = document.activeElement;
                        const isInput = activeElement.tagName === 'INPUT' || activeElement.tagName === 'TEXTAREA';
                        
                        // Si estamos en el input de barcode, no hacer nada (ya maneja el escaneo)
                        if (activeElement.id === 'sell-search-input') return;
                        
                        // Si estamos en otro input, hacer blur primero
                        if (isInput) activeElement.blur();
                        
                        // Completar venta
                        completeSale();
                    }
                }
            });
        });

        // ==================== SIDEBAR CONFIG FUNCTIONS ====================
        // Funciones eliminadas - ahora la config est√° en la secci√≥n Configuraci√≥n

        // ==================== DATE MANAGEMENT ====================
        function changeDate(days) {
            const newDate = new Date(appState.activeDate);
            newDate.setDate(newDate.getDate() + days);
            appState.activeDate = newDate;
            updateDateDisplay();
            renderAll();
        }

        function resetToToday() {
            appState.activeDate = new Date();
            updateDateDisplay();
            renderAll();
        }

        function updateDateDisplay() {
            const today = new Date();
            const isToday = appState.activeDate.toDateString() === today.toDateString();
            
            document.getElementById('active-date-display').textContent = isToday ? 'Hoy' : formatDate(appState.activeDate);
            document.getElementById('current-date-display').textContent = formatDateLong(appState.activeDate);
            document.getElementById('btn-back-today').classList.toggle('hidden', isToday);
        }

        function formatDate(date) {
            return date.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
        }

        function formatDateLong(date) {
            return date.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        }

        function formatDateISO(date) {
            return date.toISOString().split('T')[0];
        }

        // ==================== NAVIGATION ====================
        function showSection(sectionId) {
            // Cerrar men√∫ m√≥vil si est√° abierto
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            if (sidebar && sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            }
            
            document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
            document.getElementById(sectionId).classList.remove('hidden');
            
            document.querySelectorAll('.nav-btn').forEach(btn => {
                if (btn.dataset.section === sectionId) {
                    btn.classList.add('bg-purple-50', 'text-purple-700');
                    btn.classList.remove('text-gray-600');
                } else {
                    btn.classList.remove('bg-purple-50', 'text-purple-700');
                    btn.classList.add('text-gray-600');
                }
            });

            const titles = {
                'dashboard': 'Dashboard',
                'sell': 'Nueva Venta',
                'sales-calendar': 'Historial de Ventas',
                'inventory': 'Gesti√≥n de Inventario',
                'cashflow': 'Flujo de Caja',
                'predictions': 'Control de Stock',
                'alerts': 'Alertas',
                'reports': 'Reportes'
            };
            document.getElementById('page-title').textContent = titles[sectionId] || 'KioscoPro';

            if (sectionId === 'dashboard') renderDashboard();
            if (sectionId === 'sell') {
                renderSellAlerts();
                setTimeout(() => {
                    const searchInput = document.getElementById('sell-search-input');
                    if (searchInput) searchInput.focus();
                }, 100);
            }
            if (sectionId === 'sales-calendar') {
                // Seleccionar el d√≠a activo por defecto
                selectedCalendarDate = formatDateISO(appState.activeDate);
                renderCalendar();
            }
            if (sectionId === 'inventory') renderInventory();
            if (sectionId === 'cashflow') {
                renderCashflow();
                setTimeout(() => renderPerformanceChart(), 100);
            }
            if (sectionId === 'predictions') renderPredictions();
            if (sectionId === 'alerts') renderAlerts();
            if (sectionId === 'settings') renderSettings();
        }

        // ==================== MOBILE SIDEBAR ====================
        function toggleMobileSidebar() {
            const sidebar = document.getElementById('mobile-sidebar');
            const overlay = document.getElementById('mobile-overlay');
            
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                overlay.classList.add('hidden');
                document.body.style.overflow = '';
            } else {
                sidebar.classList.add('open');
                overlay.classList.remove('hidden');
                document.body.style.overflow = 'hidden';
            }
        }

        // ==================== QUICK SELL BUTTON ====================
        function quickSell() {
            const btn = document.getElementById('btn-quick-sell');
            btn.classList.add('btn-clicked');
            setTimeout(() => btn.classList.remove('btn-clicked'), 200);
            
            showSection('sell');
            showNotification('Modo venta activado', 'success');
        }

        // ==================== DASHBOARD ====================
        function renderDashboard() {
            const today = formatDateISO(appState.activeDate);
            const todaySales = appState.sales.filter(s => s.date === today);
            const todayExpenses = appState.expenses.filter(e => e.date === today);
            const todayInvestments = appState.investments.filter(i => i.date === today);
            
            const todayRevenue = todaySales.reduce((sum, s) => sum + s.total, 0);
            const todayProfit = todaySales.reduce((sum, s) => sum + s.profit, 0);
            const todayExpenseAmount = todayExpenses.reduce((sum, e) => sum + e.amount, 0);
            const todayInvestmentAmount = todayInvestments.reduce((sum, i) => sum + i.amount, 0);
            const netBalance = todayRevenue - todayExpenseAmount - todayInvestmentAmount;

            const kpiData = [
                { title: 'Ventas Hoy', value: `$${todayRevenue.toFixed(2)}`, icon: 'fa-dollar-sign', color: 'purple', subtext: `${todaySales.length} ventas` },
                { title: 'Ganancia Neta', value: `$${todayProfit.toFixed(2)}`, icon: 'fa-chart-line', color: 'green', subtext: 'despu√©s de costos' },
                { title: 'Gastos Hoy', value: `$${todayExpenseAmount.toFixed(2)}`, icon: 'fa-receipt', color: 'red', subtext: `${todayExpenses.length} gastos` },
                { title: 'Inversi√≥n Hoy', value: `$${todayInvestmentAmount.toFixed(2)}`, icon: 'fa-boxes', color: 'blue', subtext: `${todayInvestments.length} compras` }
            ];

            document.getElementById('dashboard-kpis').innerHTML = kpiData.map(kpi => `
                <div class="kpi-card kpi-${kpi.color} card-hover">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-gray-500 text-sm font-medium uppercase">${kpi.title}</p>
                            <p class="text-2xl font-bold text-gray-800 mt-1">${kpi.value}</p>
                        </div>
                        <div class="kpi-icon bg-${kpi.color}-100 text-${kpi.color}-600">
                            <i class="fas ${kpi.icon}"></i>
                        </div>
                    </div>
                    <p class="text-xs text-gray-400">${kpi.subtext}</p>
                </div>
            `).join('');

            document.getElementById('today-sales-count').textContent = `(${todaySales.length} ventas)`;
            document.getElementById('today-total-sales').textContent = `$${todayRevenue.toFixed(2)}`;
            
            if (todaySales.length === 0) {
                document.getElementById('today-sales-list').innerHTML = '<p class="text-center text-gray-400 py-8">No hay ventas hoy</p>';
            } else {
                document.getElementById('today-sales-list').innerHTML = todaySales.slice().reverse().map(sale => `
                    <div class="sale-item flex justify-between items-center p-3 rounded-lg border cursor-pointer" onclick="showSaleDetail('${sale.id}')">
                        <div>
                            <p class="font-bold text-gray-800">Venta #${sale.id.slice(-4)}</p>
                            <p class="text-sm text-gray-500">${sale.time} ‚Ä¢ ${sale.items.length} items ‚Ä¢ ${sale.paymentMethod === 'cash' ? 'üíµ Efectivo' : 'üí≥ D√©bito'}</p>
                        </div>
                        <div class="text-right">
                            <p class="font-bold text-lg text-green-600">$${sale.total.toFixed(2)}</p>
                            <p class="text-xs text-gray-400">Ganancia: $${sale.profit.toFixed(2)}</p>
                        </div>
                    </div>
                `).join('');
            }
            
            // Renderizar alertas inteligentes
            renderDashboardAlerts();

            renderCharts();
        }
        
        function renderDashboardAlerts() {
            const alertsContainer = document.getElementById('dashboard-alerts');
            if (!alertsContainer) return;
            
            const alerts = [];
            const today = new Date();
            
            // 1. Productos SIN STOCK (Cr√≠tico)
            const noStockProducts = appState.inventory.filter(p => getProductStock(p) === 0);
            if (noStockProducts.length > 0) {
                alerts.push({
                    type: 'critical',
                    icon: 'üö®',
                    title: `Sin Stock: ${noStockProducts.length} producto${noStockProducts.length > 1 ? 's' : ''}`,
                    message: noStockProducts.slice(0, 3).map(p => p.name).join(', ') + (noStockProducts.length > 3 ? ` y ${noStockProducts.length - 3} m√°s` : ''),
                    action: 'Comprar ahora',
                    actionFn: "showSection('inventory')",
                    bgColor: 'bg-red-50',
                    borderColor: 'border-red-500',
                    textColor: 'text-red-800',
                    iconBg: 'bg-red-100'
                });
            }
            
            // 2. Productos con Stock Bajo (Advertencia)
            const lowStockProducts = appState.inventory.filter(p => {
                const stock = getProductStock(p);
                return stock > 0 && stock <= (p.min || 5);
            });
            if (lowStockProducts.length > 0) {
                alerts.push({
                    type: 'warning',
                    icon: '‚ö†Ô∏è',
                    title: `Stock Bajo: ${lowStockProducts.length} producto${lowStockProducts.length > 1 ? 's' : ''}`,
                    message: lowStockProducts.slice(0, 3).map(p => `${p.name} (${getProductStock(p)})`).join(', ') + (lowStockProducts.length > 3 ? ` y ${lowStockProducts.length - 3} m√°s` : ''),
                    action: 'Ver inventario',
                    actionFn: "showSection('inventory')",
                    bgColor: 'bg-orange-50',
                    borderColor: 'border-orange-500',
                    textColor: 'text-orange-800',
                    iconBg: 'bg-orange-100'
                });
            }
            
            // 3. Productos por VENCER (Pr√≥ximos 7 d√≠as) - con sugerencia de PROMOCI√ìN
            // Buscar en el primer lote de cada producto (FIFO - el que se vende primero)
            const expiringProducts = [];
            appState.inventory.forEach(p => {
                if (p.batches && p.batches.length > 0) {
                    // Ordenar por vencimiento y tomar el primero (FIFO)
                    const sortedBatches = [...p.batches].sort((a, b) => {
                        if (!a.expiry) return 1;
                        if (!b.expiry) return -1;
                        return new Date(a.expiry) - new Date(b.expiry);
                    });
                    const firstBatch = sortedBatches[0];
                    if (firstBatch.expiry && firstBatch.stock > 0) {
                        const daysUntil = Math.ceil((new Date(firstBatch.expiry) - today) / (1000 * 60 * 60 * 24));
                        if (daysUntil > 0 && daysUntil <= 7) {
                            expiringProducts.push({ product: p, daysUntil, batch: firstBatch });
                        }
                    }
                } else if (p.expiry) {
                    // Compatibilidad con productos antiguos
                    const daysUntil = Math.ceil((new Date(p.expiry) - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil > 0 && daysUntil <= 7) {
                        expiringProducts.push({ product: p, daysUntil, batch: null });
                    }
                }
            });
            
            if (expiringProducts.length > 0) {
                expiringProducts.forEach(({ product: p, daysUntil }) => {
                    const promoPrice = (p.salePrice * 0.7).toFixed(0); // 30% off
                    const stock = getProductStock(p);
                    
                    alerts.push({
                        type: 'promo',
                        icon: 'üéØ',
                        title: `üö® PROMO por Vencer: ${p.name}`,
                        message: `Vence en ${daysUntil} d√≠a${daysUntil > 1 ? 's' : ''}. Stock: ${stock} unidades. Sugerencia: Precio promocional $${promoPrice} (30% off)`,
                        action: 'Aplicar Promo',
                        actionFn: `applyPromoPrice('${p.id}', ${promoPrice})`,
                        bgColor: 'bg-purple-50',
                        borderColor: 'border-purple-500',
                        textColor: 'text-purple-800',
                        iconBg: 'bg-purple-100'
                    });
                });
            }
            
            // 4. Productos pr√≥ximos a vencer (8-15 d√≠as) - Advertencia temprana
            const earlyExpiring = [];
            appState.inventory.forEach(p => {
                if (p.batches && p.batches.length > 0) {
                    const sortedBatches = [...p.batches].sort((a, b) => {
                        if (!a.expiry) return 1;
                        if (!b.expiry) return -1;
                        return new Date(a.expiry) - new Date(b.expiry);
                    });
                    const firstBatch = sortedBatches[0];
                    if (firstBatch.expiry && firstBatch.stock > 0) {
                        const daysUntil = Math.ceil((new Date(firstBatch.expiry) - today) / (1000 * 60 * 60 * 24));
                        if (daysUntil >= 8 && daysUntil <= 15) {
                            earlyExpiring.push({ product: p, daysUntil });
                        }
                    }
                } else if (p.expiry) {
                    const daysUntil = Math.ceil((new Date(p.expiry) - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil >= 8 && daysUntil <= 15) {
                        earlyExpiring.push({ product: p, daysUntil });
                    }
                }
            });
            
            if (earlyExpiring.length > 0) {
                alerts.push({
                    type: 'info',
                    icon: 'üìÖ',
                    title: `Pr√≥ximos a Vencer: ${earlyExpiring.length} producto${earlyExpiring.length > 1 ? 's' : ''}`,
                    message: earlyExpiring.slice(0, 3).map(({ product: p, daysUntil }) => {
                        return `${p.name} (${daysUntil}d)`;
                    }).join(', ') + (earlyExpiring.length > 3 ? ` y ${earlyExpiring.length - 3} m√°s` : ''),
                    action: 'Ver detalles',
                    actionFn: "showSection('inventory')",
                    bgColor: 'bg-yellow-50',
                    borderColor: 'border-yellow-500',
                    textColor: 'text-yellow-800',
                    iconBg: 'bg-yellow-100'
                });
            }
            
            // 5. Productos que necesitan compra urgente (predicci√≥n)
            if (appState.sales.length > 0) {
                const shoppingList = generateShoppingList().filter(item => item.priority === 'CR√çTICO' || item.priority === 'ALTA');
                if (shoppingList.length > 0) {
                    const urgentCount = shoppingList.filter(i => i.priority === 'CR√çTICO').length;
                    const highCount = shoppingList.filter(i => i.priority === 'ALTA').length;
                    
                    alerts.push({
                        type: 'shopping',
                        icon: 'üõí',
                        title: `Lista de Compras: ${shoppingList.length} producto${shoppingList.length > 1 ? 's' : ''}`,
                        message: `${urgentCount} cr√≠tico${urgentCount !== 1 ? 's' : ''}, ${highCount} alta prioridad`,
                        action: 'Ver lista',
                        actionFn: "showSection('predictions')",
                        bgColor: 'bg-blue-50',
                        borderColor: 'border-blue-500',
                        textColor: 'text-blue-800',
                        iconBg: 'bg-blue-100'
                    });
                }
            }
            
            // Renderizar alertas
            if (alerts.length === 0) {
                alertsContainer.innerHTML = '';
            } else {
                alertsContainer.innerHTML = alerts.map(alert => `
                    <div class="${alert.bgColor} border-l-4 ${alert.borderColor} rounded-xl p-4 flex items-start gap-3 shadow-sm">
                        <div class="${alert.iconBg} rounded-full w-10 h-10 flex items-center justify-center flex-shrink-0">
                            <span class="text-lg">${alert.icon}</span>
                        </div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold ${alert.textColor}">${alert.title}</h4>
                            <p class="text-sm ${alert.textColor} opacity-80 mt-1">${alert.message}</p>
                        </div>
                        <button onclick="${alert.actionFn}" class="flex-shrink-0 px-3 py-1.5 bg-white rounded-lg text-sm font-bold shadow hover:shadow-md transition ${alert.textColor}">
                            ${alert.action}
                        </button>
                    </div>
                `).join('');
            }
        }
        
        function applyPromoPrice(productId, promoPrice) {
            const product = appState.inventory.find(p => p.id === productId);
            if (!product) return;
            
            // Guardar precio original si no existe
            if (!product.originalPrice) {
                product.originalPrice = product.salePrice;
            }
            
            // Aplicar precio promocional
            product.salePrice = parseFloat(promoPrice);
            product.isPromo = true;
            product.promoEndDate = formatDateISO(new Date(Date.now() + 7 * 24 * 60 * 60 * 1000)); // 7 d√≠as de promo
            
            saveToLocalStorage();
            renderAll();
            
            showNotification(`üéØ Precio promocional aplicado: ${product.name} ahora $${promoPrice}`, 'success');
        }

        function renderCharts() {
            if (salesChartInstance) {
                salesChartInstance.destroy();
                salesChartInstance = null;
            }
            if (predictionChartInstance) {
                predictionChartInstance.destroy();
                predictionChartInstance = null;
            }

            const ctx1 = document.getElementById('salesChart');
            if (ctx1) {
                const last7Days = getLast7DaysSales();
                const categories = {};
                last7Days.forEach(sale => {
                    sale.items.forEach(item => {
                        const product = appState.inventory.find(p => p.id === item.productId);
                        if (product) {
                            categories[product.category] = (categories[product.category] || 0) + (item.price * item.quantity);
                        }
                    });
                });

                salesChartInstance = new Chart(ctx1, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(categories).map(c => c.charAt(0).toUpperCase() + c.slice(1)),
                        datasets: [{
                            label: 'Ventas ($)',
                            data: Object.values(categories),
                            backgroundColor: ['#8b5cf6', '#ef4444', '#f59e0b', '#10b981', '#3b82f6'],
                            borderRadius: 8
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { legend: { display: false } },
                        scales: { y: { beginAtZero: true } }
                    }
                });
            }

            const ctx2 = document.getElementById('predictionChart');
            if (ctx2) {
                try {
                    const predictions = generatePredictions();
                    
                    // Solo crear el gr√°fico si hay datos de predicci√≥n
                    const totalDemand = predictions.reduce((sum, p) => sum + p.demand, 0);
                    
                    if (totalDemand > 0) {
                        predictionChartInstance = new Chart(ctx2, {
                            type: 'line',
                            data: {
                                labels: predictions.map(p => p.date),
                                datasets: [{
                                    label: 'Demanda Predicha',
                                    data: predictions.map(p => p.demand),
                                    borderColor: '#8b5cf6',
                                    backgroundColor: 'rgba(139, 92, 246, 0.1)',
                                    fill: true,
                                    tension: 0.4
                                }]
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { display: false } },
                                scales: { y: { beginAtZero: true } }
                            }
                        });
                    } else {
                        // Mostrar mensaje cuando no hay datos suficientes
                        const parent = ctx2.parentElement;
                        if (parent) {
                            parent.innerHTML = `
                                <div class="text-center py-8 text-gray-400">
                                    <i class="fas fa-chart-line text-4xl mb-2"></i>
                                    <p>No hay datos suficientes para predecir la demanda</p>
                                    <p class="text-sm mt-1">Se necesitan al menos algunas ventas registradas</p>
                                </div>
                            `;
                        }
                    }
                } catch (err) {
                    console.error('Error renderizando gr√°fico de predicciones:', err);
                    const parent = ctx2.parentElement;
                    if (parent) {
                        parent.innerHTML = `
                            <div class="text-center py-8 text-red-400">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Error al generar predicciones</p>
                            </div>
                        `;
                    }
                }
            }
        }

        function getLast7DaysSales() {
            const sales = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateStr = formatDateISO(date);
                sales.push(...appState.sales.filter(s => s.date === dateStr));
            }
            return sales;
        }

        // Funci√≥n simple para generar predicciones para el dashboard
        function generatePredictions() {
            const today = new Date();
            const predictions = [];
            
            // Limpiar cache antes de calcular
            statsCache.clear();
            
            for (let i = 1; i <= 7; i++) {
                const date = new Date(today);
                date.setDate(today.getDate() + i);
                const dayOfWeek = date.getDay();
                const dateStr = formatDate(date);
                
                let totalDemand = 0;
                let count = 0;
                
                // Calcular demanda promedio para este d√≠a de la semana
                if (Array.isArray(appState.inventory)) {
                    appState.inventory.forEach(product => {
                        const stats = calculateProductStats(product.id);
                        if (stats && stats.avgDaily > 0) {
                            const dayAvg = stats.avgByDayOfWeek[dayOfWeek] || stats.avgDaily;
                            totalDemand += dayAvg;
                            count++;
                        }
                    });
                }
                
                predictions.push({
                    date: dateStr,
                    demand: Math.round(totalDemand) || 0
                });
            }
            
            return predictions;
        }

        // ==================== SELLING ====================
        function focusBarcode() {
            setTimeout(() => {
                const searchInput = document.getElementById('sell-search-input');
                if (searchInput) searchInput.focus();
            }, 100);
        }

        function handleBarcodeAutoAdd(e) {
            if (e.key === 'Enter') {
                const barcode = e.target.value.trim();
                if (barcode) {
                    addToCartByBarcode(barcode);
                    e.target.value = '';
                }
            }
        }

        // ==================== B√öSQUEDA EN VENTAS ====================
        function handleSellSearch() {
            const search = document.getElementById('sell-search-input').value.toLowerCase().trim();
            const resultsContainer = document.getElementById('sell-search-results');
            
            if (!search) {
                resultsContainer.classList.add('hidden');
                return;
            }
            
            // Buscar por nombre o c√≥digo
            const results = appState.inventory.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.barcode.toLowerCase().includes(search)
            ).slice(0, 5);
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<p class="text-gray-400 text-center py-2">No se encontraron productos</p>';
                resultsContainer.classList.remove('hidden');
                return;
            }
            
            resultsContainer.innerHTML = results.map(p => {
                const stock = getProductStock(p);
                const isLowStock = stock <= 5;
                return `
                <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg hover:bg-purple-50 cursor-pointer transition" onclick="addToCartFromSearch('${p.id}')">
                    <div>
                        <p class="font-bold text-gray-800">${p.name}</p>
                        <p class="text-xs text-gray-500">C√≥digo: ${p.barcode || 'N/A'} | Stock: <span class="${isLowStock ? 'text-red-600 font-bold' : ''}">${stock}</span></p>
                    </div>
                    <div class="text-right">
                        <p class="font-bold text-green-600">$${p.salePrice.toFixed(2)}</p>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">Click para agregar</span>
                    </div>
                </div>
            `}).join('');
            
            resultsContainer.classList.remove('hidden');
        }

        function handleSellSearchKeypress(e) {
            if (e.key === 'Enter') {
                const search = e.target.value.trim().toLowerCase();
                
                // Intentar encontrar por c√≥digo exacto primero
                const productByBarcode = appState.inventory.find(p => p.barcode.toLowerCase() === search);
                if (productByBarcode) {
                    addToCartFromSearch(productByBarcode.id);
                    return;
                }
                
                // Si no, buscar por nombre exacto o √∫nico resultado
                const results = appState.inventory.filter(p => 
                    p.name.toLowerCase().includes(search) || 
                    p.barcode.toLowerCase().includes(search)
                );
                
                if (results.length === 1) {
                    addToCartFromSearch(results[0].id);
                } else if (results.length > 1) {
                    showNotification(`${results.length} productos encontrados. Haz clic en el deseado.`, 'info');
                } else {
                    showNotification('Producto no encontrado', 'error');
                }
            }
        }

        function addToCartFromSearch(productId) {
            const product = appState.inventory.find(p => p.id === productId);
            if (!product) return;
            
            const availableStock = getProductStock(product);
            if (availableStock <= 0) {
                showNotification('Sin stock disponible', 'error');
                return;
            }
            
            // Verificar si ya est√° en el carrito
            const existingItem = appState.cart.find(item => item.productId === productId);
            if (existingItem) {
                if (existingItem.quantity < availableStock) {
                    existingItem.quantity++;
                } else {
                    showNotification('Stock m√°ximo alcanzado', 'warning');
                    return;
                }
            } else {
                appState.cart.push({
                    productId: product.id,
                    name: product.name,
                    price: product.salePrice,
                    cost: product.cost,
                    quantity: 1
                });
            }
            
            // Limpiar b√∫squeda
            document.getElementById('sell-search-input').value = '';
            document.getElementById('sell-search-results').classList.add('hidden');
            
            // Mostrar confirmaci√≥n
            document.getElementById('last-added').classList.remove('hidden');
            document.getElementById('last-added-text').textContent = `${product.name} x1`;
            setTimeout(() => {
                document.getElementById('last-added').classList.add('hidden');
            }, 2000);
            
            renderCart();
            document.getElementById('sell-search-input').focus();
        }

        // ==================== ALERTAS EN VENTAS ====================
        function renderSellAlerts() {
            const container = document.getElementById('sell-alerts');
            if (!container) return;
            
            const alerts = [];
            const today = new Date();
            
            // 1. Productos sin stock
            const noStockProducts = appState.inventory.filter(p => getProductStock(p) === 0);
            if (noStockProducts.length > 0) {
                alerts.push({
                    type: 'critical',
                    html: `
                        <div class="bg-red-50 border-l-4 border-red-500 p-4 rounded-lg flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">üö®</span>
                                <div>
                                    <p class="font-bold text-red-800">Sin Stock: ${noStockProducts.length} producto(s)</p>
                                    <p class="text-sm text-red-600">${noStockProducts.slice(0, 3).map(p => p.name).join(', ')}${noStockProducts.length > 3 ? '...' : ''}</p>
                                </div>
                            </div>
                            <button onclick="showSection('inventory')" class="bg-red-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-red-700">
                                Comprar
                            </button>
                        </div>
                    `
                });
            }
            
            // 2. Stock bajo
            const lowStockProducts = appState.inventory.filter(p => {
                const stock = getProductStock(p);
                return stock > 0 && stock <= (p.min || 5);
            });
            if (lowStockProducts.length > 0) {
                alerts.push({
                    type: 'warning',
                    html: `
                        <div class="bg-orange-50 border-l-4 border-orange-500 p-4 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">‚ö†Ô∏è</span>
                                <div>
                                    <p class="font-bold text-orange-800">Stock Bajo: ${lowStockProducts.length} producto(s)</p>
                                    <p class="text-sm text-orange-600">${lowStockProducts.slice(0, 3).map(p => `${p.name} (${getProductStock(p)})`).join(', ')}${lowStockProducts.length > 3 ? '...' : ''}</p>
                                </div>
                            </div>
                        </div>
                    `
                });
            }
            
            // 3. Productos por vencer (pr√≥ximos 7 d√≠as)
            const expiringProducts = [];
            appState.inventory.forEach(p => {
                if (p.batches && p.batches.length > 0) {
                    const sortedBatches = [...p.batches].sort((a, b) => {
                        if (!a.expiry) return 1;
                        if (!b.expiry) return -1;
                        return new Date(a.expiry) - new Date(b.expiry);
                    });
                    const firstBatch = sortedBatches[0];
                    if (firstBatch.expiry && firstBatch.stock > 0) {
                        const daysUntil = Math.ceil((new Date(firstBatch.expiry) - today) / (1000 * 60 * 60 * 24));
                        if (daysUntil > 0 && daysUntil <= 7) {
                            expiringProducts.push({ product: p, daysUntil });
                        }
                    }
                } else if (p.expiry) {
                    const daysUntil = Math.ceil((new Date(p.expiry) - today) / (1000 * 60 * 60 * 24));
                    if (daysUntil > 0 && daysUntil <= 7) {
                        expiringProducts.push({ product: p, daysUntil });
                    }
                }
            });
            
            if (expiringProducts.length > 0) {
                alerts.push({
                    type: 'promo',
                    html: `
                        <div class="bg-purple-50 border-l-4 border-purple-500 p-4 rounded-lg">
                            <div class="flex items-center gap-3">
                                <span class="text-2xl">üéØ</span>
                                <div>
                                    <p class="font-bold text-purple-800">Por Vencer: ${expiringProducts.length} producto(s)</p>
                                    <p class="text-sm text-purple-600">${expiringProducts.slice(0, 2).map(({product: p, daysUntil}) => `${p.name} (${daysUntil}d)`).join(', ')}${expiringProducts.length > 2 ? '...' : ''}</p>
                                </div>
                            </div>
                        </div>
                    `
                });
            }
            
            // Renderizar alertas
            if (alerts.length === 0) {
                container.innerHTML = '';
            } else {
                container.innerHTML = alerts.map(a => a.html).join('');
            }
        }

        function addToCartByBarcode(barcode) {
            const product = appState.inventory.find(p => p.barcode === barcode);
            if (!product) {
                showNotification('Producto no encontrado', 'error');
                return;
            }
            const availableStock = getProductStock(product);
            if (availableStock <= 0) {
                showNotification('Sin stock disponible', 'error');
                return;
            }

            const existingItem = appState.cart.find(item => item.productId === product.id);
            if (existingItem) {
                if (existingItem.quantity < availableStock) {
                    existingItem.quantity++;
                } else {
                    showNotification('Stock m√°ximo alcanzado', 'warning');
                    return;
                }
            } else {
                appState.cart.push({
                    productId: product.id,
                    name: product.name,
                    price: product.salePrice,
                    cost: product.cost,
                    quantity: 1
                });
            }

            document.getElementById('last-added').classList.remove('hidden');
            document.getElementById('last-added-text').textContent = `${product.name} x1`;
            setTimeout(() => document.getElementById('last-added').classList.add('hidden'), 2000);

            renderCart();
            showNotification(`${product.name} agregado`, 'success');
        }

        function renderCart() {
            const cartContainer = document.getElementById('cart-items');
            const badge = document.getElementById('cart-badge');
            
            const totalItems = appState.cart.reduce((sum, item) => sum + item.quantity, 0);
            badge.textContent = totalItems;
            badge.classList.toggle('hidden', totalItems === 0);
            document.getElementById('cart-count').textContent = `(${totalItems} items)`;

            if (appState.cart.length === 0) {
                cartContainer.innerHTML = '<p class="text-center text-gray-400 py-8">Escanea productos para agregar al carrito</p>';
                document.getElementById('btn-complete').disabled = true;
            } else {
                cartContainer.innerHTML = appState.cart.map((item, index) => `
                    <div class="sale-item flex justify-between items-center p-3 rounded-lg border">
                        <div class="flex-1">
                            <p class="font-bold text-gray-800">${escapeHtml(item.name)}</p>
                            <p class="text-sm text-gray-500">$${item.price.toFixed(2)} c/u</p>
                        </div>
                        <div class="flex items-center gap-3">
                            <button onclick="updateCartQuantity(${index}, -1)" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">
                                <i class="fas fa-minus text-xs"></i>
                            </button>
                            <input type="number" id="cart-qty-${index}" value="${item.quantity}" min="1" 
                                class="font-bold w-14 text-center border-2 border-gray-300 rounded-lg py-1 text-sm focus:border-purple-500 focus:outline-none"
                                onchange="setCartQuantity(${index}, this.value)" onkeypress="if(event.key==='Enter'){this.blur();}">
                            <button onclick="updateCartQuantity(${index}, 1)" class="w-8 h-8 rounded-full bg-gray-200 hover:bg-gray-300 flex items-center justify-center">
                                <i class="fas fa-plus text-xs"></i>
                            </button>
                            <button onclick="removeFromCart(${index})" class="text-red-500 hover:text-red-700 ml-2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
                document.getElementById('btn-complete').disabled = false;
            }

            updateCartTotals();
        }

        function escapeHtml(text) {
            if (typeof text !== 'string') return text;
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateCartQuantity(index, delta) {
            const item = appState.cart[index];
            const product = appState.inventory.find(p => p.id === item.productId);
            const availableStock = getProductStock(product);
            
            if (delta > 0) {
                const currentInCart = item.quantity;
                if (currentInCart + delta > availableStock) {
                    showNotification('Stock m√°ximo alcanzado', 'warning');
                    return;
                }
            }
            
            item.quantity += delta;
            
            if (item.quantity <= 0) {
                appState.cart.splice(index, 1);
            }
            
            renderCart();
        }

        function setCartQuantity(index, newQty) {
            const qty = parseInt(newQty);
            if (isNaN(qty) || qty < 1) {
                showNotification('Cantidad inv√°lida', 'error');
                renderCart();
                return;
            }
            
            const item = appState.cart[index];
            const product = appState.inventory.find(p => p.id === item.productId);
            const availableStock = getProductStock(product);
            
            if (qty > availableStock) {
                showNotification(`Stock m√°ximo disponible: ${availableStock}`, 'warning');
                item.quantity = availableStock;
            } else {
                item.quantity = qty;
            }
            
            renderCart();
        }

        function removeFromCart(index) {
            appState.cart.splice(index, 1);
            renderCart();
        }

        function clearCart() {
            if (appState.cart.length === 0) return;
            if (!confirm('¬øVaciar el carrito?')) return;
            
            appState.cart = [];
            renderCart();
            showNotification('Carrito vaciado', 'info');
        }

        function updateCartTotals() {
            const subtotal = appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            
            document.getElementById('cart-subtotal').textContent = `$${subtotal.toFixed(0)}`;
            document.getElementById('cart-total').textContent = `$${subtotal.toFixed(0)}`;
            
            calculateChange();
        }

        function setPaymentMethod(method) {
            appState.paymentMethod = method;
            
            document.getElementById('btn-cash').className = method === 'cash' 
                ? 'w-full p-4 rounded-xl border-2 border-green-500 bg-green-50 text-left flex items-center gap-3 transition'
                : 'w-full p-4 rounded-xl border-2 border-gray-200 hover:border-blue-400 text-left flex items-center gap-3 transition';
            
            document.getElementById('btn-debit').className = method === 'debit'
                ? 'w-full p-4 rounded-xl border-2 border-blue-500 bg-blue-50 text-left flex items-center gap-3 transition'
                : 'w-full p-4 rounded-xl border-2 border-gray-200 hover:border-blue-400 text-left flex items-center gap-3 transition';

            document.getElementById('cash-details').classList.toggle('hidden', method !== 'cash');
            
            if (method === 'cash') {
                calculateChange();
                // Enfocar el campo de monto recibido autom√°ticamente
                setTimeout(() => {
                    document.getElementById('cash-received').focus();
                }, 100);
            }
        }

        function calculateChange() {
            if (appState.paymentMethod !== 'cash') return;
            
            const total = appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const received = parseFloat(document.getElementById('cash-received').value) || 0;
            const change = received - total;
            
            document.getElementById('change-amount').textContent = `$${change > 0 ? change.toFixed(0) : '0'}`;
            document.getElementById('change-amount').className = change >= 0 
                ? 'text-3xl font-bold text-green-800' 
                : 'text-3xl font-bold text-red-600';
        }

        function completeSale() {
            if (appState.cart.length === 0) return;

            const total = appState.cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const profit = appState.cart.reduce((sum, item) => sum + ((item.price - item.cost) * item.quantity), 0);
            
            if (appState.paymentMethod === 'cash') {
                const received = parseFloat(document.getElementById('cash-received').value) || 0;
                if (received <= 0) {
                    showNotification('Ingres√° el monto recibido en efectivo', 'error');
                    document.getElementById('cash-received').focus();
                    return;
                }
                if (received < total) {
                    showNotification(`Monto insuficiente. Recibido: $${received.toFixed(2)}, Falta: $${(total - received).toFixed(2)}`, 'error');
                    return;
                }
            }

            // Calcular monto recibido y cambio si es efectivo
            let received = null;
            let change = null;
            if (appState.paymentMethod === 'cash') {
                received = parseFloat(document.getElementById('cash-received').value) || 0;
                change = received - total;
            }

            const sale = {
                id: 'SALE-' + Date.now(),
                date: formatDateISO(appState.activeDate),
                time: new Date().toLocaleTimeString('es-ES'),
                items: [...appState.cart],
                total: total,
                profit: profit,
                paymentMethod: appState.paymentMethod,
                received: received,
                change: change,
                timestamp: Date.now()
            };

            appState.cart.forEach(item => {
                const product = appState.inventory.find(p => p.id === item.productId);
                if (product) {
                    // Sistema FIFO: descontar del lote que vence primero
                    let qtyToDeduct = item.quantity;
                    
                    if (product.batches && product.batches.length > 0) {
                        // Ordenar lotes por vencimiento (el que vence primero, primero en la lista)
                        product.batches.sort((a, b) => {
                            if (!a.expiry) return 1;
                            if (!b.expiry) return -1;
                            return new Date(a.expiry) - new Date(b.expiry);
                        });
                        
                        // Descontar de cada lote empezando por el primero
                        for (let batch of product.batches) {
                            if (qtyToDeduct <= 0) break;
                            
                            const deductFromBatch = Math.min(qtyToDeduct, batch.stock);
                            batch.stock -= deductFromBatch;
                            qtyToDeduct -= deductFromBatch;
                        }
                        
                        // Eliminar lotes vac√≠os
                        product.batches = product.batches.filter(b => b.stock > 0);
                    }
                    
                    // Compatibilidad: actualizar stock total (para productos antiguos sin lotes)
                    const totalStock = product.batches ? product.batches.reduce((sum, b) => sum + b.stock, 0) : 0;
                    product.stock = totalStock;
                    
                    product.lastSale = new Date().toISOString();
                }
            });

            if (appState.paymentMethod === 'cash') {
                appState.cash += total;
            } else if (appState.paymentMethod === 'debit') {
                appState.bank += total;
            }

            appState.sales.push(sale);
            
            showSuccessOverlay(total);
            
            setTimeout(() => {
                appState.cart = [];
                document.getElementById('cash-received').value = '';
                
                // Mostrar notificaci√≥n para imprimir ticket (tipo toast)
                showTicketNotification(sale);
                
                saveToLocalStorage();
                renderAll();
                
                // Resetear m√©todo de pago a efectivo y actualizar la UI
                setPaymentMethod('cash');
                
                // Volver el foco al campo de b√∫squeda
                const searchInput = document.getElementById('sell-search-input');
                if (searchInput) {
                    searchInput.focus();
                    searchInput.select();
                }
            }, 1500);
        }

        function showTicketNotification(sale) {
            const colors = { info: 'bg-blue-500' };
            
            const notif = document.createElement('div');
            notif.id = 'ticket-notification';
            notif.className = `notification ${colors.info} text-white px-6 py-4 rounded-xl shadow-lg flex flex-col gap-2`;
            notif.style.maxWidth = '300px';
            notif.innerHTML = `
                <div class="flex items-center gap-2">
                    <i class="fas fa-receipt text-xl"></i>
                    <span class="font-bold">¬øImprimir ticket?</span>
                </div>
                <p class="text-sm opacity-90">Venta #${sale.id.slice(-4)} - $${sale.total.toFixed(2)}</p>
                <div class="flex gap-2 mt-2">
                    <button onclick="printReceiptFromNotification('${sale.id}')" class="flex-1 bg-white text-blue-600 py-2 rounded-lg font-bold text-sm hover:bg-blue-50">
                        <i class="fas fa-print"></i> Imprimir
                    </button>
                    <button onclick="closeTicketNotification()" class="flex-1 bg-blue-400 text-white py-2 rounded-lg font-bold text-sm hover:bg-blue-300">
                        Cerrar
                    </button>
                </div>
            `;
            
            document.getElementById('notifications').appendChild(notif);
            
            // Auto-cerrar despu√©s de 5 segundos
            setTimeout(() => {
                closeTicketNotification();
            }, 5000);
        }

        function closeTicketNotification() {
            const notif = document.getElementById('ticket-notification');
            if (notif) {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }
        }

        function printReceiptFromNotification(saleId) {
            const sale = appState.sales.find(s => s.id === saleId);
            if (sale) {
                printReceipt(sale);
            }
            closeTicketNotification();
        }

        function showSuccessOverlay(amount) {
            const overlay = document.getElementById('loading-overlay');
            document.getElementById('success-amount').textContent = `Total: $${amount.toFixed(2)}`;
            overlay.classList.add('active');
            
            setTimeout(() => {
                overlay.classList.remove('active');
            }, 1500);
        }

        function printReceipt(sale) {
            const receiptWindow = window.open('', '_blank');
            
            // Informaci√≥n de pago en efectivo
            const cashInfo = sale.paymentMethod === 'cash' && sale.received ? `
                <hr>
                <div style="display: flex; justify-content: space-between;">
                    <span>EFECTIVO RECIBIDO</span>
                    <span>$${sale.received.toFixed(2)}</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-weight: bold; color: green;">
                    <span>CAMBIO</span>
                    <span>$${(sale.change || 0).toFixed(2)}</span>
                </div>
            ` : `
                <hr>
                <div style="text-align: center; font-weight: bold;">
                    <span>PAGO CON TARJETA/D√âBITO</span>
                </div>
            `;
            
            receiptWindow.document.write(`
                <html>
                <head><title>Ticket ${sale.id}</title></head>
                <body style="font-family: monospace; padding: 20px; max-width: 300px;">
                    <h2 style="text-align: center;">KIOSCOPRO</h2>
                    <p style="text-align: center;">${sale.date} ${sale.time}</p>
                    <hr>
                    ${sale.items.map(item => `
                        <div style="display: flex; justify-content: space-between;">
                            <span>${item.name} x${item.quantity}</span>
                            <span>$${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                    <hr>
                    <div style="display: flex; justify-content: space-between; font-weight: bold;">
                        <span>TOTAL</span>
                        <span>$${sale.total.toFixed(2)}</span>
                    </div>
                    ${cashInfo}
                    <p style="text-align: center; margin-top: 20px;">¬°Gracias por su compra!</p>
                </body>
                </html>
            `);
            receiptWindow.print();
        }

        // ==================== INVENTORY & PURCHASES ====================
        function calculateInventoryPrice() {
            const costInput = document.getElementById('inv-cost');
            const priceInput = document.getElementById('inv-price');
            const marginInput = document.getElementById('inv-margin');
            // Normalizar: reemplazar coma por punto para parseFloat
            const cost = parseFloat(costInput.value.replace(',', '.')) || 0;
            
            // Si hay costo, recalcular autom√°ticamente el precio basado en el margen
            if (cost > 0) {
                const margin = parseFloat(marginInput.value) || appState.defaultMargin || 30;
                // F√≥rmula: Precio = Costo / (1 - margen/100)
                const price = cost / (1 - margin / 100);
                priceInput.value = price.toFixed(2);
            } else {
                priceInput.value = '';
            }
            
            calculateInventoryMargin();
        }

        function calculateInventoryPriceFromMargin() {
            const costInput = document.getElementById('inv-cost');
            const priceInput = document.getElementById('inv-price');
            const marginInput = document.getElementById('inv-margin');
            
            const cost = parseFloat(costInput.value.replace(',', '.')) || 0;
            const margin = parseFloat(marginInput.value.replace(',', '.')) || 0;
            
            if (cost > 0 && margin > 0 && margin < 100) {
                // Recalcular precio basado en el margen ingresado
                const price = cost / (1 - margin / 100);
                priceInput.value = price.toFixed(2);
            }
            
            // Actualizar display
            document.getElementById('inv-margin-display').textContent = margin.toFixed(1) + '%';
        }

        function calculateInventoryMargin() {
            const costInput = document.getElementById('inv-cost');
            const priceInput = document.getElementById('inv-price');
            const marginDisplay = document.getElementById('inv-margin-display');
            
            if (!costInput || !priceInput || !marginDisplay) return;
            
            // Normalizar: reemplazar coma por punto para parseFloat (soporte espa√±ol)
            const cost = parseFloat(costInput.value.replace(',', '.')) || 0;
            const price = parseFloat(priceInput.value.replace(',', '.')) || 0;
            
            if (cost > 0 && price > 0) {
                // F√≥rmula correcta del margen sobre venta
                // Margen = ((Precio - Costo) / Precio) * 100
                const margin = ((price - cost) / price) * 100;
                marginDisplay.textContent = `${margin.toFixed(1)}%`;
            } else if (cost > 0) {
                // Mostrar el margen que se aplicar√≠a
                marginDisplay.textContent = `${appState.defaultMargin || 30}%`;
            } else {
                marginDisplay.textContent = '0%';
            }
        }

        function preparePurchase() {
            // Normalizar: reemplazar coma por punto para parseFloat (soporte espa√±ol)
            const cost = parseFloat(document.getElementById('inv-cost').value.replace(',', '.')) || 0;
            const stock = parseInt(document.getElementById('inv-stock').value) || 0;
            const priceValue = parseFloat(document.getElementById('inv-price').value.replace(',', '.')) || 0;
            const totalCost = cost * stock;

            // Validaciones
            if (!document.getElementById('inv-name').value.trim()) {
                showNotification('Ingresa el nombre del producto', 'error');
                return;
            }
            if (cost <= 0) {
                showNotification('El costo debe ser mayor a 0', 'error');
                return;
            }
            if (stock <= 0) {
                showNotification('El stock debe ser mayor a 0', 'error');
                return;
            }
            if (priceValue <= 0) {
                showNotification('El precio de venta debe ser mayor a 0', 'error');
                return;
            }

            appState.pendingPurchase = {
                barcode: document.getElementById('inv-barcode').value || '',
                name: document.getElementById('inv-name').value.trim(),
                category: document.getElementById('inv-category').value,
                supplier: document.getElementById('inv-supplier').value || '',
                supplierPhone: document.getElementById('inv-supplier-phone').value || '',
                buyDays: getSelectedBuyDays('inv'),
                cost: cost,
                salePrice: priceValue,
                stock: stock,
                expiry: document.getElementById('inv-expiry').value || '',
                totalCost: totalCost
            };

            document.getElementById('purchase-total-amount').textContent = `$${totalCost.toFixed(2)}`;
            document.getElementById('purchase-cash-available').textContent = `$${appState.cash.toFixed(2)}`;
            document.getElementById('purchase-account-available').textContent = `$${appState.bank.toFixed(2)}`;
            
            setPurchasePayment('cash');
            document.getElementById('purchase-payment-modal').classList.add('active');
        }

        function setPurchasePayment(method) {
            appState.pendingPurchasePayment = method;
            
            document.getElementById('btn-purchase-cash').className = method === 'cash' 
                ? 'w-full p-4 rounded-xl border-2 border-green-500 bg-green-50 text-left flex items-center gap-3 transition'
                : 'w-full p-4 rounded-xl border-2 border-gray-200 hover:border-blue-400 text-left flex items-center gap-3 transition';
            
            document.getElementById('btn-purchase-account').className = method === 'account'
                ? 'w-full p-4 rounded-xl border-2 border-blue-500 bg-blue-50 text-left flex items-center gap-3 transition'
                : 'w-full p-4 rounded-xl border-2 border-gray-200 hover:border-blue-400 text-left flex items-center gap-3 transition';
        }

        function closePurchaseModal() {
            document.getElementById('purchase-payment-modal').classList.remove('active');
            appState.pendingPurchase = null;
        }

        // Funciones para manejar d√≠as de compra
        function getSelectedBuyDays(prefix) {
            const container = document.getElementById(`${prefix}-buy-days`);
            if (!container) return [];
            const selected = [];
            container.querySelectorAll('.buy-day-btn.active').forEach(btn => {
                selected.push(parseInt(btn.dataset.day));
            });
            return selected;
        }

        function toggleBuyDay(prefix, day) {
            const container = document.getElementById(`${prefix}-buy-days`);
            const btn = container.querySelector(`[data-day="${day}"]`);
            btn.classList.toggle('active');
            btn.classList.toggle('bg-purple-500');
            btn.classList.toggle('text-white');
        }

        function setBuyDays(prefix, days) {
            const container = document.getElementById(`${prefix}-buy-days`);
            if (!container) return;
            container.querySelectorAll('.buy-day-btn').forEach(btn => {
                const day = parseInt(btn.dataset.day);
                if (days && days.includes(day)) {
                    btn.classList.add('active', 'bg-purple-500', 'text-white');
                } else {
                    btn.classList.remove('active', 'bg-purple-500', 'text-white');
                }
            });
        }

        function confirmPurchase() {
            if (!appState.pendingPurchase) return;
            
            const totalCost = parseFloat(appState.pendingPurchase.totalCost) || 0;
            const method = appState.pendingPurchasePayment || 'cash';
            const currentCash = parseFloat(appState.cash) || 0;
            const currentBank = parseFloat(appState.bank) || 0;
            
            if (method === 'cash' && totalCost > currentCash) {
                showNotification(`Fondos insuficientes en caja. Necesitas: $${totalCost.toFixed(2)}, Tienes: $${currentCash.toFixed(2)}`, 'error');
                return;
            }
            if (method === 'account' && totalCost > currentBank) {
                showNotification(`Fondos insuficientes en cuenta. Necesitas: $${totalCost.toFixed(2)}, Tienes: $${currentBank.toFixed(2)}`, 'error');
                return;
            }

            if (method === 'cash') {
                appState.cash = currentCash - totalCost;
            } else {
                appState.bank = currentBank - totalCost;
            }

            // Crear producto con sistema de lotes
            const product = {
                id: 'PROD-' + Date.now(),
                barcode: appState.pendingPurchase.barcode,
                name: appState.pendingPurchase.name,
                category: appState.pendingPurchase.category,
                supplier: appState.pendingPurchase.supplier,
                supplierPhone: appState.pendingPurchase.supplierPhone,
                buyDays: appState.pendingPurchase.buyDays,
                cost: appState.pendingPurchase.cost,
                salePrice: appState.pendingPurchase.salePrice,
                min: 5, // Stock m√≠nimo por defecto
                // Sistema de lotes (batches) - cada compra es un lote
                batches: [{
                    stock: appState.pendingPurchase.stock,
                    expiry: appState.pendingPurchase.expiry,
                    dateAdded: formatDateISO(appState.activeDate)
                }],
                createdAt: new Date().toISOString(),
                lastSale: null
            };

            appState.inventory.push(product);

            // Registrar como INVERSI√ìN (no como gasto)
            appState.investments.push({
                id: 'PURCHASE-' + Date.now(),
                date: formatDateISO(appState.activeDate),
                concept: `Compra: ${product.name} (${product.stock} unidades)`,
                amount: totalCost,
                source: method,
                type: 'purchase',
                timestamp: Date.now()
            });

            saveToLocalStorage();
            
            closePurchaseModal();
            document.getElementById('add-inventory-form').reset();
            // Limpiar el display del margen y el input
            document.getElementById('inv-margin-display').textContent = `${appState.defaultMargin || 30}%`;
            document.getElementById('inv-margin').value = appState.defaultMargin || 30;
            renderAll();
            showNotification(`Producto comprado y creado exitosamente. Pagado con ${method === 'cash' ? 'Caja' : 'Cuenta'}`, 'success');
        }

        function renderInventory() {
            const search = document.getElementById('search-inventory').value.toLowerCase();
            const filtered = appState.inventory.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.barcode.includes(search)
            );

            document.getElementById('inventory-table').innerHTML = filtered.map(p => {
                // Calcular stock total desde lotes
                const totalStock = p.batches ? p.batches.reduce((sum, b) => sum + b.stock, 0) : (p.stock || 0);
                
                // Formatear lotes para mostrar
                let batchesHtml = '';
                if (p.batches && p.batches.length > 0) {
                    batchesHtml = p.batches.map((b, i) => {
                        const daysUntil = b.expiry ? Math.ceil((new Date(b.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : null;
                        let expiryClass = 'text-gray-500';
                        let expiryText = 'Sin venc.';
                        
                        if (b.expiry) {
                            if (daysUntil <= 7) expiryClass = 'text-red-600 font-bold';
                            else if (daysUntil <= 15) expiryClass = 'text-orange-600';
                            else expiryClass = 'text-green-600';
                            expiryText = `${b.expiry} (${daysUntil}d)`;
                        }
                        
                        // El primer lote es el que se est√° vendiendo (FIFO)
                        const isFirst = i === 0;
                        const badge = isFirst ? '<span class="text-xs bg-blue-100 text-blue-700 px-1 rounded mr-1">VENDER PRIMERO</span>' : '';
                        
                        return `<div class="text-xs flex justify-between items-center py-0.5 ${isFirst ? 'bg-blue-50 rounded px-1' : ''}">
                            <span>${badge}<strong>${b.stock}u</strong></span>
                            <span class="${expiryClass}">${expiryText}</span>
                        </div>`;
                    }).join('');
                } else if (p.expiry) {
                    // Compatibilidad con productos antiguos
                    const daysUntil = Math.ceil((new Date(p.expiry) - new Date()) / (1000 * 60 * 60 * 24));
                    let expiryClass = daysUntil <= 7 ? 'text-red-600 font-bold' : daysUntil <= 15 ? 'text-orange-600' : 'text-green-600';
                    batchesHtml = `<div class="text-xs flex justify-between py-0.5 bg-blue-50 rounded px-1">
                        <span><span class="text-xs bg-blue-100 text-blue-700 px-1 rounded mr-1">VENDER PRIMERO</span><strong>${totalStock}u</strong></span>
                        <span class="${expiryClass}">${p.expiry} (${daysUntil}d)</span>
                    </div>`;
                } else {
                    batchesHtml = `<div class="text-xs text-gray-500">Sin vencimiento registrado</div>`;
                }
                
                return `
                <tr class="hover:bg-gray-50">
                    <td class="px-3 py-2">
                        <div class="font-medium text-gray-900">${escapeHtml(p.name)}</div>
                        <div class="text-xs text-gray-500">${p.category}</div>
                    </td>
                    <td class="px-3 py-2 text-sm font-mono text-gray-600">${p.barcode}</td>
                    <td class="px-3 py-2">
                        <span class="px-2 py-1 rounded-full text-xs font-bold ${totalStock <= 5 ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}">
                            ${totalStock}
                        </span>
                    </td>
                    <td class="px-3 py-2 text-sm">${batchesHtml}</td>
                    <td class="px-3 py-2 text-sm text-gray-600">$${p.cost.toFixed(2)}</td>
                    <td class="px-3 py-2 text-sm font-bold text-green-600">$${p.salePrice.toFixed(2)}</td>
                    <td class="px-3 py-2">
                        <button onclick="openAddStockModal('${p.id}')" class="text-blue-600 hover:text-blue-800 mr-2" title="Agregar stock">
                            <i class="fas fa-plus-circle"></i>
                        </button>
                        <button onclick="openEditProductModal('${p.id}')" class="text-gray-600 hover:text-gray-800" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                    </td>
                </tr>
            `}).join('');

            updateInventoryValues();
        }

        function updateInventoryValues() {
            try {
                // Asegurar que inventory sea un array
                const inventory = Array.isArray(appState.inventory) ? appState.inventory : [];
                
                const costValue = inventory.reduce((sum, p) => {
                    const cost = parseFloat(p.cost) || 0;
                    // Calcular stock desde lotes si existen, sino usar stock directo
                    const stock = p.batches ? p.batches.reduce((s, b) => s + (b.stock || 0), 0) : (parseInt(p.stock) || 0);
                    return sum + (cost * stock);
                }, 0);
                
                const saleValue = inventory.reduce((sum, p) => {
                    const salePrice = parseFloat(p.salePrice) || 0;
                    const stock = p.batches ? p.batches.reduce((s, b) => s + (b.stock || 0), 0) : (parseInt(p.stock) || 0);
                    return sum + (salePrice * stock);
                }, 0);
                
                // Actualizar elementos del sidebar
                const inventoryCostAmount = document.getElementById('inventory-cost-amount');
                const inventorySaleAmount = document.getElementById('inventory-sale-amount');
                
                if (inventoryCostAmount) inventoryCostAmount.textContent = `$${costValue.toFixed(0)} costo`;
                if (inventorySaleAmount) inventorySaleAmount.textContent = `$${saleValue.toFixed(0)} venta`;
                
                // Actualizar elementos en la p√°gina de inventario si existen
                const inventoryValueCost = document.getElementById('inventory-value-cost');
                const inventoryValueSale = document.getElementById('inventory-value-sale');
                const inventoryPotentialProfit = document.getElementById('inventory-potential-profit');
                
                if (inventoryValueCost) inventoryValueCost.textContent = `$${costValue.toFixed(2)}`;
                if (inventoryValueSale) inventoryValueSale.textContent = `$${saleValue.toFixed(2)}`;
                if (inventoryPotentialProfit) inventoryPotentialProfit.textContent = `$${(saleValue - costValue).toFixed(2)}`;
                
            } catch (e) {
                console.error('Error en updateInventoryValues:', e);
            }
        }

        let addStockPaymentMethod = 'cash';
        let currentAddStockProduct = null;

        function openAddStockModal(productId) {
            const product = appState.inventory.find(p => p.id === productId);
            if (!product) return;
            
            currentAddStockProduct = product;
            addStockPaymentMethod = 'cash'; // Default
            
            // Calcular d√≠as hasta el vencimiento actual
            let expiryInfo = '';
            let expiryClass = 'text-gray-500';
            if (product.expiry) {
                const today = new Date();
                const expiryDate = new Date(product.expiry);
                const daysUntil = Math.ceil((expiryDate - today) / (1000 * 60 * 60 * 24));
                
                if (daysUntil <= 7) expiryClass = 'text-red-600 font-bold';
                else if (daysUntil <= 15) expiryClass = 'text-orange-600 font-bold';
                else expiryClass = 'text-green-600';
                
                expiryInfo = `<p class="text-sm ${expiryClass}">üìÖ Vencimiento actual: ${product.expiry} (${daysUntil} d√≠as)</p>`;
            } else {
                expiryInfo = `<p class="text-sm text-orange-600 font-bold">‚ö†Ô∏è Sin vencimiento registrado</p>`;
            }
            
            // Calcular stock total desde lotes
            const totalStock = product.batches ? product.batches.reduce((sum, b) => sum + b.stock, 0) : (product.stock || 0);
            
            document.getElementById('add-stock-product-info').innerHTML = `
                <p class="font-bold text-gray-800">${product.name}</p>
                <p class="text-sm text-gray-500">Stock total: <strong>${totalStock}</strong> unidades</p>
                <p class="text-sm text-gray-500">Costo unitario: $${product.cost.toFixed(2)}</p>
                ${expiryInfo}
            `;
            
            // Actualizar disponibles
            document.getElementById('addstock-cash-available').textContent = appState.cash.toFixed(0);
            document.getElementById('addstock-account-available').textContent = appState.bank.toFixed(0);
            
            document.getElementById('add-stock-qty').value = 1;
            updateAddStockCost();
            setAddStockPayment('cash');
            
            // Mostrar precio actual y resetear campo de nuevo precio
            document.getElementById('add-stock-current-price').textContent = `$${product.salePrice.toFixed(2)}`;
            document.getElementById('add-stock-new-price').value = '';
            document.getElementById('add-stock-new-price').placeholder = product.salePrice.toFixed(2);
            
            // Mostrar informaci√≥n de lotes existentes
            let batchesInfo = '';
            if (product.batches && product.batches.length > 0) {
                batchesInfo = '<div class="mt-2 text-xs"><p class="font-bold text-gray-600 mb-1">Lotes existentes:</p>' + 
                    product.batches.map((b, i) => {
                        const daysUntil = b.expiry ? Math.ceil((new Date(b.expiry) - new Date()) / (1000 * 60 * 60 * 24)) : 'N/A';
                        return `<div class="flex justify-between text-gray-500"><span>Lote ${i+1}: ${b.stock}u</span><span>${b.expiry || 'Sin venc.'} (${daysUntil}d)</span></div>`;
                    }).join('') + '</div>';
            }
            
            document.getElementById('add-stock-product-info').innerHTML += batchesInfo;
            
            // Inicializar campo de vencimiento vac√≠o para nuevo lote
            document.getElementById('add-stock-expiry').value = '';
            
            document.getElementById('add-stock-modal').dataset.productId = productId;
            document.getElementById('add-stock-modal').classList.add('active');
        }

        function updateAddStockCost() {
            if (!currentAddStockProduct) return;
            
            const qty = parseInt(document.getElementById('add-stock-qty').value) || 0;
            const totalCost = qty * currentAddStockProduct.cost;
            document.getElementById('add-stock-total-cost').textContent = `$${totalCost.toFixed(2)}`;
        }

        function setAddStockPayment(method) {
            addStockPaymentMethod = method;
            
            document.getElementById('btn-addstock-cash').className = method === 'cash'
                ? 'flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
            document.getElementById('btn-addstock-account').className = method === 'account'
                ? 'flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
        }

        function closeAddStockModal() {
            document.getElementById('add-stock-modal').classList.remove('active');
            currentAddStockProduct = null;
        }

        function handleAddStockKeypress(e) {
            if (e.key === 'Enter') {
                executeAddStock();
            }
        }

        // Funci√≥n auxiliar para obtener stock total de un producto (desde lotes o stock directo)
        function getProductStock(product) {
            if (!product) return 0;
            if (product.batches && product.batches.length > 0) {
                return product.batches.reduce((sum, b) => sum + (b.stock || 0), 0);
            }
            return parseInt(product.stock) || 0;
        }

        function executeAddStock() {
            const productId = document.getElementById('add-stock-modal').dataset.productId;
            const qty = parseInt(document.getElementById('add-stock-qty').value);
            const newExpiry = document.getElementById('add-stock-expiry').value;
            
            const product = appState.inventory.find(p => p.id === productId);
            if (!product || qty <= 0) {
                showNotification('Cantidad inv√°lida', 'error');
                return;
            }
            
            const totalCost = qty * product.cost;
            
            // Verificar si hay un nuevo precio de venta
            const newPriceInput = document.getElementById('add-stock-new-price').value;
            const newPrice = newPriceInput ? parseFloat(newPriceInput) : null;
            
            // Verificar fondos
            if (addStockPaymentMethod === 'cash' && totalCost > appState.cash) {
                showNotification(`Fondos insuficientes en caja. Necesitas: $${totalCost.toFixed(2)}`, 'error');
                return;
            }
            if (addStockPaymentMethod === 'account' && totalCost > appState.bank) {
                showNotification(`Fondos insuficientes en cuenta. Necesitas: $${totalCost.toFixed(2)}`, 'error');
                return;
            }
            
            // Descontar dinero
            if (addStockPaymentMethod === 'cash') {
                appState.cash -= totalCost;
            } else {
                appState.bank -= totalCost;
            }
            
            // Agregar nuevo lote
            if (!product.batches) {
                // Migraci√≥n: si el producto no tiene lotes, crear el primer lote con el stock actual
                product.batches = [{
                    stock: 0,
                    expiry: '',
                    dateAdded: formatDateISO(appState.activeDate)
                }];
            }
            
            // Agregar nuevo lote
            product.batches.push({
                stock: qty,
                expiry: newExpiry || '',
                dateAdded: formatDateISO(appState.activeDate)
            });
            
            // Ordenar lotes por vencimiento (FIFO - el que vence primero, primero en la lista)
            product.batches.sort((a, b) => {
                if (!a.expiry) return 1;
                if (!b.expiry) return -1;
                return new Date(a.expiry) - new Date(b.expiry);
            });
            
            // Aplicar nuevo precio si se proporcion√≥ (ajuste por inflaci√≥n)
            let priceUpdated = false;
            if (newPrice && newPrice > 0 && newPrice !== product.salePrice) {
                const oldPrice = product.salePrice;
                product.salePrice = newPrice;
                priceUpdated = true;
            }
            
            // Registrar como INVERSI√ìN (no como gasto)
            appState.investments.push({
                id: 'RESTOCK-' + Date.now(),
                date: formatDateISO(appState.activeDate),
                concept: `Reposici√≥n: ${product.name} (+${qty} unidades)${newExpiry ? ' Venc: ' + newExpiry : ''}`,
                amount: totalCost,
                source: addStockPaymentMethod,
                type: 'restock',
                timestamp: Date.now()
            });
            
            saveToLocalStorage();
            renderAll();
            closeAddStockModal();
            
            // Construir mensaje de notificaci√≥n
            let message = `Nuevo lote agregado: ${product.name} (+${qty}). Total lotes: ${product.batches.length}. Pagado con ${addStockPaymentMethod === 'cash' ? 'Caja' : 'Cuenta'}`;
            if (newExpiry) {
                message += `. üìÖ Vencimiento: ${newExpiry}`;
            }
            if (priceUpdated) {
                message += `. üí∞ Precio actualizado: $${product.salePrice.toFixed(2)}`;
            }
            
            showNotification(message, 'success');
        }

        function openEditProductModal(productId) {
            const product = appState.inventory.find(p => p.id === productId);
            if (!product) return;

            const totalStock = getProductStock(product);
            
            document.getElementById('edit-prod-name').value = product.name || '';
            document.getElementById('edit-prod-barcode').value = product.barcode || '';
            document.getElementById('edit-prod-cost').value = product.cost || 0;
            document.getElementById('edit-prod-price').value = product.salePrice || 0;
            document.getElementById('edit-prod-stock').value = totalStock;
            document.getElementById('edit-prod-category').value = product.category || 'snacks';
            // Mostrar el vencimiento del primer lote (FIFO) o del producto
            const firstExpiry = product.batches && product.batches.length > 0 
                ? product.batches[0].expiry 
                : product.expiry;
            document.getElementById('edit-prod-expiry').value = firstExpiry || '';
            document.getElementById('edit-prod-min').value = product.min || 10;
            document.getElementById('edit-prod-supplier').value = product.supplier || '';
            document.getElementById('edit-prod-supplier-phone').value = product.supplierPhone || '';
            
            // Cargar d√≠as de compra
            setBuyDays('edit', product.buyDays || []);
            
            // Calcular margen inicial
            calculateEditMargin();
            
            document.getElementById('edit-product-modal').dataset.productId = productId;
            document.getElementById('edit-product-modal').classList.add('active');
        }

        function calculateEditPrice() {
            const costInput = document.getElementById('edit-prod-cost');
            const priceInput = document.getElementById('edit-prod-price');
            const marginInput = document.getElementById('edit-prod-margin');
            const cost = parseFloat(costInput.value.replace(',', '.')) || 0;
            
            // Si hay costo, recalcular autom√°ticamente el precio
            if (cost > 0) {
                const margin = appState.defaultMargin || 30;
                // F√≥rmula: Precio = Costo / (1 - margen/100)
                const price = cost / (1 - margin / 100);
                priceInput.value = price.toFixed(2);
                marginInput.value = margin.toFixed(1);
            }
            
            calculateEditMargin();
        }

        function calculateEditPriceFromMargin() {
            const costInput = document.getElementById('edit-prod-cost');
            const priceInput = document.getElementById('edit-prod-price');
            const marginInput = document.getElementById('edit-prod-margin');
            
            const cost = parseFloat(costInput.value.replace(',', '.')) || 0;
            const margin = parseFloat(marginInput.value.replace(',', '.')) || 0;
            
            if (cost > 0 && margin > 0 && margin < 100) {
                // Recalcular precio basado en el margen ingresado
                const price = cost / (1 - margin / 100);
                priceInput.value = price.toFixed(2);
            }
        }

        function calculateEditMargin() {
            // Normalizar: reemplazar coma por punto para parseFloat (soporte espa√±ol)
            const cost = parseFloat(document.getElementById('edit-prod-cost').value.replace(',', '.')) || 0;
            const price = parseFloat(document.getElementById('edit-prod-price').value.replace(',', '.')) || 0;
            
            if (cost > 0 && price > 0) {
                // F√≥rmula correcta del margen sobre venta
                const margin = ((price - cost) / price) * 100;
                document.getElementById('edit-prod-margin').value = margin.toFixed(1);
            } else {
                document.getElementById('edit-prod-margin').value = '0';
            }
        }

        function closeEditProductModal() {
            document.getElementById('edit-product-modal').classList.remove('active');
        }

        function saveProductEdit() {
            const productId = document.getElementById('edit-product-modal').dataset.productId;
            const product = appState.inventory.find(p => p.id === productId);
            
            if (product) {
                const newStock = parseInt(document.getElementById('edit-prod-stock').value) || 0;
                const currentStock = getProductStock(product);
                
                product.name = document.getElementById('edit-prod-name').value.trim();
                product.barcode = document.getElementById('edit-prod-barcode').value.trim();
                product.cost = parseFloat(document.getElementById('edit-prod-cost').value) || 0;
                product.salePrice = parseFloat(document.getElementById('edit-prod-price').value) || 0;
                product.category = document.getElementById('edit-prod-category').value;
                product.min = parseInt(document.getElementById('edit-prod-min').value) || 10;
                product.supplier = document.getElementById('edit-prod-supplier').value.trim();
                product.supplierPhone = document.getElementById('edit-prod-supplier-phone').value.trim();
                product.buyDays = getSelectedBuyDays('edit');
                
                // Actualizar lotes si el stock cambi√≥
                if (newStock !== currentStock) {
                    const diff = newStock - currentStock;
                    if (diff > 0) {
                        // Agregar stock al primer lote o crear uno nuevo
                        if (!product.batches || product.batches.length === 0) {
                            product.batches = [{
                                stock: newStock,
                                expiry: document.getElementById('edit-prod-expiry').value || '',
                                dateAdded: formatDateISO(appState.activeDate)
                            }];
                        } else {
                            product.batches[0].stock += diff;
                            // Actualizar vencimiento del primer lote
                            const newExpiry = document.getElementById('edit-prod-expiry').value;
                            if (newExpiry) {
                                product.batches[0].expiry = newExpiry;
                            }
                        }
                    } else if (diff < 0) {
                        // Reducir stock del primer lote
                        if (product.batches && product.batches.length > 0) {
                            product.batches[0].stock = Math.max(0, product.batches[0].stock + diff);
                            // Eliminar lotes vac√≠os
                            product.batches = product.batches.filter(b => b.stock > 0);
                        }
                    }
                    // Actualizar stock total
                    product.stock = getProductStock(product);
                }
                
                // Actualizar vencimiento del producto (compatibilidad)
                const newExpiry = document.getElementById('edit-prod-expiry').value;
                if (newExpiry) {
                    product.expiry = newExpiry;
                    if (product.batches && product.batches.length > 0) {
                        product.batches[0].expiry = newExpiry;
                    }
                }
                
                saveToLocalStorage();
                renderInventory();
                closeEditProductModal();
                showNotification('Producto actualizado correctamente', 'success');
            }
        }

        function filterQuickStockProducts() {
            const search = document.getElementById('quick-stock-search').value.toLowerCase().trim();
            if (!search) {
                document.getElementById('quick-stock-results').innerHTML = '<p class="text-gray-400 text-center py-4 col-span-3">Escribe para buscar productos</p>';
                return;
            }
            
            // Buscar por nombre o c√≥digo
            const results = appState.inventory.filter(p => 
                p.name.toLowerCase().includes(search) || 
                p.barcode.toLowerCase().includes(search)
            ).slice(0, 6);

            document.getElementById('quick-stock-results').innerHTML = results.map(p => {
                const stock = getProductStock(p);
                const isExactBarcode = p.barcode.toLowerCase() === search;
                return `
                <div class="bg-white border-2 ${isExactBarcode ? 'border-blue-500 bg-blue-50' : 'border-gray-200'} rounded-lg p-3 cursor-pointer hover:shadow-md transition" onclick="openAddStockModal('${p.id}'); document.getElementById('quick-stock-search').value=''; document.getElementById('quick-stock-results').innerHTML='<p class=\\'text-gray-400 text-center py-4 col-span-3\\'>Escribe para buscar productos</p>';">
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${p.name}</p>
                            <p class="text-xs text-gray-500">Stock: ${stock} | C√≥digo: ${p.barcode || 'Sin c√≥digo'}</p>
                        </div>
                        <span class="bg-blue-100 text-blue-700 text-xs px-2 py-1 rounded-full">+ Stock</span>
                    </div>
                </div>
            `}).join('') || '<p class="text-gray-400 text-center py-4 col-span-3">No se encontraron productos</p>';
        }

        function handleQuickStockKeypress(e) {
            if (e.key === 'Enter') {
                const search = e.target.value.trim().toLowerCase();
                
                // Primero intentar encontrar por c√≥digo exacto
                const productByBarcode = appState.inventory.find(p => p.barcode.toLowerCase() === search);
                if (productByBarcode) {
                    openAddStockModal(productByBarcode.id);
                    e.target.value = '';
                    document.getElementById('quick-stock-results').innerHTML = '<p class="text-gray-400 text-center py-4 col-span-3">Escribe para buscar productos</p>';
                    return;
                }
                
                // Si no es c√≥digo exacto, ver si hay un solo resultado en la b√∫squeda
                const results = appState.inventory.filter(p => 
                    p.name.toLowerCase().includes(search) || 
                    p.barcode.toLowerCase().includes(search)
                );
                
                if (results.length === 1) {
                    openAddStockModal(results[0].id);
                    e.target.value = '';
                    document.getElementById('quick-stock-results').innerHTML = '<p class="text-gray-400 text-center py-4 col-span-3">Escribe para buscar productos</p>';
                } else if (results.length === 0) {
                    showNotification('Producto no encontrado', 'error');
                } else {
                    showNotification(`${results.length} productos encontrados. Haz clic en el correcto.`, 'info');
                }
            }
        }

        // ==================== CALENDAR & SALES HISTORY ====================
        function renderCalendar() {
            const year = appState.calendarMonth.getFullYear();
            const month = appState.calendarMonth.getMonth();
            
            document.getElementById('calendar-month-year').textContent = 
                new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            let html = '';
            
            for (let i = 0; i < firstDay; i++) {
                html += '<div class="calendar-day bg-gray-50 rounded-lg"></div>';
            }
            
            const today = new Date();
            for (let day = 1; day <= daysInMonth; day++) {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const daySales = appState.sales.filter(s => s.date === dateStr);
                const dayExpenses = appState.expenses.filter(e => e.date === dateStr);
                const dayInvestments = appState.investments.filter(i => i.date === dateStr);
                const totalSales = daySales.reduce((sum, s) => sum + s.total, 0);
                const totalExpenses = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
                const totalInvestments = dayInvestments.reduce((sum, i) => sum + i.amount, 0);
                const balance = totalSales - totalExpenses - totalInvestments;
                
                const isToday = today.toDateString() === new Date(year, month, day).toDateString();
                const isSelected = selectedCalendarDate === dateStr;
                const hasActivity = daySales.length > 0 || dayExpenses.length > 0 || dayInvestments.length > 0;
                
                let indicator = '';
                if (daySales.length > 0) {
                    indicator += `<span class="text-xs ${isSelected ? 'bg-white text-purple-600' : 'bg-green-500 text-white'} rounded-full w-5 h-5 flex items-center justify-center font-bold">${daySales.length}</span>`;
                }
                if (dayExpenses.length > 0) {
                    indicator += `<span class="text-xs ${isSelected ? 'bg-white text-red-600' : 'bg-red-500 text-white'} rounded-full w-5 h-5 flex items-center justify-center ml-1 font-bold">${dayExpenses.length}</span>`;
                }
                if (dayInvestments.length > 0) {
                    indicator += `<span class="text-xs ${isSelected ? 'bg-white text-blue-600' : 'bg-blue-500 text-white'} rounded-full w-5 h-5 flex items-center justify-center ml-1 font-bold">${dayInvestments.length}</span>`;
                }
                
                html += `
                    <div class="calendar-day rounded-lg p-2 border-2 ${isSelected ? 'calendar-selected' : 'bg-white border-gray-200'} ${isToday && !isSelected ? 'calendar-today' : ''} hover:shadow-lg cursor-pointer transition-all" 
                         onclick="selectCalendarDate('${dateStr}')">
                        <div class="flex justify-between items-start mb-1">
                            <span class="font-bold ${isSelected ? 'text-white' : (isToday ? 'text-purple-600' : 'text-gray-700')}">${day}</span>
                            <div class="flex">${indicator}</div>
                        </div>
                        ${daySales.length > 0 ? `<p class="text-xs font-bold ${isSelected ? 'text-white' : 'text-green-600'}">+$${totalSales.toFixed(0)}</p>` : ''}
                        ${dayExpenses.length > 0 ? `<p class="text-xs font-bold ${isSelected ? 'text-white' : 'text-red-600'}">-$${totalExpenses.toFixed(0)}</p>` : ''}
                        ${dayInvestments.length > 0 ? `<p class="text-xs font-bold ${isSelected ? 'text-white' : 'text-blue-600'}">üì¶ $${totalInvestments.toFixed(0)}</p>` : ''}
                        ${hasActivity ? `<p class="text-xs font-bold ${isSelected ? 'text-white' : (balance >= 0 ? 'text-blue-600' : 'text-orange-600')}">=${balance.toFixed(0)}</p>` : `<p class="text-xs ${isSelected ? 'text-white' : 'text-gray-300'}">-</p>`}
                    </div>
                `;
            }
            
            document.getElementById('calendar-grid').innerHTML = html;
        }

        function changeCalendarMonth(delta) {
            appState.calendarMonth.setMonth(appState.calendarMonth.getMonth() + delta);
            selectedCalendarDate = null; // Limpiar selecci√≥n al cambiar de mes
            renderCalendar();
        }

        let currentDayTab = 'sales';
        let selectedCalendarDate = null;

        function showDayTab(tab) {
            currentDayTab = tab;
            
            document.getElementById('tab-sales').className = tab === 'sales' 
                ? 'px-4 py-2 font-bold text-purple-600 border-b-2 border-purple-600'
                : 'px-4 py-2 font-bold text-gray-500';
            document.getElementById('tab-expenses').className = tab === 'expenses'
                ? 'px-4 py-2 font-bold text-red-600 border-b-2 border-red-600'
                : 'px-4 py-2 font-bold text-gray-500';
            document.getElementById('tab-investments').className = tab === 'investments'
                ? 'px-4 py-2 font-bold text-blue-600 border-b-2 border-blue-600'
                : 'px-4 py-2 font-bold text-gray-500';
            
            document.getElementById('day-sales-list').classList.toggle('hidden', tab !== 'sales');
            document.getElementById('day-expenses-list').classList.toggle('hidden', tab !== 'expenses');
            document.getElementById('day-investments-list').classList.toggle('hidden', tab !== 'investments');
        }

        function selectCalendarDate(dateStr) {
            selectedCalendarDate = dateStr;
            renderCalendar(); // Re-renderizar para mostrar el d√≠a seleccionado
            showDayDetail(dateStr);
        }

        function showDayDetail(dateStr) {
            // Actualizar la fecha activa al d√≠a seleccionado
            appState.activeDate = new Date(dateStr);
            updateDateDisplay();
            
            const daySales = appState.sales.filter(s => s.date === dateStr);
            const dayExpenses = appState.expenses.filter(e => e.date === dateStr);
            const dayInvestments = appState.investments.filter(i => i.date === dateStr);
            const totalSales = daySales.reduce((sum, s) => sum + s.total, 0);
            const totalExpenses = dayExpenses.reduce((sum, e) => sum + e.amount, 0);
            const totalInvestments = dayInvestments.reduce((sum, i) => sum + i.amount, 0);
            const profit = daySales.reduce((sum, s) => sum + s.profit, 0);
            const items = daySales.reduce((sum, s) => sum + s.items.length, 0);
            const balance = totalSales - totalExpenses - totalInvestments;

            document.getElementById('day-detail').classList.remove('hidden');
            document.getElementById('day-detail-title').textContent = `Movimientos del ${new Date(dateStr).toLocaleDateString('es-ES')}`;
            document.getElementById('day-detail-total').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('day-detail-total').className = `text-2xl font-bold ${balance >= 0 ? 'text-green-600' : 'text-red-600'}`;
            
            document.getElementById('day-metric-sales').textContent = daySales.length;
            document.getElementById('day-metric-income').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('day-metric-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('day-metric-investments').textContent = `$${totalInvestments.toFixed(2)}`;
            document.getElementById('day-metric-items').textContent = items;
            document.getElementById('day-metric-balance').textContent = `$${balance.toFixed(2)}`;
            document.getElementById('day-metric-balance').className = `text-2xl font-bold ${balance >= 0 ? 'text-green-800' : 'text-red-800'}`;
            
            document.getElementById('day-expense-count').textContent = dayExpenses.length;
            document.getElementById('day-investment-count').textContent = dayInvestments.length;

            document.getElementById('day-sales-list').innerHTML = daySales.length > 0 ? daySales.map(sale => `
                <div class="sale-item flex justify-between items-center p-3 rounded-lg border">
                    <div class="flex-1 cursor-pointer" onclick="showSaleDetail('${sale.id}')">
                        <p class="font-bold text-gray-800">Venta #${sale.id.slice(-4)}</p>
                        <p class="text-sm text-gray-500">${sale.time} ‚Ä¢ ${sale.items.length} items ‚Ä¢ ${sale.paymentMethod === 'cash' ? 'üíµ' : 'üí≥'}</p>
                    </div>
                    <div class="text-right mr-4">
                        <p class="font-bold text-green-600">+$${sale.total.toFixed(2)}</p>
                        <p class="text-xs text-gray-400">Ganancia: $${sale.profit.toFixed(2)}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="editSale('${sale.id}')" class="text-blue-600 hover:text-blue-800" title="Editar venta">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="deleteSale('${sale.id}')" class="text-red-600 hover:text-red-800" title="Eliminar venta">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('') : '<p class="text-center text-gray-400 py-4">No hay ventas este d√≠a</p>';

            document.getElementById('day-expenses-list').innerHTML = dayExpenses.length > 0 ? dayExpenses.map(expense => `
                <div class="sale-item flex justify-between items-center p-3 rounded-lg border bg-red-50">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800">${expense.concept}</p>
                        <p class="text-sm text-gray-500">${new Date(expense.timestamp).toLocaleTimeString('es-ES')} ‚Ä¢ ${expense.source === 'cash' ? 'üíµ Caja' : expense.source === 'bank' ? 'üè¶ Cuenta' : 'üì¶ Compra'}</p>
                    </div>
                    <div class="text-right mr-3">
                        <p class="font-bold text-red-600">-$${expense.amount.toFixed(2)}</p>
                    </div>
                    <button onclick="deleteExpense('${expense.id}', '${dateStr}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-100 rounded-lg" title="Eliminar gasto">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('') : '<p class="text-center text-gray-400 py-4">No hay gastos este d√≠a</p>';
            
            document.getElementById('day-investments-list').innerHTML = dayInvestments.length > 0 ? dayInvestments.map(inv => `
                <div class="sale-item flex justify-between items-center p-3 rounded-lg border bg-blue-50">
                    <div class="flex-1">
                        <p class="font-bold text-gray-800">üì¶ ${inv.concept}</p>
                        <p class="text-sm text-gray-500">${new Date(inv.timestamp).toLocaleTimeString('es-ES')} ‚Ä¢ ${inv.source === 'cash' ? 'üíµ Caja' : inv.source === 'bank' ? 'üè¶ Cuenta' : 'üì¶ Compra'} ‚Ä¢ INVERSI√ìN</p>
                    </div>
                    <div class="text-right mr-3">
                        <p class="font-bold text-blue-600">-$${inv.amount.toFixed(2)}</p>
                    </div>
                    <button onclick="deleteInvestment('${inv.id}', '${dateStr}')" class="text-red-500 hover:text-red-700 p-2 hover:bg-red-100 rounded-lg" title="Eliminar inversi√≥n">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            `).join('') : '<p class="text-center text-gray-400 py-4">No hay inversiones este d√≠a</p>';
            
            showDayTab('sales');
            
            // Hacer scroll al detalle del d√≠a
            setTimeout(() => {
                const dayDetail = document.getElementById('day-detail');
                if (dayDetail) {
                    dayDetail.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            }, 100);
        }

        function deleteSale(saleId) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta venta? Se revertir√° el stock y el dinero.')) return;

            const saleIndex = appState.sales.findIndex(s => s.id === saleId);
            if (saleIndex === -1) return;

            const sale = appState.sales[saleIndex];

            sale.items.forEach(item => {
                const product = appState.inventory.find(p => p.id === item.productId);
                if (product) {
                    // Agregar al primer lote (FIFO) o crear uno nuevo
                    if (!product.batches) {
                        product.batches = [{
                            stock: item.quantity,
                            expiry: '',
                            dateAdded: formatDateISO(appState.activeDate)
                        }];
                    } else if (product.batches.length > 0) {
                        // Agregar al primer lote (el m√°s viejo)
                        product.batches[0].stock += item.quantity;
                    } else {
                        // Crear nuevo lote
                        product.batches.push({
                            stock: item.quantity,
                            expiry: '',
                            dateAdded: formatDateISO(appState.activeDate)
                        });
                    }
                    // Actualizar stock total para compatibilidad
                    product.stock = getProductStock(product);
                }
            });

            if (sale.paymentMethod === 'cash') {
                appState.cash -= sale.total;
            } else if (sale.paymentMethod === 'debit') {
                appState.bank -= sale.total;
            }

            appState.sales.splice(saleIndex, 1);

            saveToLocalStorage();
            renderAll();
            renderCalendar();
            
            const dayDetail = document.getElementById('day-detail');
            if (!dayDetail.classList.contains('hidden')) {
                showDayDetail(sale.date);
            }
            
            showNotification('Venta eliminada correctamente', 'success');
        }

        function deleteExpense(expenseId, dateStr) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar este gasto? Se devolver√° el dinero.')) return;

            const expenseIndex = appState.expenses.findIndex(e => e.id === expenseId);
            if (expenseIndex === -1) return;

            const expense = appState.expenses[expenseIndex];

            // Devolver el dinero seg√∫n la fuente
            if (expense.source === 'cash') {
                appState.cash += expense.amount;
            } else if (expense.source === 'bank') {
                appState.bank += expense.amount;
            }

            // Eliminar el gasto
            appState.expenses.splice(expenseIndex, 1);

            saveToLocalStorage();
            renderAll();
            renderCalendar();
            
            // Refrescar el detalle del d√≠a si est√° visible
            const dayDetail = document.getElementById('day-detail');
            if (!dayDetail.classList.contains('hidden')) {
                showDayDetail(dateStr);
                // Mantener la pesta√±a de gastos activa
                showDayTab('expenses');
            }
            
            showNotification('Gasto eliminado correctamente', 'success');
        }

        function deleteInvestment(investmentId, dateStr) {
            if (!confirm('¬øEst√°s seguro de que deseas eliminar esta inversi√≥n? Se devolver√° el dinero y se reducir√° el stock del producto.')) return;

            const investmentIndex = appState.investments.findIndex(i => i.id === investmentId);
            if (investmentIndex === -1) return;

            const investment = appState.investments[investmentIndex];

            // Devolver el dinero seg√∫n la fuente
            if (investment.source === 'cash') {
                appState.cash += investment.amount;
            } else if (investment.source === 'bank') {
                appState.bank += investment.amount;
            }

            // Buscar el producto y reducir el stock
            const product = appState.inventory.find(p => investment.concept.includes(p.name));
            if (product && product.batches && product.batches.length > 0) {
                // Eliminar el √∫ltimo lote (el m√°s reciente)
                product.batches.pop();
                // Si no quedan lotes, eliminar el producto
                if (product.batches.length === 0) {
                    const productIndex = appState.inventory.findIndex(p => p.id === product.id);
                    if (productIndex !== -1) {
                        appState.inventory.splice(productIndex, 1);
                    }
                }
            }

            // Eliminar la inversi√≥n
            appState.investments.splice(investmentIndex, 1);

            saveToLocalStorage();
            renderAll();
            renderCalendar();
            
            // Refrescar el detalle del d√≠a si est√° visible
            const dayDetail = document.getElementById('day-detail');
            if (!dayDetail.classList.contains('hidden')) {
                showDayDetail(dateStr);
                // Mantener la pesta√±a de inversiones activa
                showDayTab('investments');
            }
            
            showNotification('Inversi√≥n eliminada correctamente', 'success');
        }

        function editSale(saleId) {
            const sale = appState.sales.find(s => s.id === saleId);
            if (!sale) return;

            sale.items.forEach(item => {
                const product = appState.inventory.find(p => p.id === item.productId);
                if (product) {
                    // Devolver stock al primer lote
                    if (!product.batches) {
                        product.batches = [{
                            stock: item.quantity,
                            expiry: '',
                            dateAdded: formatDateISO(appState.activeDate)
                        }];
                    } else if (product.batches.length > 0) {
                        product.batches[0].stock += item.quantity;
                    } else {
                        product.batches.push({
                            stock: item.quantity,
                            expiry: '',
                            dateAdded: formatDateISO(appState.activeDate)
                        });
                    }
                    product.stock = getProductStock(product);
                }
            });

            if (sale.paymentMethod === 'cash') {
                appState.cash -= sale.total;
            } else if (sale.paymentMethod === 'debit') {
                appState.bank -= sale.total;
            }

            appState.cart = sale.items.map(item => ({
                productId: item.productId,
                name: item.name,
                price: item.price,
                cost: item.cost,
                quantity: item.quantity
            }));

            const saleIndex = appState.sales.findIndex(s => s.id === saleId);
            appState.sales.splice(saleIndex, 1);

            saveToLocalStorage();
            showSection('sell');
            renderCart();
            showNotification('Venta cargada para editar. Completa la venta nuevamente.', 'info');
        }

        function showSaleDetail(saleId) {
            const sale = appState.sales.find(s => s.id === saleId);
            if (!sale) return;

            document.getElementById('sale-detail-content').innerHTML = `
                <div class="mb-4">
                    <p class="text-sm text-gray-500">Venta #${sale.id}</p>
                    <p class="text-lg font-bold">${sale.date} ${sale.time}</p>
                </div>
                <div class="space-y-2 mb-4">
                    ${sale.items.map(item => `
                        <div class="flex justify-between p-2 bg-gray-50 rounded">
                            <span>${item.name} x${item.quantity}</span>
                            <span class="font-bold">$${(item.price * item.quantity).toFixed(2)}</span>
                        </div>
                    `).join('')}
                </div>
                <div class="border-t pt-4">
                    <div class="flex justify-between text-lg font-bold">
                        <span>Total:</span>
                        <span class="text-green-600">$${sale.total.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500 mt-2">
                        <span>Ganancia:</span>
                        <span>$${sale.profit.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between text-sm text-gray-500">
                        <span>M√©todo:</span>
                        <span>${sale.paymentMethod === 'cash' ? 'Efectivo' : 'D√©bito'}</span>
                    </div>
                </div>
                <div class="flex gap-2 mt-4">
                    <button onclick="editSale('${sale.id}'); closeSaleDetail();" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-2 rounded-lg font-bold">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                    <button onclick="deleteSale('${sale.id}'); closeSaleDetail();" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 rounded-lg font-bold">
                        <i class="fas fa-trash"></i> Eliminar
                    </button>
                    <button onclick="closeSaleDetail()" class="flex-1 bg-gray-200 hover:bg-gray-300 py-2 rounded-lg font-bold">
                        Cerrar
                    </button>
                </div>
            `;
            document.getElementById('sale-detail-modal').classList.add('active');
        }

        function closeSaleDetail() {
            document.getElementById('sale-detail-modal').classList.remove('active');
        }

        // ==================== CASHFLOW ====================
        function renderCashflow() {
            document.getElementById('cashflow-cash').textContent = `$${appState.cash.toFixed(2)}`;
            document.getElementById('cashflow-bank').textContent = `$${appState.bank.toFixed(2)}`;
            updateInventoryValues();
            
            const today = formatDateISO(appState.activeDate);
            const currentMonth = today.slice(0, 7);
            
            const todayExpenses = appState.expenses.filter(e => e.date === today).reduce((sum, e) => sum + e.amount, 0);
            const monthExpenses = appState.expenses.filter(e => e.date.startsWith(currentMonth)).reduce((sum, e) => sum + e.amount, 0);
            const totalExpenses = appState.expenses.reduce((sum, e) => sum + e.amount, 0);
            
            // Inversiones (compras de mercader√≠a)
            const todayInvestments = appState.investments.filter(i => i.date === today).reduce((sum, i) => sum + i.amount, 0);
            const monthInvestments = appState.investments.filter(i => i.date.startsWith(currentMonth)).reduce((sum, i) => sum + i.amount, 0);
            const totalInvestments = appState.investments.reduce((sum, i) => sum + i.amount, 0);
            
            document.getElementById('expenses-today').textContent = `$${todayExpenses.toFixed(2)}`;
            document.getElementById('expenses-month').textContent = `$${monthExpenses.toFixed(2)}`;
            document.getElementById('expenses-total').textContent = `$${totalExpenses.toFixed(2)}`;
            
            // Actualizar elementos de inversi√≥n si existen
            const invToday = document.getElementById('investment-today');
            const invMonth = document.getElementById('investment-month');
            const invTotal = document.getElementById('investment-total');
            if (invToday) invToday.textContent = `$${todayInvestments.toFixed(2)}`;
            if (invMonth) invMonth.textContent = `$${monthInvestments.toFixed(2)}`;
            if (invTotal) invTotal.textContent = `$${totalInvestments.toFixed(2)}`;
            
            const recentExpenses = appState.expenses.slice(-20).reverse();
            document.getElementById('expenses-table').innerHTML = recentExpenses.map(e => `
                <tr class="hover:bg-gray-50">
                    <td class="px-4 py-2 text-sm">${e.date}</td>
                    <td class="px-4 py-2 text-sm font-medium">${e.concept}</td>
                    <td class="px-4 py-2 text-sm">
                        <span class="px-2 py-1 rounded-full text-xs ${e.source === 'cash' ? 'bg-green-100 text-green-700' : e.source === 'bank' ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}">
                            ${e.source === 'cash' ? 'üíµ Caja' : e.source === 'bank' ? 'üè¶ Cuenta' : 'üì¶ Compra'}
                        </span>
                    </td>
                    <td class="px-4 py-2 text-sm text-right font-bold text-red-600">-$${e.amount.toFixed(2)}</td>
                    <td class="px-4 py-2 text-right">
                        <button onclick="deleteExpense('${e.id}', '${e.date}')" class="text-red-500 hover:text-red-700 p-1 hover:bg-red-100 rounded" title="Eliminar">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="text-center py-4 text-gray-400">No hay gastos registrados</td></tr>';
            
            // Renderizar movimientos de Caja y Cuenta
            renderCashMovements();
            renderBankMovements();
            
            // Calcular m√©tricas
            calculateFinancialMetrics();
            
            // Actualizar gr√°fico con configuraci√≥n actual
            renderCashFlowChart(chartDays);
        }
        
        function renderCashMovements() {
            const today = formatDateISO(appState.activeDate);
            
            // Obtener ventas en efectivo de hoy
            const todayCashSales = appState.sales
                .filter(s => s.date === today && s.paymentMethod === 'cash')
                .map(s => ({
                    type: 'income',
                    concept: `Venta #${s.id.slice(-4)}`,
                    amount: s.total,
                    time: s.time
                }));
            
            // Obtener gastos de caja de hoy
            const todayCashExpenses = appState.expenses
                .filter(e => e.date === today && e.source === 'cash')
                .map(e => ({
                    type: 'expense',
                    concept: e.concept,
                    amount: e.amount,
                    time: new Date(e.timestamp).toLocaleTimeString('es-ES')
                }));
            
            // Obtener inversiones de caja de hoy (compras de stock)
            const todayCashInvestments = appState.investments
                .filter(i => i.date === today && i.source === 'cash')
                .map(i => ({
                    type: 'investment',
                    concept: i.concept,
                    amount: i.amount,
                    time: new Date(i.timestamp).toLocaleTimeString('es-ES')
                }));
            
            // Combinar y ordenar por tiempo
            const allMovements = [...todayCashSales, ...todayCashExpenses, ...todayCashInvestments]
                .sort((a, b) => (a.time > b.time ? -1 : 1));
            
            const container = document.getElementById('cash-movements-list');
            if (!container) return;
            
            if (allMovements.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No hay movimientos hoy</p>';
                return;
            }
            
            container.innerHTML = allMovements.map(m => `
                <div class="flex justify-between items-center p-3 rounded-lg ${m.type === 'income' ? 'bg-green-50 border-l-4 border-green-500' : m.type === 'investment' ? 'bg-blue-50 border-l-4 border-blue-500' : 'bg-red-50 border-l-4 border-red-500'}">
                    <div>
                        <p class="font-medium text-gray-800">${m.concept}</p>
                        <p class="text-xs text-gray-500">${m.time} ${m.type === 'investment' ? 'üì¶ INVERSI√ìN' : ''}</p>
                    </div>
                    <span class="font-bold ${m.type === 'income' ? 'text-green-600' : m.type === 'investment' ? 'text-blue-600' : 'text-red-600'}">
                        ${m.type === 'income' ? '+' : '-'}$${m.amount.toFixed(2)}
                    </span>
                </div>
            `).join('');
            
            // Actualizar contador
            const countBadge = document.getElementById('cash-movements-count');
            if (countBadge) countBadge.textContent = allMovements.length;
        }
        
        function renderBankMovements() {
            const today = formatDateISO(appState.activeDate);
            
            // Obtener ventas con d√©bito de hoy
            const todayBankSales = appState.sales
                .filter(s => s.date === today && s.paymentMethod === 'debit')
                .map(s => ({
                    type: 'income',
                    concept: `Venta #${s.id.slice(-4)}`,
                    amount: s.total,
                    time: s.time
                }));
            
            // Obtener gastos de cuenta de hoy
            const todayBankExpenses = appState.expenses
                .filter(e => e.date === today && e.source === 'bank')
                .map(e => ({
                    type: 'expense',
                    concept: e.concept,
                    amount: e.amount,
                    time: new Date(e.timestamp).toLocaleTimeString('es-ES')
                }));
            
            // Obtener inversiones de cuenta de hoy (compras de stock)
            const todayBankInvestments = appState.investments
                .filter(i => i.date === today && i.source === 'bank')
                .map(i => ({
                    type: 'investment',
                    concept: i.concept,
                    amount: i.amount,
                    time: new Date(i.timestamp).toLocaleTimeString('es-ES')
                }));
            
            // Combinar y ordenar por tiempo
            const allMovements = [...todayBankSales, ...todayBankExpenses, ...todayBankInvestments]
                .sort((a, b) => (a.time > b.time ? -1 : 1));
            
            const container = document.getElementById('bank-movements-list');
            if (!container) return;
            
            if (allMovements.length === 0) {
                container.innerHTML = '<p class="text-gray-400 text-center py-4">No hay movimientos hoy</p>';
                return;
            }
            
            container.innerHTML = allMovements.map(m => `
                <div class="flex justify-between items-center p-3 rounded-lg ${m.type === 'income' ? 'bg-blue-50 border-l-4 border-blue-500' : m.type === 'investment' ? 'bg-purple-50 border-l-4 border-purple-500' : 'bg-red-50 border-l-4 border-red-500'}">
                    <div>
                        <p class="font-medium text-gray-800">${m.concept}</p>
                        <p class="text-xs text-gray-500">${m.time} ${m.type === 'investment' ? 'üì¶ INVERSI√ìN' : ''}</p>
                    </div>
                    <span class="font-bold ${m.type === 'income' ? 'text-blue-600' : m.type === 'investment' ? 'text-purple-600' : 'text-red-600'}">
                        ${m.type === 'income' ? '+' : '-'}$${m.amount.toFixed(2)}
                    </span>
                </div>
            `).join('');
            
            // Actualizar contador
            const countBadge = document.getElementById('bank-movements-count');
            if (countBadge) countBadge.textContent = allMovements.length;
        }

        // ==================== SELECTOR DE PERIODO PARA CASHFLOW ====================
        function setCashflowPeriod(period) {
            currentCashflowPeriod = period;
            
            // Actualizar botones visuales
            document.querySelectorAll('.cf-period-btn').forEach(btn => {
                btn.classList.remove('bg-white', 'text-gray-800', 'shadow-sm');
                btn.classList.add('text-gray-600');
            });
            
            const activeBtn = document.getElementById('btn-cf-' + period);
            if (activeBtn) {
                activeBtn.classList.remove('text-gray-600');
                activeBtn.classList.add('bg-white', 'text-gray-800', 'shadow-sm');
            }
            
            // Calcular d√≠as seg√∫n per√≠odo
            let days = 30;
            if (period === 'today') days = 1;
            else if (period === 'week') days = 7;
            else if (period === 'month') days = 30;
            else if (period === 'year') days = 365;
            else if (period === 'all') days = 9999;
            
            const today = formatDateISO(new Date());
            const startDate = formatDateISO(new Date(new Date().getTime() - days * 24 * 60 * 60 * 1000));
            
            // Filtrar items por fecha
            const inRange = (items) => items.filter(item => item.date >= startDate && item.date <= today);
            
            // Actualizar inversiones
            const investments = inRange(appState.investments);
            const totalInv = investments.reduce((s, i) => s + i.amount, 0);
            const invEl = document.getElementById('investment-total');
            if (invEl) invEl.textContent = '$' + totalInv.toFixed(0);
            
            // Actualizar label
            const labels = {today: 'Hoy', week: '7 d√≠as', month: '30 d√≠as', year: '1 a√±o', all: 'Todo'};
            const invLabel = invEl?.parentElement?.querySelector('p:first-child');
            if (invLabel) invLabel.textContent = labels[period] || 'Periodo';
            
            // Actualizar gastos
            const expenses = inRange(appState.expenses);
            const totalExp = expenses.reduce((s, e) => s + e.amount, 0);
            const expEl = document.getElementById('expenses-total');
            if (expEl) expEl.textContent = '$' + totalExp.toFixed(0);
            
            // Actualizar tabla
            const tbody = document.getElementById('expenses-table');
            if (tbody) {
                tbody.innerHTML = expenses.slice(-20).reverse().map(e => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-2 text-sm">${e.date}</td>
                        <td class="px-4 py-2 text-sm font-medium">${e.concept}</td>
                        <td class="px-4 py-2 text-sm">
                            <span class="px-2 py-1 rounded-full text-xs ${e.source === 'cash' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
                                ${e.source === 'cash' ? 'üíµ Caja' : 'üè¶ Cuenta'}
                            </span>
                        </td>
                        <td class="px-4 py-2 text-sm text-right font-bold text-red-600">-$${e.amount.toFixed(2)}</td>
                        <td class="px-4 py-2 text-right">
                            <button onclick="deleteExpense('${e.id}', '${e.date}')" class="text-red-500 hover:text-red-700 p-1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('') || '<tr><td colspan="5" class="text-center py-4 text-gray-400">No hay gastos</td></tr>';
            }
            
            // Actualizar gr√°fico (usa configuraci√≥n de d√≠as independiente)
            renderCashFlowChart(chartDays);
        }
        
        // ==================== SELECTOR DE D√çAS PARA GR√ÅFICO ====================
        function setChartDays(days) {
            chartDays = days;
            
            // Actualizar botones
            const btn30 = document.getElementById('btn-chart-30');
            const btn365 = document.getElementById('btn-chart-365');
            if (btn30 && btn365) {
                if (days === 30) {
                    btn30.className = 'px-3 py-1 text-xs font-bold rounded bg-white text-gray-800 shadow-sm';
                    btn365.className = 'px-3 py-1 text-xs font-bold rounded text-gray-600 hover:bg-white';
                } else {
                    btn365.className = 'px-3 py-1 text-xs font-bold rounded bg-white text-gray-800 shadow-sm';
                    btn30.className = 'px-3 py-1 text-xs font-bold rounded text-gray-600 hover:bg-white';
                }
            }
            
            // Recargar gr√°fico
            renderCashFlowChart(days);
        }
        
        // ==================== SELECTOR DE MODO: $ O % ====================
        function setChartMode(mode) {
            chartMode = mode;
            
            // Actualizar botones
            const btnMoney = document.getElementById('btn-mode-money');
            const btnPercent = document.getElementById('btn-mode-percent');
            if (!btnMoney || !btnPercent) return;
            
            if (mode === 'money') {
                btnMoney.className = 'px-4 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition';
                btnPercent.className = 'px-4 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-white hover:shadow-sm transition';
            } else {
                btnPercent.className = 'px-4 py-1.5 rounded-md text-sm font-bold bg-white text-gray-800 shadow-sm transition';
                btnMoney.className = 'px-4 py-1.5 rounded-md text-sm font-bold text-gray-600 hover:bg-white hover:shadow-sm transition';
            }
            
            // Recargar gr√°fico
            renderCashFlowChart(chartDays);
        }
        
        function renderCashFlowChart(days) {
            const ctx = document.getElementById('cashFlowChart');
            if (!ctx) return;
            
            if (cashFlowChartInstance) {
                cashFlowChartInstance.destroy();
                cashFlowChartInstance = null;
            }
            
            // Generar fechas (limitar a 30 puntos m√°ximo para no saturar)
            const dates = [];
            const step = days > 30 ? Math.ceil(days / 30) : 1;
            for (let i = days - 1; i >= 0; i -= step) {
                const d = new Date();
                d.setDate(d.getDate() - i);
                dates.push(formatDateISO(d));
            }
            
            // Calcular tres m√©tricas para cada fecha
            const facturado = dates.map(date => {
                // Todas las ventas del d√≠a (efectivo + d√©bito)
                return appState.sales
                    .filter(s => s.date === date)
                    .reduce((sum, s) => sum + s.total, 0);
            });
            
            const ganado = dates.map(date => {
                // Ganancia neta del d√≠a (profit de ventas)
                return appState.sales
                    .filter(s => s.date === date)
                    .reduce((sum, s) => sum + s.profit, 0);
            });
            
            const gastado = dates.map(date => {
                // Todos los gastos del d√≠a (caja + cuenta)
                return appState.expenses
                    .filter(e => e.date === date)
                    .reduce((sum, e) => sum + e.amount, 0);
            });
            
            cashFlowChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dates.map(d => d.slice(5)), // mes-d√≠a
                    datasets: [
                        {
                            label: 'Facturado',
                            data: facturado,
                            borderColor: '#22c55e', // green-500
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: 'Ganado',
                            data: ganado,
                            borderColor: '#3b82f6', // blue-500
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2
                        },
                        {
                            label: 'Gastado',
                            data: gastado,
                            borderColor: '#ef4444', // red-500
                            backgroundColor: 'rgba(239, 68, 68, 0.1)',
                            fill: false,
                            tension: 0.3,
                            pointRadius: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    plugins: { 
                        legend: { display: false }
                    },
                    scales: {
                        y: { 
                            beginAtZero: true,
                            ticks: {
                                callback: function(v) {
                                    return '$' + v.toFixed(0);
                                }
                            }
                        }
                    },
                    interaction: {
                        mode: 'index',
                        intersect: false
                    }
                }
            });
        }

        // ==================== FINANCIAL METRICS (SIMPLIFICADO) ====================
        function calculateFinancialMetrics() {
            try {
                // ===== CAPITAL =====
                // Calcular capital autom√°ticamente: Caja + Cuenta + Valor de Stock
                const inventoryValue = appState.inventory.reduce((sum, p) => {
                    const stock = p.batches ? p.batches.reduce((s, b) => s + (b.stock || 0), 0) : (p.stock || 0);
                    return sum + ((p.cost || 0) * stock);
                }, 0);
                
                const totalCapital = appState.cash + appState.bank + inventoryValue;
                
                // Ganancia neta = Capital actual - Capital inicial inyectado (calculado desde ajustes)
                const capitalInjected = appState.capitalAdjustments
                    .filter(adj => adj.amount > 0)
                    .reduce((sum, adj) => sum + adj.amount, 0);
                
                const netProfit = totalCapital - (appState.initialCapital + capitalInjected);
                
                updateMetric('metric-capital-injected', `$${formatNumber(totalCapital)}`, 'text-blue-800');
                updateMetric('metric-net-profit', `$${formatNumber(netProfit)}`, netProfit >= 0 ? 'text-emerald-800' : 'text-red-600');
                
                // ===== ROI EN D√çAS =====
                const allDates = [
                    ...appState.sales.map(s => s.date),
                    ...appState.expenses.map(e => e.date),
                    ...appState.investments.map(i => i.date)
                ].filter(Boolean).sort();
                
                let roiText = 'N/A';
                let roiColor = 'text-gray-400';
                
                if (capitalInjected > 0 && allDates.length > 0) {
                    const firstDate = new Date(allDates[0]);
                    const todayDate = new Date();
                    const daysActive = Math.max(1, Math.ceil((todayDate - firstDate) / (1000 * 60 * 60 * 24)));
                    const totalDaysWithSales = new Set(appState.sales.map(s => s.date)).size;
                    const avgDailyProfit = totalDaysWithSales > 0 ? (netProfit / totalDaysWithSales) : 0;
                    
                    if (netProfit >= capitalInjected) {
                        let accumulatedProfit = 0;
                        let daysToRecover = 0;
                        const sortedSales = [...appState.sales].sort((a, b) => new Date(a.date) - new Date(b.date));
                        
                        for (let i = 0; i < sortedSales.length; i++) {
                            accumulatedProfit += sortedSales[i].profit;
                            if (accumulatedProfit >= capitalInjected) {
                                const firstSaleDate = new Date(sortedSales[0].date);
                                const recoveryDate = new Date(sortedSales[i].date);
                                daysToRecover = Math.ceil((recoveryDate - firstSaleDate) / (1000 * 60 * 60 * 24));
                                break;
                            }
                        }
                        roiText = formatDaysToMonths(daysToRecover);
                        roiColor = 'text-green-600';
                    } else if (avgDailyProfit > 0) {
                        const daysRemaining = Math.ceil((capitalInjected - netProfit) / avgDailyProfit);
                        roiText = formatDaysToMonths(daysRemaining);
                        roiColor = 'text-purple-800';
                    } else {
                        roiText = 'Calculando...';
                        roiColor = 'text-gray-500';
                    }
                }
                
                updateMetric('metric-roi-days', roiText, roiColor);
                
            } catch (e) {
                console.error('Error calculando m√©tricas:', e);
            }
        }
        
        // ==================== PERFORMANCE CHART ====================
        function setPerformancePeriod(period) {
            currentPerformancePeriod = period;
            
            // Actualizar botones
            ['day', 'week', 'month', 'year'].forEach(p => {
                const btn = document.getElementById(`btn-perf-${p}`);
                if (btn) {
                    if (p === period) {
                        btn.className = 'px-3 py-1 rounded-lg text-xs font-bold bg-purple-500 text-white';
                    } else {
                        btn.className = 'px-3 py-1 rounded-lg text-xs font-bold bg-gray-200 text-gray-600';
                    }
                }
            });
            
            renderPerformanceChart();
        }
        
        function renderPerformanceChart() {
            const ctx = document.getElementById('performanceChart');
            if (!ctx) return;
            
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
                performanceChartInstance = null;
            }
            
            const data = calculatePerformanceData(currentPerformancePeriod);
            
            if (data.labels.length === 0) {
                ctx.parentElement.innerHTML = '<p class="text-center text-gray-400 py-8">No hay datos suficientes</p>';
                return;
            }
            
            // Calcular cambio porcentual total
            const firstValue = data.values[0];
            const lastValue = data.values[data.values.length - 1];
            const totalChange = firstValue !== 0 ? ((lastValue - firstValue) / Math.abs(firstValue) * 100) : 0;
            
            const percentageEl = document.getElementById('performance-percentage');
            if (percentageEl) {
                percentageEl.textContent = `${totalChange >= 0 ? '+' : ''}${totalChange.toFixed(1)}%`;
                percentageEl.className = `absolute top-2 right-2 text-2xl font-bold ${totalChange >= 0 ? 'text-green-600' : 'text-red-600'} bg-white px-3 py-1 rounded-lg shadow`;
            }
            
            performanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: data.labels,
                    datasets: [{
                        label: 'Rendimiento %',
                        data: data.values,
                        borderColor: totalChange >= 0 ? '#10b981' : '#ef4444',
                        backgroundColor: totalChange >= 0 ? 'rgba(16, 185, 129, 0.1)' : 'rgba(239, 68, 68, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function calculatePerformanceData(period) {
            const today = new Date();
            const data = { labels: [], values: [] };
            
            switch(period) {
                case 'day':
                    // Comparar cada hora del d√≠a
                    for (let i = 0; i < 24; i++) {
                        const label = `${i}:00`;
                        
                        const todayStr = formatDateISO(today);
                        const todaySales = appState.sales
                            .filter(s => s.date === todayStr && parseInt(s.time?.split(':')[0] || 0) === i)
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = formatDateISO(yesterday);
                        const yesterdaySales = appState.sales
                            .filter(s => s.date === yesterdayStr && parseInt(s.time?.split(':')[0] || 0) === i)
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const change = yesterdaySales > 0 ? ((todaySales - yesterdaySales) / yesterdaySales * 100) : (todaySales > 0 ? 100 : 0);
                        
                        data.labels.push(label);
                        data.values.push(change);
                    }
                    break;
                    
                case 'week':
                    for (let i = 6; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const label = ['Dom', 'Lun', 'Mar', 'Mi√©', 'Jue', 'Vie', 'S√°b'][date.getDay()];
                        
                        const dateStr = formatDateISO(date);
                        const currentSales = appState.sales
                            .filter(s => s.date === dateStr)
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const prevWeek = new Date(date);
                        prevWeek.setDate(prevWeek.getDate() - 7);
                        const prevWeekStr = formatDateISO(prevWeek);
                        const prevWeekSales = appState.sales
                            .filter(s => s.date === prevWeekStr)
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const change = prevWeekSales > 0 ? ((currentSales - prevWeekSales) / prevWeekSales * 100) : (currentSales > 0 ? 100 : 0);
                        
                        data.labels.push(label);
                        data.values.push(change);
                    }
                    break;
                    
                case 'month':
                    for (let i = 29; i >= 0; i--) {
                        const date = new Date(today);
                        date.setDate(date.getDate() - i);
                        const label = `${date.getDate()}`;
                        
                        const dateStr = formatDateISO(date);
                        const currentSales = appState.sales
                            .filter(s => s.date === dateStr)
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const prevMonth = new Date(date);
                        prevMonth.setMonth(prevMonth.getMonth() - 1);
                        const prevMonthStr = formatDateISO(prevMonth);
                        const prevMonthSales = appState.sales
                            .filter(s => s.date === prevMonthStr)
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const change = prevMonthSales > 0 ? ((currentSales - prevMonthSales) / prevMonthSales * 100) : (currentSales > 0 ? 100 : 0);
                        
                        data.labels.push(label);
                        data.values.push(change);
                    }
                    break;
                    
                case 'year':
                    const monthNames = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
                    for (let i = 11; i >= 0; i--) {
                        const date = new Date(today);
                        date.setMonth(date.getMonth() - i);
                        const label = monthNames[date.getMonth()];
                        const yearMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        
                        const currentSales = appState.sales
                            .filter(s => s.date.startsWith(yearMonth))
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const prevYear = date.getFullYear() - 1;
                        const prevYearMonth = `${prevYear}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                        const prevYearSales = appState.sales
                            .filter(s => s.date.startsWith(prevYearMonth))
                            .reduce((sum, s) => sum + s.total, 0);
                        
                        const change = prevYearSales > 0 ? ((currentSales - prevYearSales) / prevYearSales * 100) : (currentSales > 0 ? 100 : 0);
                        
                        data.labels.push(label);
                        data.values.push(change);
                    }
                    break;
            }
            
            return data;
        }
        
        function getPreviousMonth(currentMonth) {
            const [year, month] = currentMonth.split('-').map(Number);
            if (month === 1) return `${year - 1}-12`;
            return `${year}-${String(month - 1).padStart(2, '0')}`;
        }
        
        function updateMetric(id, value, colorClass) {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = value;
                el.className = `text-2xl font-bold ${colorClass}`;
            }
        }
        
        function updateBadge(id, badgeClass) {
            const el = document.getElementById(id);
            if (el) el.className = `text-xs px-2 py-1 rounded-full ${badgeClass}`;
        }
        
        function updateProgressBar(id, percentage, colorClass) {
            const el = document.getElementById(id);
            if (el) {
                el.style.width = `${percentage}%`;
                el.className = `h-full rounded-full transition-all ${colorClass}`;
            }
        }
        
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toFixed(0);
        }
        
        function formatDaysToMonths(days) {
            if (days <= 0) return 'Recuperado';
            if (days < 30) return `${days} d√≠as`;
            
            const months = Math.floor(days / 30);
            const remainingDays = days % 30;
            
            if (remainingDays === 0) {
                return months === 1 ? '1 mes' : `${months} meses`;
            }
            
            return months === 1 
                ? `1 mes y ${remainingDays} d√≠as`
                : `${months} meses y ${remainingDays} d√≠as`;
        }

        // ==================== ADJUST MONEY ====================
        let adjustTarget = 'cash';
        let adjustType = 'add';

        function openAdjustModal(target = 'cash', type = null) {
            adjustTarget = target;
            if (type) adjustType = type;
            
            document.getElementById('adjust-cash-current').textContent = `$${appState.cash.toFixed(2)}`;
            document.getElementById('adjust-bank-current').textContent = `$${appState.bank.toFixed(2)}`;
            
            setAdjustTarget(target);
            if (type) setAdjustType(type);
            
            document.getElementById('adjust-money-modal').classList.add('active');
        }

        function closeAdjustModal() {
            document.getElementById('adjust-money-modal').classList.remove('active');
            document.getElementById('adjust-amount').value = '';
            document.getElementById('adjust-concept').value = '';
        }

        function setAdjustTarget(target) {
            adjustTarget = target;
            document.getElementById('btn-adjust-cash').className = target === 'cash'
                ? 'flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
            document.getElementById('btn-adjust-bank').className = target === 'bank'
                ? 'flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
        }

        function setAdjustType(type) {
            adjustType = type;
            document.getElementById('btn-adjust-add').className = type === 'add'
                ? 'flex-1 py-2 rounded-lg border-2 border-green-500 bg-green-50 text-green-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
            document.getElementById('btn-adjust-remove').className = type === 'remove'
                ? 'flex-1 py-2 rounded-lg border-2 border-red-500 bg-red-50 text-red-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
        }

        function executeAdjustMoney() {
            const amount = parseFloat(document.getElementById('adjust-amount').value);
            let concept = document.getElementById('adjust-concept').value;
            
            if (!amount || amount <= 0) {
                showNotification('Ingrese un monto v√°lido', 'error');
                return;
            }

            if (!concept) {
                concept = adjustType === 'add' 
                    ? `Ingreso a ${adjustTarget === 'cash' ? 'caja' : 'cuenta'}`
                    : `Retiro de ${adjustTarget === 'cash' ? 'caja' : 'cuenta'}`;
            }

            if (adjustType === 'add') {
                if (adjustTarget === 'cash') {
                    appState.cash += amount;
                } else {
                    appState.bank += amount;
                }
                
                // Registrar como capital inyectado
                if (!appState.capitalAdjustments) appState.capitalAdjustments = [];
                appState.capitalAdjustments.push({
                    date: formatDateISO(appState.activeDate),
                    amount: amount,
                    target: adjustTarget,
                    concept: concept,
                    timestamp: Date.now()
                });
                
                showNotification(`$${amount.toFixed(2)} agregados a ${adjustTarget === 'cash' ? 'Caja' : 'Cuenta'} y registrados como capital`, 'success');
            } else {
                if (adjustTarget === 'cash' && amount > appState.cash) {
                    showNotification('Fondos insuficientes en caja', 'error');
                    return;
                }
                if (adjustTarget === 'bank' && amount > appState.bank) {
                    showNotification('Fondos insuficientes en cuenta', 'error');
                    return;
                }

                if (adjustTarget === 'cash') {
                    appState.cash -= amount;
                } else {
                    appState.bank -= amount;
                }

                appState.expenses.push({
                    id: 'WITHDRAW-' + Date.now(),
                    date: formatDateISO(appState.activeDate),
                    concept: concept,
                    amount: amount,
                    source: adjustTarget,
                    type: 'withdrawal',
                    timestamp: Date.now()
                });
                
                showNotification(`$${amount.toFixed(2)} retirados de ${adjustTarget === 'cash' ? 'Caja' : 'Cuenta'} y registrados como gasto`, 'success');
            }

            saveToLocalStorage();
            renderAll();
            closeAdjustModal();

        }

        function openMoveMoneyModal() {
            document.getElementById('move-money-modal').classList.add('active');
            setMoveDirection('to_bank');
        }

        function closeMoveModal() {
            document.getElementById('move-money-modal').classList.remove('active');
        }

        let moveDirection = 'to_bank';

        function setMoveDirection(direction) {
            moveDirection = direction;
            document.getElementById('btn-to-bank').className = direction === 'to_bank'
                ? 'flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
            document.getElementById('btn-to-cash').className = direction === 'to_cash'
                ? 'flex-1 py-2 rounded-lg border-2 border-blue-500 bg-blue-50 text-blue-700 font-bold text-sm'
                : 'flex-1 py-2 rounded-lg border-2 border-gray-200 text-gray-600 text-sm';
        }

        function executeMoveMoney() {
            const amount = parseFloat(document.getElementById('move-amount').value);
            const concept = document.getElementById('move-concept').value || 'Movimiento entre cuentas';
            
            if (!amount || amount <= 0) {
                showNotification('Ingrese un monto v√°lido', 'error');
                return;
            }

            if (moveDirection === 'to_bank') {
                if (amount > appState.cash) {
                    showNotification('Fondos insuficientes en caja', 'error');
                    return;
                }
                appState.cash -= amount;
                appState.bank += amount;
            } else {
                if (amount > appState.bank) {
                    showNotification('Fondos insuficientes en cuenta', 'error');
                    return;
                }
                appState.bank -= amount;
                appState.cash += amount;
            }

            appState.cashMovements.push({
                id: 'MOV-' + Date.now(),
                date: formatDateISO(appState.activeDate),
                type: moveDirection,
                amount: amount,
                concept: concept,
                timestamp: Date.now()
            });

            saveToLocalStorage();
            renderAll();
            closeMoveModal();

            showNotification('Movimiento registrado', 'success');
        }

        function openExpenseModal() {
            const concept = prompt('Concepto del gasto:');
            if (!concept) return;
            
            const amount = parseFloat(prompt('Monto:'));
            if (!amount || amount <= 0) return;

            if (amount > appState.cash) {
                showNotification('Fondos insuficientes en caja', 'error');
                return;
            }

            appState.cash -= amount;
            appState.expenses.push({
                id: 'EXP-' + Date.now(),
                date: formatDateISO(appState.activeDate),
                concept: concept,
                amount: amount,
                source: 'cash',
                type: 'expense',
                timestamp: Date.now()
            });

            saveToLocalStorage();
            renderAll();

            showNotification('Gasto registrado', 'success');
        }

        // ==================== PREDICTIONS ====================
        // Cache para estad√≠sticas de productos
        const statsCache = new Map();
        
        function calculateProductStats(productId) {
            // Verificar cache
            if (statsCache.has(productId)) {
                return statsCache.get(productId);
            }
            
            const productSales = appState.sales.filter(s => 
                s.items && s.items.some(i => i.productId === productId)
            );
            
            if (productSales.length === 0) {
                statsCache.set(productId, null);
                return null;
            }

            const totalQty = productSales.reduce((sum, s) => {
                const item = s.items.find(i => i.productId === productId);
                return sum + (item ? item.quantity : 0);
            }, 0);

            const uniqueDays = new Set(productSales.map(s => s.date)).size;
            const avgDaily = uniqueDays > 0 ? totalQty / uniqueDays : 0;
            
            // An√°lisis por d√≠a de la semana (0=Domingo, 6=S√°bado)
            const dayOfWeekStats = [0, 0, 0, 0, 0, 0, 0];
            const dayOfWeekCounts = [0, 0, 0, 0, 0, 0, 0];
            
            productSales.forEach(sale => {
                if (!sale.date) return;
                const date = new Date(sale.date + 'T00:00:00'); // Forzar hora local
                const dayOfWeek = date.getDay();
                const item = sale.items.find(i => i.productId === productId);
                if (item) {
                    dayOfWeekStats[dayOfWeek] += item.quantity;
                    dayOfWeekCounts[dayOfWeek]++;
                }
            });
            
            // Promedio por d√≠a de la semana
            const avgByDayOfWeek = dayOfWeekStats.map((total, idx) => 
                dayOfWeekCounts[idx] > 0 ? total / dayOfWeekCounts[idx] : avgDaily * 0.8
            );
            
            // Detectar tendencia (√∫ltimos 7 d√≠as vs d√≠as anteriores)
            const last7Days = [];
            const previousDays = [];
            const today = new Date();
            
            productSales.forEach(sale => {
                if (!sale.date) return;
                const saleDate = new Date(sale.date + 'T00:00:00');
                const daysDiff = Math.floor((today - saleDate) / (1000 * 60 * 60 * 24));
                const item = sale.items.find(i => i.productId === productId);
                if (item) {
                    if (daysDiff <= 7) last7Days.push(item.quantity);
                    else if (daysDiff <= 30) previousDays.push(item.quantity);
                }
            });
            
            const recentAvg = last7Days.length > 0 ? last7Days.reduce((a,b) => a+b, 0) / last7Days.length : avgDaily;
            const oldAvg = previousDays.length > 0 ? previousDays.reduce((a,b) => a+b, 0) / previousDays.length : avgDaily;
            const trend = oldAvg > 0 ? ((recentAvg - oldAvg) / oldAvg) * 100 : 0;
            
            const lastSale = productSales.length > 0 ? productSales[productSales.length - 1].date : null;
            
            const result = {
                totalSold: totalQty,
                uniqueDays: uniqueDays,
                avgDaily: avgDaily,
                avgByDayOfWeek: avgByDayOfWeek,
                recentAvg: recentAvg,
                trend: trend,
                lastSale: lastSale
            };
            
            // Guardar en cache
            statsCache.set(productId, result);
            return result;
        }

        function predictDemand(productId, daysAhead = 7) {
            const stats = calculateProductStats(productId);
            if (!stats) return null;

            const product = appState.inventory.find(p => p.id === productId);
            if (!product) return null;
            
            const today = new Date();
            const predictions = [];
            let totalDemand = 0;
            
            for (let i = 1; i <= daysAhead; i++) {
                const futureDate = new Date(today);
                futureDate.setDate(today.getDate() + i);
                const dayOfWeek = futureDate.getDay();
                
                // Base: promedio del d√≠a de la semana correspondiente
                let predictedDemand = stats.avgByDayOfWeek[dayOfWeek] || stats.avgDaily;
                
                // Ajustar por tendencia
                if (stats.trend > 10) predictedDemand *= 1.1;
                else if (stats.trend < -10) predictedDemand *= 0.9;
                
                // Si no hay ventas recientes, reducir predicci√≥n
                let daysSinceLastSale = 999;
                if (stats.lastSale) {
                    const lastSaleDate = new Date(stats.lastSale + 'T00:00:00');
                    daysSinceLastSale = Math.floor((today - lastSaleDate) / (1000 * 60 * 60 * 24));
                }
                if (daysSinceLastSale > 14) predictedDemand *= 0.5;
                
                const demand = Math.max(0, Math.round(predictedDemand));
                totalDemand += demand;
                
                predictions.push({
                    date: formatDateISO(futureDate),
                    dayName: futureDate.toLocaleDateString('es-ES', { weekday: 'short' }),
                    demand: demand,
                    confidence: Math.min(95, Math.max(50, 100 - Math.abs(stats.trend)))
                });
            }
            
            return {
                product: product,
                stats: stats,
                predictions: predictions,
                totalPredictedDemand: totalDemand
            };
        }

        function generateShoppingList() {
            const list = [];
            const today = new Date();
            const todayDayOfWeek = today.getDay();
            
            // Limitar a los primeros 100 productos para evitar sobrecarga
            const productsToAnalyze = appState.inventory.slice(0, 100);
            
            productsToAnalyze.forEach(product => {
                if (!product || !product.id) return;
                
                const prediction = predictDemand(product.id, 7);
                if (!prediction || !prediction.stats) return;
                
                const avgDaily = prediction.stats.avgDaily || 0;
                const currentStock = getProductStock(product);
                const minStock = parseInt(product.min) || 5;
                
                // Calcular cu√°nto necesito para 1 semana + stock m√≠nimo de seguridad
                const weeklyDemand = avgDaily * 7;
                const targetStock = Math.ceil(weeklyDemand + minStock);
                const suggestedQty = Math.max(0, targetStock - currentStock);
                
                if (suggestedQty <= 0) return;
                
                const daysUntilStockout = avgDaily > 0 ? 
                    Math.floor(currentStock / avgDaily) : 999;
                
                // Calcular pr√≥ximo d√≠a de compra
                let nextBuyDay = null;
                let daysUntilBuy = null;
                
                if (product.buyDays && product.buyDays.length > 0) {
                    // Encontrar el pr√≥ximo d√≠a de compra
                    for (let i = 0; i <= 7; i++) {
                        const checkDay = (todayDayOfWeek + i) % 7;
                        if (product.buyDays.includes(checkDay)) {
                            nextBuyDay = checkDay;
                            daysUntilBuy = i;
                            break;
                        }
                    }
                }
                
                // Calcular vencimiento √≥ptimo
                // Si se vende X por d√≠a, y compro Y unidades, me debe durar Y/X d√≠as
                // Agregamos 30% de margen de seguridad
                const daysOfStock = suggestedQty / Math.max(avgDaily, 0.1); // Evitar divisi√≥n por cero
                const optimalExpiryDays = Math.ceil(daysOfStock * 1.3);
                const optimalExpiryDate = new Date(today);
                optimalExpiryDate.setDate(today.getDate() + optimalExpiryDays);
                
                // Prioridad
                let priority = 'BAJA';
                if (currentStock === 0) priority = 'CR√çTICO';
                else if (daysUntilStockout <= 2) priority = 'ALTA';
                else if (daysUntilStockout <= 5) priority = 'MEDIA';
                
                // Si el pr√≥ximo d√≠a de compra es despu√©s de que se agote el stock, aumentar prioridad
                if (daysUntilBuy !== null && daysUntilStockout < daysUntilBuy) {
                    priority = 'CR√çTICO';
                }
                
                list.push({
                    product: product,
                    currentStock: currentStock,
                    weeklyDemand: weeklyDemand,
                    suggestedQty: suggestedQty,
                    daysUntilStockout: daysUntilStockout,
                    nextBuyDay: nextBuyDay,
                    daysUntilBuy: daysUntilBuy,
                    buyDayName: nextBuyDay !== null ? getDayName(nextBuyDay) : 'Sin definir',
                    optimalExpiryDays: optimalExpiryDays,
                    optimalExpiryDate: formatDateISO(optimalExpiryDate),
                    priority: priority,
                    trend: prediction.stats.trend || 0,
                    avgDaily: avgDaily,
                    supplier: product.supplier || 'Sin proveedor'
                });
            });
            
            return list.sort((a, b) => {
                // Primero por d√≠a de compra
                if (a.daysUntilBuy !== null && b.daysUntilBuy !== null) {
                    if (a.daysUntilBuy !== b.daysUntilBuy) {
                        return a.daysUntilBuy - b.daysUntilBuy;
                    }
                }
                // Luego por prioridad
                const priorityOrder = { 'CR√çTICO': 0, 'ALTA': 1, 'MEDIA': 2, 'BAJA': 3 };
                return priorityOrder[a.priority] - priorityOrder[b.priority];
            });
        }
        
        function getDayName(dayIndex) {
            const days = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            return days[dayIndex] || 'Desconocido';
        }

        function renderPredictions() {
            // Limpiar cache de estad√≠sticas
            statsCache.clear();
            
            // Mostrar estado de carga inmediatamente
            const cardsContainer = document.getElementById('prediction-cards');
            const shoppingContainer = document.getElementById('auto-shopping-list');
            const topProductsContainer = document.getElementById('top-products-analysis');
            
            if (cardsContainer) {
                cardsContainer.innerHTML = `
                    <div class="col-span-3 text-center py-8 text-gray-400">
                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                        <p>Analizando datos y generando predicciones...</p>
                    </div>
                `;
            }
            
            // Usar setTimeout para no bloquear la UI
            setTimeout(() => {
                try {
                    renderPredictionsContent();
                } catch (err) {
                    console.error('Error en renderPredictions:', err);
                    if (cardsContainer) {
                        cardsContainer.innerHTML = `
                            <div class="col-span-3 text-center py-8 text-red-500">
                                <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                                <p>Error al generar predicciones. Intent√° recargar la p√°gina.</p>
                                <p class="text-sm mt-2 text-gray-500">${err.message}</p>
                            </div>
                        `;
                    }
                }
            }, 10);
        }
        
        function renderPredictionsContent() {
            // Verificar si hay productos en el inventario
            const hasInventory = Array.isArray(appState.inventory) && appState.inventory.length > 0;
            
            if (!hasInventory) {
                const cardsContainer = document.getElementById('prediction-cards');
                if (cardsContainer) {
                    cardsContainer.innerHTML = `
                        <div class="col-span-4 text-center py-8 text-gray-400">
                            <i class="fas fa-box-open text-4xl mb-3"></i>
                            <p class="text-lg font-medium mb-1">No hay productos en el inventario</p>
                            <p class="text-sm">Agreg√° productos para ver el control de stock</p>
                        </div>
                    `;
                }
                
                const shoppingContainer = document.getElementById('auto-shopping-list');
                if (shoppingContainer) {
                    shoppingContainer.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400">No hay productos en el inventario</td></tr>';
                }
                
                const topProductsContainer = document.getElementById('top-products-analysis');
                if (topProductsContainer) {
                    topProductsContainer.innerHTML = '<p class="text-center text-gray-400 py-4">No hay productos para analizar</p>';
                }
                
                const countElement = document.getElementById('shopping-list-count');
                if (countElement) countElement.textContent = '0 productos';
                return;
            }
            
            // Calcular resumen de stock
            let criticalCount = 0;
            let lowCount = 0;
            let normalCount = 0;
            let totalBuyQty = 0;
            
            appState.inventory.forEach(product => {
                const stock = getProductStock(product);
                const minStock = parseInt(product.min) || 5;
                const prediction = predictDemand(product.id, 7);
                const avgDaily = prediction?.stats?.avgDaily || 0;
                const weeklyDemand = avgDaily * 7;
                const targetStock = Math.ceil(weeklyDemand + minStock);
                const suggestedQty = Math.max(0, targetStock - stock);
                const daysUntilStockout = avgDaily > 0 ? Math.floor(stock / avgDaily) : 999;
                
                if (suggestedQty > 0) {
                    totalBuyQty += suggestedQty;
                    if (stock === 0 || daysUntilStockout <= 2) criticalCount++;
                    else if (daysUntilStockout <= 5) lowCount++;
                    else lowCount++;
                } else {
                    normalCount++;
                }
            });
            
            // Renderizar tarjetas de resumen de stock (reemplazo de predicciones diarias)
            const cardsContainer = document.getElementById('prediction-cards');
            if (cardsContainer) {
                cardsContainer.innerHTML = `
                    <div class="bg-gradient-to-br from-red-50 to-white rounded-xl p-4 border border-red-200">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center">
                                <i class="fas fa-exclamation-triangle text-red-600"></i>
                            </div>
                            <span class="text-red-600 font-bold">Stock Cr√≠tico</span>
                        </div>
                        <p class="text-3xl font-bold text-gray-800 mb-1">${criticalCount}</p>
                        <p class="text-sm text-gray-500">productos agotados o casi</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-orange-50 to-white rounded-xl p-4 border border-orange-200">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-orange-100 flex items-center justify-center">
                                <i class="fas fa-arrow-down text-orange-600"></i>
                            </div>
                            <span class="text-orange-600 font-bold">Stock Bajo</span>
                        </div>
                        <p class="text-3xl font-bold text-gray-800 mb-1">${lowCount}</p>
                        <p class="text-sm text-gray-500">necesitan reposici√≥n</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-blue-50 to-white rounded-xl p-4 border border-blue-200">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                                <i class="fas fa-shopping-cart text-blue-600"></i>
                            </div>
                            <span class="text-blue-600 font-bold">Total a Comprar</span>
                        </div>
                        <p class="text-3xl font-bold text-gray-800 mb-1">${totalBuyQty}</p>
                        <p class="text-sm text-gray-500">unidades sugeridas</p>
                    </div>
                    
                    <div class="bg-gradient-to-br from-green-50 to-white rounded-xl p-4 border border-green-200">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="w-10 h-10 rounded-full bg-green-100 flex items-center justify-center">
                                <i class="fas fa-check-circle text-green-600"></i>
                            </div>
                            <span class="text-green-600 font-bold">Stock OK</span>
                        </div>
                        <p class="text-3xl font-bold text-gray-800 mb-1">${normalCount}</p>
                        <p class="text-sm text-gray-500">productos con stock normal</p>
                    </div>
                `;
            }
            
            // Generar y renderizar lista de compras
            const shoppingList = generateShoppingList();
            
            // Agrupar por d√≠a de compra
            const groupedByDay = {};
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            
            shoppingList.forEach(item => {
                const dayName = item.buyDayName || 'Sin definir';
                if (!groupedByDay[dayName]) groupedByDay[dayName] = [];
                groupedByDay[dayName].push(item);
            });
            
            const shoppingContainer = document.getElementById('auto-shopping-list');
            if (shoppingContainer) {
                if (shoppingList.length === 0) {
                    shoppingContainer.innerHTML = '<tr><td colspan="6" class="text-center py-8 text-gray-400"><i class="fas fa-check-circle text-4xl mb-2"></i><br>No hay productos que requieran reposici√≥n</td></tr>';
                } else {
                    let html = '';
                    
                    // Ordenar d√≠as empezando desde hoy
                    const sortedDays = Object.keys(groupedByDay).sort((a, b) => {
                        const aIndex = dayNames.indexOf(a);
                        const bIndex = dayNames.indexOf(b);
                        if (a === 'Sin definir') return 1;
                        if (b === 'Sin definir') return -1;
                        return aIndex - bIndex;
                    });
                    
                    sortedDays.forEach(dayName => {
                        const items = groupedByDay[dayName];
                        const dayHeader = dayName === 'Sin definir' ? 'Sin d√≠a definido' : `Comprar: ${dayName}`;
                        
                        html += `
                            <tr class="bg-purple-100">
                                <td colspan="6" class="px-4 py-2 font-bold text-purple-800">
                                    üìÖ ${dayHeader} (${items.length} productos)
                                </td>
                            </tr>
                        `;
                        
                        html += items.map(item => {
                            const minStock = parseInt(item.product.min) || 5;
                            return `
                            <tr class="hover:bg-gray-50 border-l-4 ${item.priority === 'CR√çTICO' ? 'border-red-500' : item.priority === 'ALTA' ? 'border-orange-500' : item.priority === 'MEDIA' ? 'border-yellow-500' : 'border-green-500'}">
                                <td class="px-4 py-3">
                                    <div class="font-medium text-gray-900">${item.product.name}</div>
                                    <div class="text-xs text-gray-500">${item.supplier}</div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="${item.currentStock === 0 ? 'text-red-600 font-bold' : 'text-gray-600'}">${item.currentStock}</span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="text-gray-500">${minStock}</span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="font-bold text-blue-600">${item.suggestedQty} u.</span>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <div class="text-sm text-gray-600">${item.avgDaily.toFixed(1)}/d√≠a</div>
                                    <div class="text-xs ${item.daysUntilStockout <= 3 ? 'text-red-500 font-bold' : 'text-gray-400'}">Agota en ${item.daysUntilStockout}d</div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    <span class="px-2 py-1 rounded-full text-xs font-bold ${item.priority === 'CR√çTICO' ? 'bg-red-100 text-red-700' : item.priority === 'ALTA' ? 'bg-orange-100 text-orange-700' : item.priority === 'MEDIA' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">
                                        ${item.priority}
                                    </span>
                                </td>
                            </tr>
                        `;
                        }).join('');
                    });
                    
                    shoppingContainer.innerHTML = html;
                }
            }
            
            const countElement = document.getElementById('shopping-list-count');
            if (countElement) {
                countElement.textContent = `${shoppingList.length} productos`;
            }
            
            // Renderizar gr√°fico de tendencias
            renderTrendChart();
            
            // Renderizar an√°lisis de top productos
            renderTopProductsAnalysis();
        }

        function renderTrendChart() {
            const ctx = document.getElementById('trendChart');
            if (!ctx) return;
            
            try {
                // Obtener ventas de los √∫ltimos 14 d√≠as
                const today = new Date();
                const last14Days = [];
                for (let i = 13; i >= 0; i--) {
                    const d = new Date(today);
                    d.setDate(d.getDate() - i);
                    last14Days.push(formatDateISO(d));
                }
                
                const dailySales = last14Days.map(date => {
                    if (!appState.sales || !Array.isArray(appState.sales)) return 0;
                    return appState.sales
                        .filter(s => s && s.date === date)
                        .reduce((sum, s) => sum + (s.total || 0), 0);
                });
                
                // Destruir chart anterior si existe
                if (window.trendChartInstance) {
                    window.trendChartInstance.destroy();
                    window.trendChartInstance = null;
                }
                
                // Si no hay datos de ventas, mostrar mensaje
                const totalSales = dailySales.reduce((a, b) => a + b, 0);
                if (totalSales === 0) {
                    const parent = ctx.parentElement;
                    if (parent) {
                        parent.innerHTML = `
                            <div class="text-center py-8 text-gray-400">
                                <i class="fas fa-chart-line text-4xl mb-2"></i>
                                <p>No hay datos de ventas suficientes para mostrar tendencias</p>
                            </div>
                        `;
                    }
                    return;
                }
                
                // Restaurar canvas si fue reemplazado
                if (!document.getElementById('trendChart')) {
                    const parent = document.querySelector('#predictions canvas')?.parentElement;
                    if (parent) {
                        parent.innerHTML = '<canvas id="trendChart" height="120"></canvas>';
                    }
                }
                
                const chartCtx = document.getElementById('trendChart');
                if (!chartCtx) return;
                
                // Preparar datos seg√∫n el modo
                let data, label, color, bgColor;
                
                if (chartMode === 'percent') {
                    // Modo porcentaje: variaci√≥n d√≠a a d√≠a
                    data = dailySales.map((v, i, arr) => {
                        if (i === 0) return 0;
                        const prev = arr[i - 1];
                        if (prev === 0) return v > 0 ? 100 : 0;
                        return ((v - prev) / prev) * 100;
                    });
                    label = 'Variaci√≥n Ventas (%)';
                    color = '#f59e0b'; // amber
                    bgColor = 'rgba(245, 158, 11, 0.1)';
                } else {
                    // Modo dinero
                    data = dailySales;
                    label = 'Ventas ($)';
                    color = '#667eea'; // purple
                    bgColor = 'rgba(102, 126, 234, 0.1)';
                }
                
                window.trendChartInstance = new Chart(chartCtx, {
                    type: 'line',
                    data: {
                        labels: last14Days.map(d => d.slice(5)),
                        datasets: [{
                            label: label,
                            data: data,
                            borderColor: color,
                            backgroundColor: bgColor,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: { 
                            legend: { display: false }
                        },
                        scales: { 
                            y: { 
                                beginAtZero: true
                            } 
                        }
                    }
                });
            } catch (err) {
                console.error('Error en renderTrendChart:', err);
            }
        }

        function renderTopProductsAnalysis() {
            const container = document.getElementById('top-products-analysis');
            if (!container) return;
            
            // Obtener top 5 productos por volumen de ventas
            const productRanking = appState.inventory
                .map(p => {
                    const stats = calculateProductStats(p.id);
                    return {
                        product: p,
                        stats: stats
                    };
                })
                .filter(item => item.stats && item.stats.totalSold > 0)
                .sort((a, b) => b.stats.totalSold - a.stats.totalSold)
                .slice(0, 5);
            
            if (productRanking.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-400 py-4">No hay suficientes datos de ventas</p>';
                return;
            }
            
            container.innerHTML = productRanking.map((item, idx) => {
                const trendIcon = item.stats.trend > 10 ? 'üìà' : item.stats.trend < -10 ? 'üìâ' : '‚û°Ô∏è';
                const trendColor = item.stats.trend > 10 ? 'text-green-600' : item.stats.trend < -10 ? 'text-red-600' : 'text-gray-600';
                const productStock = getProductStock(item.product);
                const daysLeft = item.stats.avgDaily > 0 ? Math.floor(productStock / item.stats.avgDaily) : 'N/A';
                
                return `
                    <div class="flex items-center gap-4 p-4 bg-gray-50 rounded-xl">
                        <div class="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold">
                            ${idx + 1}
                        </div>
                        <div class="flex-1">
                            <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-gray-800">${escapeHtml(item.product.name)}</h4>
                                    <p class="text-xs text-gray-500">Vendidos: ${item.stats.totalSold} unidades</p>
                                </div>
                                <div class="text-right">
                                    <span class="text-lg ${trendColor}">${trendIcon} ${Math.abs(item.stats.trend).toFixed(1)}%</span>
                                </div>
                            </div>
                            <div class="flex gap-4 mt-2 text-sm">
                                <span class="text-gray-600">üì¶ Stock: ${productStock}</span>
                                <span class="text-gray-600">üìä ~${item.stats.avgDaily.toFixed(1)}/d√≠a</span>
                                <span class="${daysLeft <= 3 && daysLeft !== 'N/A' ? 'text-red-600 font-bold' : 'text-gray-600'}">‚è±Ô∏è ${daysLeft} d√≠as restantes</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function exportShoppingList() {
            const shoppingList = generateShoppingList();
            
            if (shoppingList.length === 0) {
                showNotification('No hay productos para comprar', 'info');
                return;
            }

            const today = new Date();
            const dateStr = today.toLocaleDateString('es-ES');
            
            // Agrupar por d√≠a de compra
            const groupedByDay = {};
            const dayNames = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
            
            shoppingList.forEach(item => {
                const dayName = item.buyDayName || 'Sin definir';
                if (!groupedByDay[dayName]) groupedByDay[dayName] = [];
                groupedByDay[dayName].push(item);
            });
            
            // Ordenar d√≠as
            const sortedDays = Object.keys(groupedByDay).sort((a, b) => {
                const aIndex = dayNames.indexOf(a);
                const bIndex = dayNames.indexOf(b);
                if (a === 'Sin definir') return 1;
                if (b === 'Sin definir') return -1;
                return aIndex - bIndex;
            });
            
            // Generar texto
            let text = `üõí LISTA DE COMPRAS - KIOSCOPRO
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
Fecha de generaci√≥n: ${dateStr}
Total de productos a comprar: ${shoppingList.length}

`;
            
            sortedDays.forEach(dayName => {
                const items = groupedByDay[dayName];
                const totalItems = items.reduce((sum, i) => sum + i.suggestedQty, 0);
                
                text += `üìÖ ${dayName.toUpperCase()}\n`;
                text += `‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n`;
                text += `Total de unidades: ${totalItems}\n\n`;
                
                items.forEach((item, idx) => {
                    const product = item.product;
                    text += `${idx + 1}. ${product.name.toUpperCase()}\n`;
                    text += `   ‚îú‚îÄ‚îÄ Proveedor: ${item.supplier}\n`;
                    text += `   ‚îú‚îÄ‚îÄ Stock actual: ${item.currentStock} unidades\n`;
                    text += `   ‚îú‚îÄ‚îÄ COMPRAR: ${item.suggestedQty} unidades\n`;
                    text += `   ‚îú‚îÄ‚îÄ Prioridad: ${item.priority}\n`;
                    text += `   ‚îú‚îÄ‚îÄ Demanda: ${item.avgDaily.toFixed(1)} unidades/d√≠a\n`;
                    text += `   ‚îú‚îÄ‚îÄ Se agota en: ${item.daysUntilStockout} d√≠as\n`;
                    text += `   ‚îú‚îÄ‚îÄ Vencimiento ideal: ${item.optimalExpiryDays} d√≠as (${item.optimalExpiryDate})\n`;
                    text += `   ‚îî‚îÄ‚îÄ Precio costo: $${product.cost.toFixed(2)} c/u = $${(product.cost * item.suggestedQty).toFixed(2)}\n`;
                    text += `\n`;
                });
                
                // Totales por d√≠a
                const totalCost = items.reduce((sum, i) => sum + (i.product.cost * i.suggestedQty), 0);
                text += `   TOTAL D√çA (${dayName}): $${totalCost.toFixed(2)}\n\n`;
            });
            
            // Totales generales
            const grandTotal = shoppingList.reduce((sum, i) => sum + (i.product.cost * i.suggestedQty), 0);
            const totalUnits = shoppingList.reduce((sum, i) => sum + i.suggestedQty, 0);
            
            text += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n`;
            text += `üí∞ TOTAL GENERAL\n`;
            text += `   Productos: ${shoppingList.length}\n`;
            text += `   Unidades: ${totalUnits}\n`;
            text += `   Costo total estimado: $${grandTotal.toFixed(2)}\n\n`;
            
            text += `üìã NOTAS:\n`;
            text += `- Comprar seg√∫n el d√≠a indicado para cada proveedor\n`;
            text += `- El vencimiento ideal se calcula seg√∫n la demanda hist√≥rica\n`;
            text += `- Prioridad CR√çTICA: comprar urgente\n`;
            text += `- Prioridad ALTA: comprar esta semana\n`;
            
            downloadFile(text, `lista_compra_${formatDateISO(new Date())}.txt`, 'text/plain');
            showNotification('üìã Lista de compras exportada', 'success');
        }

        // ==================== ALERTS ====================
        function renderAlerts() {
            const alerts = [];
            const today = new Date();
            
            appState.inventory.forEach(p => {
                const stock = getProductStock(p);
                if (stock <= 3) {
                    alerts.push({
                        type: 'stock',
                        priority: stock === 0 ? 'critical' : 'high',
                        product: p,
                        message: stock === 0 ? `SIN STOCK: ${p.name}` : `Stock bajo: ${p.name} (${stock})`
                    });
                }
                
                // Verificar vencimiento del primer lote (FIFO)
                let earliestExpiry = null;
                let earliestDays = null;
                
                if (p.batches && p.batches.length > 0) {
                    const sortedBatches = [...p.batches].sort((a, b) => {
                        if (!a.expiry) return 1;
                        if (!b.expiry) return -1;
                        return new Date(a.expiry) - new Date(b.expiry);
                    });
                    if (sortedBatches[0].expiry) {
                        earliestExpiry = sortedBatches[0].expiry;
                        earliestDays = Math.ceil((new Date(earliestExpiry) - today) / (1000 * 60 * 60 * 24));
                    }
                } else if (p.expiry) {
                    earliestExpiry = p.expiry;
                    earliestDays = Math.ceil((new Date(earliestExpiry) - today) / (1000 * 60 * 60 * 24));
                }
                
                if (earliestDays !== null && earliestDays <= 7 && earliestDays > 0) {
                    alerts.push({
                        type: 'expiry',
                        priority: earliestDays <= 3 ? 'critical' : 'medium',
                        product: p,
                        message: `Vence en ${earliestDays} d√≠as: ${p.name}`
                    });
                }
            });

            appState.alerts = alerts;
            updateAlertBadge();

            const filter = document.querySelector('.alert-filter.active')?.dataset.filter || 'all';
            const filtered = filter === 'all' ? alerts : alerts.filter(a => a.type === filter);

            document.getElementById('alerts-list').innerHTML = filtered.map(alert => `
                <div class="flex items-center gap-4 p-4 rounded-xl border-l-4 ${alert.priority === 'critical' ? 'bg-red-50 border-red-500' : alert.priority === 'high' ? 'bg-orange-50 border-orange-500' : 'bg-yellow-50 border-yellow-500'}">
                    <div class="flex-1">
                        <p class="font-bold ${alert.priority === 'critical' ? 'text-red-700' : 'text-gray-800'}">${alert.message}</p>
                        ${alert.product.supplier ? `<p class="text-sm text-gray-500">Proveedor: ${alert.product.supplier} ${alert.product.supplierPhone ? `üìû ${alert.product.supplierPhone}` : ''}</p>` : ''}
                    </div>
                    <button onclick="openAddStockModal('${alert.product.id}')" class="bg-white px-4 py-2 rounded-lg shadow hover:shadow-md text-sm font-bold ${alert.priority === 'critical' ? 'text-red-600' : 'text-blue-600'}">
                        Reponer
                    </button>
                </div>
            `).join('') || '<p class="text-center text-gray-400 py-8">No hay alertas activas</p>';
        }

        function filterAlerts(type) {
            document.querySelectorAll('.alert-filter').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === type);
                btn.classList.toggle('bg-purple-600', btn.dataset.filter === type);
                btn.classList.toggle('text-white', btn.dataset.filter === type);
                btn.classList.toggle('bg-gray-200', btn.dataset.filter !== type);
                btn.classList.toggle('text-gray-700', btn.dataset.filter !== type);
            });
            renderAlerts();
        }

        function updateAlertBadge() {
            const critical = appState.alerts.filter(a => a.priority === 'critical').length;
            const badge = document.getElementById('alert-badge');
            badge.textContent = critical;
            badge.classList.toggle('hidden', critical === 0);
        }

        // ==================== SETTINGS ====================
        function renderSettings() {
            document.getElementById('settings-margin').value = appState.defaultMargin;
            document.getElementById('settings-cash').value = appState.cash;
            document.getElementById('settings-bank').value = appState.bank;
            
            document.getElementById('settings-product-count').textContent = appState.inventory.length;
            document.getElementById('settings-sales-count').textContent = appState.sales.length;
            document.getElementById('settings-expenses-count').textContent = appState.expenses.length;
        }

        function saveMarginFromSettings() {
            const margin = parseFloat(document.getElementById('settings-margin').value);
            if (margin >= 1 && margin <= 99) {
                appState.defaultMargin = margin;
                saveToLocalStorage();
                showNotification(`Margen actualizado a ${margin}%`, 'success');
            } else {
                showNotification('El margen debe estar entre 1% y 99%', 'error');
            }
        }

        function saveBalancesFromSettings() {
            const cash = parseFloat(document.getElementById('settings-cash').value) || 0;
            const bank = parseFloat(document.getElementById('settings-bank').value) || 0;
            
            appState.cash = cash;
            appState.bank = bank;
            
            saveToLocalStorage();
            renderAll();
            showNotification('Saldos actualizados correctamente', 'success');
        }

        function resetAllData() {
            if (!confirm('‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nSe eliminar√°n TODOS los datos:\n- Todos los productos\n- Todas las ventas\n- Todos los gastos\n- Toda la configuraci√≥n\n\nEsta acci√≥n NO se puede deshacer.\n\n¬øDeseas continuar?')) return;
            
            if (!confirm('üö® CONFIRMACI√ìN FINAL\n\nEscribe "ELIMINAR" para confirmar que quieres borrar todo:\n\n¬øEst√°s 100% seguro?')) return;
            
            // Reiniciar todo el estado
            appState = {
                currentDate: new Date(),
                activeDate: new Date(),
                defaultMargin: 30,
                cash: 0,
                bank: 0,
                inventory: [],
                sales: [],
                expenses: [],
                investments: [],
                cashMovements: [],
                cart: [],
                paymentMethod: 'cash',
                calendarMonth: new Date(),
                alerts: [],
                pendingPurchase: null,
                pendingPurchasePayment: 'cash'
            };
            
            // Limpiar localStorage
            localStorage.removeItem('kioscopro-data');
            localStorage.removeItem('kioscopro-initialized');
            
            saveToLocalStorage();
            
            showNotification('üóëÔ∏è Todos los datos han sido eliminados', 'success');
            
            // Recargar la p√°gina para empezar desde cero
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function exportBackupBeforeReset() {
            backupData();
            showNotification('üíæ Backup descargado. Ahora puedes reiniciar con seguridad.', 'success');
        }

        // ==================== REPORTS ====================
        function exportSalesReport() {
            const startDate = document.getElementById('report-start-date').value;
            const endDate = document.getElementById('report-end-date').value;
            
            let filtered = appState.sales;
            if (startDate) filtered = filtered.filter(s => s.date >= startDate);
            if (endDate) filtered = filtered.filter(s => s.date <= endDate);

            const csv = [
                ['ID', 'Fecha', 'Hora', 'Productos', 'Total', 'Ganancia', 'M√©todo'].join(','),
                ...filtered.map(s => [
                    s.id,
                    s.date,
                    s.time,
                    s.items.map(i => `${i.name}x${i.quantity}`).join(';'),
                    s.total.toFixed(2),
                    s.profit.toFixed(2),
                    s.paymentMethod
                ].join(','))
            ].join('\n');

            downloadFile(csv, `ventas_${startDate}_${endDate}.csv`, 'text/csv');
        }

        function exportInventoryReport() {
            let csv = 'Nombre,C√≥digo,Categor√≠a,Stock Total,Costo,Precio,Proveedor,Lotes\n';
            
            appState.inventory.forEach(p => {
                const totalStock = getProductStock(p);
                let batchesInfo = '';
                if (p.batches && p.batches.length > 0) {
                    batchesInfo = p.batches.map(b => `${b.stock}u(${b.expiry || 'S/V'})`).join('; ');
                } else if (p.stock) {
                    batchesInfo = `${p.stock}u(${p.expiry || 'S/V'})`;
                }
                
                csv += [
                    p.name,
                    p.barcode,
                    p.category,
                    totalStock,
                    p.cost.toFixed(2),
                    p.salePrice.toFixed(2),
                    p.supplier || '',
                    batchesInfo
                ].join(',') + '\n';
            });

            downloadFile(csv, `inventario_${formatDateISO(new Date())}.csv`, 'text/csv');
        }

        function exportFinancialReport() {
            const totalSales = appState.sales.reduce((sum, s) => sum + s.total, 0);
            const totalProfit = appState.sales.reduce((sum, s) => sum + s.profit, 0);
            const totalExpenses = appState.expenses.reduce((sum, e) => sum + e.amount, 0);
            
            const inventoryCost = appState.inventory.reduce((sum, p) => sum + (p.cost * getProductStock(p)), 0);
            const inventorySale = appState.inventory.reduce((sum, p) => sum + (p.salePrice * getProductStock(p)), 0);
            
            const report = `
RESUMEN FINANCIERO KIOSCOPRO
Fecha: ${new Date().toLocaleString('es-ES')}

LIQUIDEZ:
- Efectivo en caja: $${appState.cash.toFixed(2)}
- Dinero en cuenta: $${appState.bank.toFixed(2)}

INVENTARIO:
- Valor al costo: $${inventoryCost.toFixed(2)}
- Valor de venta: $${inventorySale.toFixed(2)}

RESULTADOS:
- Ventas totales: $${totalSales.toFixed(2)}
- Ganancia bruta: $${totalProfit.toFixed(2)}
- Gastos totales: $${totalExpenses.toFixed(2)}
- Ganancia neta: $${(totalProfit - totalExpenses).toFixed(2)}
            `.trim();

            downloadFile(report, `financiero_${formatDateISO(new Date())}.txt`, 'text/plain');
        }

        function exportTaxReport() {
            const monthlySales = {};
            appState.sales.forEach(s => {
                const month = s.date.slice(0, 7);
                if (!monthlySales[month]) monthlySales[month] = { sales: 0, profit: 0 };
                monthlySales[month].sales += s.total;
                monthlySales[month].profit += s.profit;
            });

            let report = 'REPORTE DE IMPUESTOS\n\n';
            Object.entries(monthlySales).sort().forEach(([month, data]) => {
                report += `${month}: Ventas $${data.sales.toFixed(2)} | Ganancia $${data.profit.toFixed(2)}\n`;
            });

            downloadFile(report, `impuestos_${formatDateISO(new Date())}.txt`, 'text/plain');
        }

        function downloadFile(content, filename, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
            showNotification('Reporte descargado', 'success');
        }

        // ==================== UTILITIES ====================
        function renderAll() {
            try {
                renderDashboard();
            } catch(e) { console.error('Error en renderDashboard:', e); }
            
            try {
                renderCart();
            } catch(e) { console.error('Error en renderCart:', e); }
            
            try {
                renderCashflow();
            } catch(e) { console.error('Error en renderCashflow:', e); }
            
            try {
                renderInventory();
            } catch(e) { console.error('Error en renderInventory:', e); }
            
            try {
                updateSidebar();
            } catch(e) { console.error('Error en updateSidebar:', e); }
            
            try {
                updateInventoryValues();
            } catch(e) { console.error('Error en updateInventoryValues:', e); }
        }

        function updateSidebar() {
            try {
                // Asegurar que los valores sean n√∫meros
                const cash = parseFloat(appState.cash) || 0;
                const bank = parseFloat(appState.bank) || 0;
                
                // Calcular ventas de hoy
                let todayTotal = 0;
                if (Array.isArray(appState.sales)) {
                    const today = formatDateISO(appState.activeDate);
                    todayTotal = appState.sales
                        .filter(s => s && s.date === today)
                        .reduce((sum, s) => sum + (parseFloat(s.total) || 0), 0);
                }
                
                // Actualizar elementos del DOM
                const sidebarBalance = document.getElementById('sidebar-balance');
                const liquidityAmount = document.getElementById('liquidity-amount');
                const bankAmount = document.getElementById('bank-amount');
                
                if (sidebarBalance) {
                    sidebarBalance.textContent = `$${todayTotal.toFixed(0)}`;
                } else {
                    console.warn('No se encontr√≥ el elemento sidebar-balance');
                }
                
                if (liquidityAmount) {
                    liquidityAmount.textContent = `$${cash.toFixed(0)}`;
                } else {
                    console.warn('No se encontr√≥ el elemento liquidity-amount');
                }
                
                if (bankAmount) {
                    bankAmount.textContent = `$${bank.toFixed(0)}`;
                } else {
                    console.warn('No se encontr√≥ el elemento bank-amount');
                }
                
                console.log('Sidebar actualizado - Caja:', cash, 'Cuenta:', bank, 'Ventas hoy:', todayTotal);
                
            } catch (e) {
                console.error('Error en updateSidebar:', e);
            }
        }

        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                warning: 'bg-yellow-500',
                info: 'bg-blue-500'
            };
            
            const notif = document.createElement('div');
            notif.className = `notification ${colors[type]} text-white px-6 py-3 rounded-xl shadow-lg flex items-center gap-2`;
            notif.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check' : type === 'error' ? 'fa-exclamation' : 'fa-info-circle'}"></i>
                <span class="font-medium">${message}</span>
            `;
            
            document.getElementById('notifications').appendChild(notif);
            setTimeout(() => {
                notif.style.opacity = '0';
                setTimeout(() => notif.remove(), 300);
            }, 3000);
        }

        // ==================== BACKUP & RESTORE ====================
        function backupData() {
            const data = JSON.stringify(appState, null, 2);
            downloadFile(data, `kioscopro_backup_${formatDateISO(new Date())}.json`, 'application/json');
        }

        function restoreData(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = JSON.parse(e.target.result);
                    appState = { ...appState, ...data };
                    saveToLocalStorage();
        
                    renderAll();
                    showNotification('Datos restaurados correctamente', 'success');
                } catch (err) {
                    showNotification('Error al restaurar datos', 'error');
                }
            };
            reader.readAsText(file);
        }

        // ==================== FIREBASE SYNC ====================
        let firebaseSyncEnabled = false;
        let lastSyncTime = 0;
        let syncListener = null;
        let isInitialSync = true; // Flag para evitar notificaci√≥n en carga inicial
        let isOnline = navigator.onLine;
        
        // Detectar cambios de conexi√≥n del navegador
        window.addEventListener('online', () => {
            isOnline = true;
            updateSyncStatus('synced');
            showNotification('üåê Conexi√≥n restaurada - Sincronizando...', 'success');
            forceSync();
        });
        
        window.addEventListener('offline', () => {
            isOnline = false;
            updateSyncStatus('offline');
            showNotification('üì¥ Sin conexi√≥n - Modo offline activado', 'info');
        });
        
        // Detectar cuando la app vuelve a primer plano (celu bloquea pantalla)
        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible') {
                console.log('üëÄ App volvi√≥ a primer plano - Sincronizando...');
                // Recargar datos de Firebase
                setTimeout(() => {
                    forceSync();
                }, 500);
            }
        });
        
        // Funci√≥n para guardar en Firebase (con debounce)
        let syncTimeout = null;
        function syncToFirebase() {
            if (!window.db) {
                console.log('Firebase no disponible, usando solo localStorage');
                return;
            }
            
            // Debounce: esperar 1 segundo despu√©s del √∫ltimo cambio
            clearTimeout(syncTimeout);
            syncTimeout = setTimeout(async () => {
                try {
                    const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js");
                    
                    // Preparar datos para Firebase (sin cart que es temporal)
                    const dataToSync = {
                        ...appState,
                        cart: [], // No sincronizar carrito temporal
                        currentDate: new Date().toISOString(),
                        activeDate: appState.activeDate.toISOString(),
                        calendarMonth: appState.calendarMonth.toISOString(),
                        lastSync: new Date().toISOString(),
                        deviceId: localStorage.getItem('kioscopro-device-id') || generateDeviceId()
                    };
                    
                    await setDoc(doc(window.db, "kioscos", "main"), dataToSync);
                    lastSyncTime = Date.now();
                    updateSyncStatus('synced');
                    console.log('‚úÖ Sincronizado con Firebase');
                } catch (err) {
                    console.error('Error sincronizando:', err);
                    updateSyncStatus('error');
                }
            }, 1000);
        }
        
        // Escuchar cambios de Firebase (tiempo real)
        async function startFirebaseListener() {
            if (!window.db) return;
            
            try {
                const { doc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js");
                
                syncListener = onSnapshot(doc(window.db, "kioscos", "main"), (docSnapshot) => {
                    if (!isOnline) {
                        updateSyncStatus('offline');
                        return;
                    }
                    
                    if (docSnapshot.exists()) {
                        const data = docSnapshot.data();
                        const deviceId = localStorage.getItem('kioscopro-device-id') || generateDeviceId();
                        
                        // Evitar loop: no actualizar si el cambio vino de este dispositivo hace menos de 2 segundos
                        if (data.deviceId === deviceId && Date.now() - lastSyncTime < 2000) {
                            return;
                        }
                        
                        // Fusionar datos de Firebase con estado local
                        mergeFirebaseData(data);
                        updateSyncStatus('synced');
                        console.log('üì• Datos recibidos de Firebase');
                    }
                }, (err) => {
                    console.error('Error en listener:', err);
                    if (!isOnline || !navigator.onLine) {
                        updateSyncStatus('offline');
                    } else {
                        updateSyncStatus('error');
                    }
                });
                
                firebaseSyncEnabled = true;
                updateSyncStatus(isOnline ? 'synced' : 'offline');
                console.log('üëÇ Escuchando cambios de Firebase...');
            } catch (err) {
                console.error('Error iniciando listener:', err);
                updateSyncStatus('offline');
            }
        }
        
        // Fusionar datos de Firebase con estado local
        function mergeFirebaseData(data) {
            const deviceId = localStorage.getItem('kioscopro-device-id') || generateDeviceId();
            const isSameDevice = data.deviceId === deviceId;
            
            // Actualizar solo si los datos de Firebase son m√°s recientes
            const firebaseTime = new Date(data.lastSync || 0).getTime();
            const localTime = lastSyncTime;
            
            if (firebaseTime > localTime || !localStorage.getItem('kioscopro-data')) {
                // Preservar carrito local (no se sincroniza)
                const localCart = appState.cart;
                
                // ESTRATEGIA: Si Firebase tiene datos m√°s nuevos, REEMPLAZAR (no fusionar)
                // Esto respeta los borrados. La √∫nica excepci√≥n es si hay datos locales 
                // m√°s nuevos que no se han sincronizado.
                
                const replaceIfNewer = (localArr, remoteArr, lastLocalSync) => {
                    if (!Array.isArray(remoteArr)) return localArr;
                    // Si Firebase tiene datos m√°s recientes, usamos los de Firebase
                    // Si no, mantenemos los locales
                    return remoteArr;
                };
                
                appState.inventory = replaceIfNewer(appState.inventory, data.inventory, localTime);
                appState.sales = replaceIfNewer(appState.sales, data.sales, localTime);
                appState.expenses = replaceIfNewer(appState.expenses, data.expenses, localTime);
                appState.investments = replaceIfNewer(appState.investments, data.investments, localTime);
                appState.capitalAdjustments = replaceIfNewer(appState.capitalAdjustments, data.capitalAdjustments, localTime);
                
                // Actualizar valores simples (solo si no hay conflicto)
                if (data.cash !== undefined) appState.cash = parseFloat(data.cash) || 0;
                if (data.bank !== undefined) appState.bank = parseFloat(data.bank) || 0;
                if (data.defaultMargin !== undefined) appState.defaultMargin = parseFloat(data.defaultMargin) || 30;
                if (data.initialCapital !== undefined) appState.initialCapital = parseFloat(data.initialCapital) || 0;
                
                // Restaurar fechas
                try {
                    if (data.activeDate) appState.activeDate = new Date(data.activeDate);
                    if (data.calendarMonth) appState.calendarMonth = new Date(data.calendarMonth);
                } catch(e) {
                    console.error('Error parseando fechas:', e);
                }
                
                // Restaurar carrito local
                appState.cart = localCart;
                
                // Guardar en localStorage y renderizar
                saveToLocalStorage(false); // false = no disparar syncToFirebase
                renderAll();
                
                // Solo mostrar notificaci√≥n si:
                // - NO es la carga inicial
                // - Y NO es el mismo dispositivo (datos de otro dispositivo)
                if (!isInitialSync && !isSameDevice) {
                    showNotification('üì≤ Datos sincronizados desde otro dispositivo', 'success');
                } else if (isInitialSync) {
                    console.log('üì• Datos cargados desde Firebase (inicial)');
                }
            }
            
            // Marcar que ya pas√≥ la carga inicial
            isInitialSync = false;
        }
        
        // ==================== BORRADO PERMANENTE ====================
        // Funci√≥n para borrar TODO y sincronizar el borrado a Firebase
        async function clearAllData() {
            if (!confirm('‚ö†Ô∏è ¬øEst√°s seguro de BORRAR TODOS los datos?\n\nEsto borrar√°:\n- Todo el inventario\n- Todas las ventas\n- Todos los gastos\n- Todo el historial\n\nEsta acci√≥n NO se puede deshacer.')) {
                return;
            }
            
            // Limpiar estado local
            appState.inventory = [];
            appState.sales = [];
            appState.expenses = [];
            appState.investments = [];
            appState.capitalAdjustments = [];
            appState.cash = 0;
            appState.bank = 0;
            appState.initialCapital = 0;
            
            // Limpiar localStorage
            localStorage.removeItem('kioscopro-data');
            
            // Sincronizar borrado a Firebase inmediatamente
            if (window.db && navigator.onLine) {
                try {
                    const { doc, setDoc } = await import("https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js");
                    const emptyData = {
                        inventory: [],
                        sales: [],
                        expenses: [],
                        investments: [],
                        capitalAdjustments: [],
                        cash: 0,
                        bank: 0,
                        defaultMargin: 30,
                        initialCapital: 0,
                        cart: [],
                        currentDate: new Date().toISOString(),
                        activeDate: new Date().toISOString(),
                        calendarMonth: new Date().toISOString(),
                        lastSync: new Date().toISOString(),
                        deviceId: localStorage.getItem('kioscopro-device-id') || generateDeviceId(),
                        clearedAt: new Date().toISOString() // Flag de borrado
                    };
                    await setDoc(doc(window.db, "kioscos", "main"), emptyData);
                    console.log('üóëÔ∏è Datos borrados permanentemente en Firebase');
                } catch (err) {
                    console.error('Error borrando en Firebase:', err);
                }
            }
            
            renderAll();
            showNotification('üóëÔ∏è Todos los datos han sido borrados', 'success');
        }
        
        // Generar ID √∫nico para este dispositivo
        function generateDeviceId() {
            const id = 'device_' + Math.random().toString(36).substr(2, 9) + '_' + Date.now();
            localStorage.setItem('kioscopro-device-id', id);
            return id;
        }
        
        // Actualizar indicador de sincronizaci√≥n
        function updateSyncStatus(status) {
            const indicator = document.getElementById('sync-status-indicator');
            if (!indicator) return;
            
            // Verificar estado real de conexi√≥n
            const actuallyOnline = navigator.onLine && isOnline;
            
            // Si est√° offline forzado o sin conexi√≥n del navegador, mostrar offline
            if (!actuallyOnline && status !== 'syncing') {
                status = 'offline';
            }
            
            const icons = {
                synced: '<i class="fas fa-cloud-check text-white"></i>',
                syncing: '<i class="fas fa-sync fa-spin text-yellow-300"></i>',
                offline: '<i class="fas fa-cloud-slash text-white/50"></i>',
                error: '<i class="fas fa-exclamation-triangle text-yellow-400"></i>'
            };
            
            indicator.innerHTML = icons[status] || icons.offline;
            indicator.title = status === 'synced' ? '‚òÅÔ∏è Sincronizado con la nube' : 
                             status === 'syncing' ? 'üîÑ Sincronizando...' :
                             status === 'offline' ? 'üì¥ Sin conexi√≥n (modo offline)' : '‚ö†Ô∏è Error de sincronizaci√≥n';
        }
        
        // Forzar sincronizaci√≥n manual
        async function forceSync() {
            updateSyncStatus('syncing');
            
            // 1. Enviar datos locales a Firebase
            syncToFirebase();
            
            // 2. Recibir datos de Firebase (forzar recarga)
            try {
                const { doc, getDoc } = await import("https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js");
                const docRef = doc(window.db, "kioscos", "main");
                const docSnap = await getDoc(docRef);
                
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    // Resetear flag para que muestre notificaci√≥n
                    isInitialSync = false;
                    mergeFirebaseData(data);
                    updateSyncStatus('synced');
                    showNotification('üîÑ Datos actualizados', 'success');
                    console.log('üì• Datos recargados manualmente desde Firebase');
                }
            } catch (err) {
                console.error('Error recargando datos:', err);
                updateSyncStatus('error');
                showNotification('Error al sincronizar', 'error');
            }
        }

        // ==================== LOCAL STORAGE ====================
        function saveToLocalStorage(triggerSync = true) {
            localStorage.setItem('kioscopro-data', JSON.stringify(appState));
            
            // Sincronizar con Firebase
            if (triggerSync) {
                syncToFirebase();
            }
        }

        function loadFromLocalStorage() {
            const saved = localStorage.getItem('kioscopro-data');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    
                    // Preservar valores iniciales como respaldo
                    const initialCash = appState.cash;
                    const initialBank = appState.bank;
                    
                    // Fusionar datos guardados con estado inicial
                    appState = { ...appState, ...data };
                    
                    // Asegurar que los valores num√©ricos sean n√∫meros v√°lidos
                    appState.cash = parseFloat(appState.cash);
                    appState.cash = isNaN(appState.cash) ? initialCash : appState.cash;
                    
                    appState.bank = parseFloat(appState.bank);
                    appState.bank = isNaN(appState.bank) ? initialBank : appState.bank;
                    
                    appState.defaultMargin = parseFloat(appState.defaultMargin);
                    appState.defaultMargin = isNaN(appState.defaultMargin) ? 30 : appState.defaultMargin;
                    
                    // Restaurar fechas
                    appState.currentDate = new Date();
                    try {
                        appState.activeDate = new Date(data.activeDate || new Date());
                    } catch(e) {
                        appState.activeDate = new Date();
                    }
                    try {
                        appState.calendarMonth = new Date(data.calendarMonth || new Date());
                    } catch(e) {
                        appState.calendarMonth = new Date();
                    }
                    
                    // Asegurar que los arrays existan
                    appState.inventory = Array.isArray(appState.inventory) ? appState.inventory : [];
                    appState.sales = Array.isArray(appState.sales) ? appState.sales : [];
                    appState.expenses = Array.isArray(appState.expenses) ? appState.expenses : [];
                    appState.investments = Array.isArray(appState.investments) ? appState.investments : [];
                    appState.cart = Array.isArray(appState.cart) ? appState.cart : [];
                    appState.cashMovements = Array.isArray(appState.cashMovements) ? appState.cashMovements : [];
                    
                    console.log('Datos cargados - Caja:', appState.cash, 'Cuenta:', appState.bank);
                    
                } catch (e) {
                    console.error('Error cargando datos:', e);
                    showNotification('Error al cargar datos guardados', 'error');
                }
            }
            
            // Iniciar listener de Firebase despu√©s de cargar datos locales
            setTimeout(() => {
                startFirebaseListener();
            }, 1000);
        }
    </script>
</body>
</html>